# 依存関係と実行順序

## 概要

uBlock Origin形式インポート機能のタスク間の依存関係と推奨される実行順序を定義します。

---

## 依存関係グラフ

```
┌─────────────────────────────────────────────────────────────────────┐
│                          UF-001 [DIRECT]                             │
│                      構成分析と要件定義                              │
│                               (30分)                                 │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          UF-002 [DIRECT]                             │
│                          Storage拡張                                   │
│                               (20分)                                 │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          UF-101 [TDD]                               │
│                    uBlockフィルターパーサー                          │
│                            (2時間)                                  │
│                  ┌────────────────────────────┐                    │
│                  │  新規ファイル作成           │                    │
│                  │  ublockParser.js           │                    │
│                  └────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
            ▼                 ▼                 ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   UF-102 [TDD]  │  │   UF-103 [TDD]  │  │   UF-204 [TDD]  │
│  オプション解析    │  │   domainUtils  │  │   エクスポート     │
│    (1.5時間)     │  │   統合          │  │   (1時間)       │
│                 │  │    (1時間)     │  │                 │
│  [UF-101依存]    │  │ [UF-102依存]   │  │ [UF-101依存]   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
            │                 │
            └────────┬────────┘
                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          UF-201 [TDD]                               │
│                        インポートUI                                   │
│                           (2時間)                                   │
│                  ┌────────────────────────────┐                    │
│                  │  新規ファイル作成           │                    │
│                  │  ublockImport.js           │                    │
│                  └────────────────────────────┘                    │
│                              │                                       │
│                        [UF-103依存]                                  │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          UF-202 [TDD]                               │
│                    ファイルアップロード                               │
│                          (1.5時間)                                  │
│                        [UF-201依存]                                  │
└─────────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   UF-301 [TDD]  │  │   UF-302 [TDD]  │  │   UF-303 [TDD]  │
│  高度オプション    │  │   パフォーマンス  │  │   エラーハンドル   │
│    (1.5時間)     │  │      最適化      │  │     (1時間)     │
│                 │  │    (2時間)     │  │                 │
│  [UF-102依存]    │  │ [UF-204依存]   │  │ [UF-302依存]   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

---

## タスク一覧表

| タスクID | タスク名 | タイプ | 時間 | 依存 | 優先度 | 状態 |
|----------|---------|--------|------|------|--------|------|
| UF-001 | 構成分析と要件定義 | DIRECT | 30分 | なし | P0 | ✅ 完了 |
| UF-002 | Storage拡張 | DIRECT | 20分 | UF-001 | P0 | ✅ 完了 (2026年1月) |
| UF-101 | uBlockフィルターパーサーコア | TDD | 2時間 | UF-002 | P0 | ✅ 完了 (2026年1月) |
| UF-102 | オプション解析実装 | TDD | 1.5時間 | UF-101 | P1 | ✅ 完了 (2026年1月) |
| UF-103 | 既存 domainUtils との統合 | TDD | 1時間 | UF-102 | P0 | ✅ 完了 (2026年1月) |
| UF-201 | インポートUI追加 | TDD | 2時間 | UF-103 | P0 | ✅ 完了 (2026年1月) |
| UF-202 | ファイルアップロード機能 | TDD | 1.5時間 | UF-201 | P0 | ✅ 完了 (2026年1月) |
| UF-203 | URLインポート機能(オプション) | TDD | 1時間 | UF-201 | P3 | ✅ 完了 (2026年1月) |
| UF-204 | エクスポート機能 | TDD | 1時間 | UF-101 | P1 | ✅ 完了 (2026年1月) |
| UF-301 | 選択的オプション対応 | TDD | 1.5時間 | UF-102 | P1 | ✅ 完了 (2026年1月) |
| UF-302 | パフォーマンス最適化 | TDD | 2時間 | UF-204 | P0 | ✅ 完了 (2026年1月) |
| UF-303 | エラーハンドリング | TDD | 1時間 | UF-302 | P0 | ✅ 完了 (2026年1月) |
| **合計** | | | **~17時間** | | | |

---

## クリティカルパス

```
UF-001 → UF-002 → UF-101 → UF-102 → UF-103 → UF-201 → UF-202 → UF-302 → UF-303
(30分)  (20分) (2時間) (1.5時間) (1時間) (2時間) (1.5時間) (2時間) (1時間)
     ✅                                                            未実装
```

**クリティカルパス内のタスク**:
1. UF-001: ✅ 完了
2. UF-002: ✅ 完了 (2026年1月)
3. UF-101: ✅ 完了 (2026年1月)
4. UF-102: ✅ 完了 (2026年1月)
5. UF-103: ✅ 完了 (2026年1月)
6. UF-201: ✅ 完了 (2026年1月)
7. UF-202: ✅ 完了 (2026年1月)
8. UF-302: ✅ 完了 (2026年1月)
9. UF-303: ✅ 完了 (2026年1月)

---

## 並列実行可能なタスク

### 並列セット1: UF-204 と UF-301

```
UF-101 完了時点で開始可能:
  ├─ UF-204 [TDD]: エクスポート機能 (1時間)
  └─ UF-301 [TDD]: 選択的オプション対応 (1.5時間)
```

### 並列実行時の推定合計時間

| モード | 推定時間 |
|-------|---------|
| シーケンシャル | ~17時間 |
| 並列実行 | ~15.5時間 |
| UF-203除く | ~14.5時間 |

---

## マイルストーン

| マイルストーン | 完了タスク | 推定時間 | 状態 |
|--------------|-----------|---------|------|
| M1: 基盤準備完了 | UF-001, UF-002 | 50分 | ✅ 完了 (2026年1月) |
| M2: パーサー完了 | UF-101, UF-102, UF-103 | 4.5時間 | ✅ 完了 (2026年1月) |
| M3: UI基本機能完了 | UF-201, UF-202, UF-204 | 4.5時間 | ✅ 完了 (2026年1月) |
| M4: 全機能完了 | UF-301, UF-302, UF-303 | 4.5時間 | ✅ 完了 (2026年1月) |

---

## ファイル作成・変更スケジュール

### 新規作成ファイル

| タスク | ファイル | 完了予定 |
|-------|---------|---------|
| UF-101 | `src/utils/ublockParser.js` | UF-101完了時 |
| UF-101 | `src/utils/__tests__/ublockParser.test.js` | UF-101完了時 |
| UF-103 | `src/utils/ublockMatcher.js` | UF-103完了時 |
| UF-103 | `src/utils/__tests__/ublockMatcher.test.js` | UF-103完了時 |
| UF-201 | `src/popup/ublockImport.js` | UF-201完了時 |
| UF-201 | `src/popup/__tests__/ublockImport.test.js` | UF-201完了時 |
| UF-204 | `src/popup/ublockExport.js` | UF-204完了時 |

### 変更ファイル

| タスク | ファイル | 変更内容 | 完了予定 |
|-------|---------|---------|---------|
| UF-002 | `src/utils/storage.js` | StorageKeys, DEFAULT_SETTINGS 追加 | UF-002完了時 |
| UF-103 | `src/utils/domainUtils.js` | isUrlBlocked()追加、isDomainAllowed()拡張 | UF-103完了時 |
| UF-201 | `src/popup/popup.html` | インポートUI要素追加 | UF-201完了時 |
| UF-201 | `src/popup/domainFilter.js` | uBlock形式統合 | UF-201完了時 |

---

## タスク間のインターフェース定義

### UF-001 → UF-002

**引き継ぎ内容**:
- StorageKeys に追加するキー: `UBLOCK_RULES`, `UBLOCK_FORMAT_ENABLED`
- DEFAULT_SETTINGS に追加する初期値

### UF-002 → UF-101

**引き継ぎ内容**:
- StorageKeys の定義
- 既存ストレージ構造との整合性

### UF-101 → UF-102

**引き継ぎ内容**:
- `UblockRule` 型定義
- `UblockRules` 型定義
- parseUblockFilterLine(), parseUblockFilterList() 関数

### UF-102 → UF-103

**引き継ぎ内容**:
- `UblockRuleOptions` 型定義
- parseOptions() 関数

### UF-103 → UF-201

**引き継ぎ内容**:
- isUrlBlocked() 関数
- isDomainAllowed() 拡張版

### UF-201 → UF-202

**引き継ぎ内容**:
- previewUblockFilter() 関数
- showStatus(), showErrors() 関数

### UF-204 (独立)

UF-204 は UF-101 の parseUblockFilterList() に依存のみ、他のタスクには依存しないため並列実装可能。

---

## 実装スケジュール（日数ベース）

**前提**: 1日あたり3時間の実装時間

| 日数 | タスク | 合計時間 |
|------|-------|----------|
| Day 1 | UF-002 (20分) + UF-101 (2時間40分) | 3時間 |
| Day 2 | UF-102 (1.5時間) + UF-103 (1時間) + UF-101残り | 3時間 |
| Day 3 | UF-201 (2時間) + UF-202 (1時間) | 3時間 |
| Day 4 | UF-204 (1時間) + UF-301 (2時間) | 3時間 |
| Day 5 | UF-302 (2時間) + UF-303 (1時間) | 3時間 |
| Day 6 | テスト・修正 | 3時間 |
| Day 7 | 全体統合テスト | 3時間 |
| **合計** | | **7日** |

---

## ブロッキング要因

| 要因 | 影響タスク | 回避策 |
|------|-----------|--------|
| uBlock構文の解釈違い | UF-101, UF-102 | 公式文書を明確に |
| 既存domainUtilsとの非互換 | UF-103 | 既存コードの動作を維持 |
| パフォーマンス要件未達 | UF-302 | インデックス化で対応 |
| Chrome Extension API制約 | UF-201, UF-202 | 公式ドキュメント参照 |

---

## リスクと対応

| リスク | 影響度 | 対応策 |
|--------|--------|-------|
| EasyListとの互換性不完全 | 中 | 対象をドメインブロックに限定 |
| 大量ルール時のパフォーマンス | 中 | UF-302で対応 |
| ワイルドカードの複雑さ | 低 | 既存の matchesPattern を再利用 |
| 既存機能への影響 | 高 | 既存テストを維持 |