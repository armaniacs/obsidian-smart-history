# TODO: Obsidian Smart History 改善候補

---

## uBlock Origin形式 インポート機能 実装TODO

### 概要

- **全タスク数**: 12
- **推定作業時間**: 約4時間
- **クリティカルパス**: UF-001 → UF-101 → UF-201 → UF-301
- **依存**: 既存 `domainUtils.js`、`domainFilter.js`、`storage.js`

### uBlock Origin構文（ドメインブロック関連）

| 構文 | 説明 | 例 |
|------|------|-----|
| `||hostname^` | ドメインと全サブドメインをブロック | `||example.com^` |
| `@@` | 例外ルール（ブロックを無効化） | `@@||trusted.com^` |
| `*` | ワイルドカード | `||*.doubleclick.net^` |
| `!` | コメント | `! Comment line` |
| `domain=` | 特定ドメインに制限 | `||tracker.com$domain=example.com` |
| `3p`/`1p` | サード/ファーストパーティのみ | `||ad.com$3p` |

### 実装タスク

#### フェーズ1: 基盤構築

- [x] **UF-001 [DIRECT]**: 構成分析と要件定義 ✅ **完了**
  - [x] uBlock Origin 静的フィルター構文の詳細分析
  - [x] サポート範囲の策定（ドメインブロックに限定、オプションの一部対応など）
  - [x] 既存 `domainUtils.js` との整合性確認
  - [x] データ構造設計（ブロックルールと例外ルールの分離）

- [x] **UF-002 [DIRECT]**: Storage拡張 ✅ **完了**
  - [x] `StorageKeys` に uBlock形式用キー追加（`UBLOCK_RULES`）
  - [x] 既存ドメインリスト形式との互換性保持

#### フェーズ2: フィルターパーサー実装

- [x] **UF-101 [TDD]**: uBlockフィルターパーサーコア実装 ✅ **完了** (TDD開発完了 - 29テストケース全通過、要件網羅率100%)
  - [x] Requirementsフェーズ完了 - 高品質判定
  - [x] Testcasesフェーズ完了 - 高品質判定 (18テストケース: 正常系7/異常系5/エッジ4/性能2)
  - [x] Redフェーズ（失敗テスト作成）✓ - 29テスト期待通り失敗
  - [x] Greenフェーズ（最小実装）✓ **完了** - 29/29テスト通過
  - [x] Refactorフェーズ（品質改善）✓ **完了** - 定数化・関数分割・JSDoc充実
    - 【セキュリティレビュー】: 重大な脆弱性なし
    - 【パフォーマンスレビュー】: 要件達成（1,000行<1秒、10,000行<5秒）
  - [x] Verifyフェーズ（完全性検証）✓ **完了** - 要件網羅率100%、品質判定: 合格
  - [x] `src/utils/__tests__/ublockParser.test.js` 作成完了 (29テストケース)
  - [x] `src/utils/ublockParser.js` 実装完了 (約380行、500行未満目標達成)

- [x] **UF-102 [TDD]**: オプション解析実装 ✅ **完了** (TDD開発完了 - 11テストケース全通過、要件網羅率100%)
  - [x] Requirementsフェーズ完了 - 高品質判定
  - [x] Testcasesフェーズ完了 - 高品質判定 (11テストケース: 正常系6/異常系2/エッジ3)
  - [x] Redフェーズ（失敗テスト作成）✓ **完了**
  - [x] Greenフェーズ（最小実装）✓ **完了** - 39/39テスト通過
  - [x] Refactorフェーズ（品質改善）✓ **完了**
    - 【改善内容】OPTION_TYPES定数追加（8種類）
    - 【改善内容】parseDomainListヘルパー関数追加
    - 【セキュリティレビュー】: 重大な脆弱性なし 🟢
    - 【パフォーマンスレビュー】: 要件達成（O(n)線形）🟢
  - [x] Verifyフェーズ（完全性検証）✓ **完了**
    - 【要件網羅率】: 100%（12/12項目）
    - 【テスト成功率】: 100%（11/11テスト）
    - 【品質判定】: 合格

- [ ] **UF-103 [TDD]**: 既存 domainUtils.jsとの統合 (Requirementsフェーズ完了 - 高品質判定)
  - [x] Requirementsフェーズ完了 - 高品質判定
  - [ ] `isUrlBlocked(url, ublockRules)` 関数実装（新規ublockMatcher.js）
  - [ ] `isDomainAllowed()` 関数拡張（既存domainUtils.js）

#### フェーズ3: UI実装

- [ ] **UF-201 [TDD]**: インポートUI追加
  - [ ] 「フィルター形式」選択セレクト追加（simple/ublock）
  - [ ] テキストエリア貼り付け機能
  - [ ] インプレビュー機能（ルール数、例外数、エラー表示）

- [ ] **UF-202 [TDD]**: ファイルアップロード機能
  - [ ] `.txt` ファイル選択と読み込み
  - [ ] ドラッグ&ドロップ対応

- [ ] **UF-203 [TDD]**: URL/サブスクリプションインポート機能（オプション）
  - [ ] 外部URLからのフィルター読み込み

- [ ] **UF-204 [TDD]**: エクスポート機能
  - [ ] `.txt` ファイルダウンロード
  - [ ] クリップボードコピー

#### フェーズ4: 統合・最適化

- [ ] **UF-301 [TDD]**: 選択的なオプション対応実装
- [ ] **UF-302 [TDD]**: パフォーマンス最適化（10,000+件対応）
- [ ] **UF-303 [TDD]**: エラーハンドリングとユーザーフィードバック

#### フェーズ5: 機能拡張

- [x] **UF-501 [DIRECT]**: uBlock + Simple Simultaneous Use ✅ **完了** (実装済み - テスト計画作成完了)
  - [x] 既存実装の確認（popup.html, domainFilter.js, ublockImport.js, domainUtils.js）
  - [x] チェックボックスによるフィルター形式の切り替え機能（Simple/uBlock併用可能）
  - [x] 同時使用ロジックの実装（ANDロジックによるフィルタリング）
  - [x] テスト計画の作成
    - [x] `docs/implements/UF-501/ublock-simple-simultaneous-testplan.md` 作成完了
    - [x] `docs/implements/UF-501/manual-verification-checklist.md` 作成完了
  - [x] テスト実装
    - [x] `src/utils/__tests__/domainUtils.test.js` に13テストケース追加 (LOG-006 to LOG-018)
    - [x] `src/popup/__tests__/domainFilter.test.js` 作成 (10テストケース - スキップ中)
    - [x] `src/popup/__tests__/ublockImport.test.js` 作成 (7テストケース - スキップ中)
  - [x] テスト実行結果: 133 passed, 23 skipped
  - [ ] 手動検証の実行 (MAN-001 to MAN-013)
  - [ ] スキップ中のUIテストの有効化（モジュール解決問題の解決後）
  - [ ] スキップ中のロジックテストの有効化（モック問題の解決後）
  - **備考**: 機能自体は既に実装済み。テスト計画と一部テスト実装完了。

---

## PBI-001完了後の改善候補 実装TODO (UF-400シリーズ)

### 概要

- **全タスク数**: 1（UF-402のみが未実装）
- **推定作業時間**: 約1時間
- **クリティカルパス**: UF-402
- **備考**: キーボードショートカット機能（UF-405, UF-406, UF-407）は実装されていません（ドキュメントのみ存在、ソースコードなし）
- **依存**: 既存 `popup.html`、`main.js`、`navigation.js`、`sanitizePreview.js`

### 既存実装状況

| ファイル | 状況 | 備考 |
|---------|------|------|
| `src/popup/popup.html` | インラインCSS約130行 | `popup.css` 未作成 |
| `src/popup/sanitizePreview.js` | 実装済み | PII確認UI |
| `src/popup/main.js` | 実装済み | 手動記録ロジック |
| `src/popup/navigation.js` | 実装済み | `showMainScreen()`/`showSettingsScreen()` |
| `src/background/service-worker.js` | 実装済み | 記録処理ロジック |

### TODO

#### フェーズ1: マスク情報改善

- [x] **UF-401 [TDD]**: マスク情報の可視化機能 ✅ **完了** (TDD開発完了 - 13テストケース全通過、要件網羅率92%)
  - [x] 要件定義フェーズ完了 - 高品質判定
  - [x] テストケース洗い出し - 高品質判定 (12テストケース: 正常系6/異常系3/境界値3)
  - [x] Redフェーズ（失敗テスト作成）✓ - 13/13テスト期待通り失敗
  - [x] Greenフェーズ（最小実装）✓ **完了** - 13/13テスト通過
  - [x] Refactorフェーズ（品質改善）✓ **完了** - 定数化・JSDoc・関数分割実装完了
    - 【改善成果】
      - 6種類の定数定義 (DOM_IDS, CSS_SELECTORS, CLASS_NAMES, DISPLAY_VALUES, MESSAGES, PATTERNS)
      - 2つの関数分割 (applyHighlights, setPreviewContent)
      - 3つのヘルパー関数 (getModal, getPreviewContent, getMaskStatusMessage)
      - 全関数のJSDoc充実化
    - 【品質評価】 セキュリティ: 重大な問題なし / パフォーマンス: 重大な課題なし
  - [x] Verifyフェーズ（完全性検証）✓ **完了** - 品質判定: 合格
    - 【検証結果】 テスト成功率: 100% (13/13) / 要件網羅率: 92% (12/13)
    - 【詳細】 docs/implements/UF-401/masked-info-visualization-memo.md 参照
  - [x] マスク箇所のカウント表示実装
    - [x] `maskedCount` をプレビューモーダルに表示
    - [x] ステータスメッセージに「X件の個人情報をマスクしました」を追加
  - [x] マスク箇所のハイライト実装
    - [x] `.masked-highlight` クラスの強化（title属性によるツールチップ表示）
  - [x] マスク理由の表示実装
    - [x] 各マスク箇所のタイプ（email, phone, creditCard等）を表示
    - [x] ツールチップでの表示実装

#### フェーズ2: UI/UX改善

- [ ] **UF-402 [DIRECT]**: CSS外部ファイル化
  - [ ] `src/popup/popup.css` 新規作成
    - [ ] `popup.html` の `<style>` ブロック（約130行）を移動
    - [ ] セレクタの整理とファイル構造化
  - [ ] `popup.html` 修正
    - [ ] `<style>` ブロック削除
    - [ ] `<link rel="stylesheet" href="popup.css">` 追加
  - [ ] manifest.json へのCSS追加（必要な場合）
  - [ ] スタイルの動作確認
  - [ ] トレリシビリティ確認（既存スタイルとの互換性）

- [x] **UF-403 [TDD]**: ローディングスピナー追加
  - [x] SVGスピナー実装
    - [x] スピナーコンポーネント作成（Circle、Dots、または Spinner）
    - [x] CSSアニメーション定義（@keyframes）
  - [x] `main.js` 修正
    - [x] recordCurrentPage() にスピナー表示ロジック追加
    - [x] 処理中はスピナーを表示、完了/エラー時に非表示
  - [x] `popup.html` 修正
    - [x] スピナー用コンテナ追加（`<div id="loadingSpinner">`）
    - [x] 記録ボタンとステータスエリア内での配置
  - [x] テストケース作成
    - [x] スピナーの表示開始
    - [x] スピナーの非表示
    - [x] エラー時のスピナー挙動

- [x] **UF-404 [TDD]**: 記録成功後のポップアップ自動クローズ (完了)
  - [x] `main.js` 修正
    - [x] 記録成功後にクローズロジック追加
    - [x] `setTimeout(() => window.close(), 2000);` 実装
    - [x] 設定画面にいる場合はクローズしない判定
  - [x] `navigation.js` 修正
    - [x] 画面状態の追跡（メイン画面か設定画面か）
    - [x] `isOnSettingsScreen` 状態変数の追加 (screenState.jsに分離)
  - [x] ユーザー体験改善
    - [x] カウントダウン秒数の表示（3...2...1...）
    - [x] 「自動閉じる」アラートの表示
  - [x] テストケース作成
    - [x] メイン画面で成功時の自動クローズ
    - [x] 設定画面で成功時のクローズしない
    - [x] エラー時のクローズしない
    - [x] 連続記録時のタイマー管理
    - [x] 画面遷移時のタイマーキャンセル（統合テスト）
  - [x] **TDDフェーズ完了**:
    - Requirements ✓
    - Testcases ✓
    - Red ✓
    - Green ✓ (9/9テスト通過)
    - Refactor ✓ (循環参照解消、screenState.js分離実装完了)
    - **品質判定**: 高品質 (9/9テスト通過、重大な脆弱性・性能課題なし)

#### フェーズ3: 操作性改善

- [ ] **UF-405 [TDD]**: キーボードショートカット対応 （ドキュメントのみ存在、実装コードなし）
  - 実装予定だった機能: Ctrl+S / Cmd+S によるクイック記録
  - 備考: docs/implements/UF-405/ にTDDドキュメントが存在するが、実際のソースコードは実装されていない
  - 決定: 実装しない

#### フェーズ4: 将来的な機能拡張候補（実装しない）

#### フェーズ3: 実装しない機能 （将来的な機能拡張候補）

以下の機能は
- 2026-01-24時点の決定: 実装しない
- 理由: 現在のプロジェクトスコープ外

- [ ] **UF-502 [TDD]**: 記録前のプレビュー機能 (実装しない)
  - [ ] `main.js` 修正
    - [ ] 記録前にAI要約を事前生成するオプション追加
    - [ ] プレビュー表示フラグ設定
  - [ ] `sanitizePreview.js` 拡張
    - [ ] オリジナル内容と要約結果の比較表示
  - [ ] テストケース作成

- [ ] **UF-503 [TDD]**: バッチ記録機能 (実装しない)
  - [ ] 新規UIスポップアップ（batch.html）作成
    - [ ] タブ一覧表示（許可リスト対象タブのみ）
    - [ ] チェックボックスによる複数選択
  - [ ] `src/popup/batch.js` 新規作成
    - [ ] 選択タブの一括取得
    - [ ] 並列記録処理
  - [ ] テストケース作成

- [ ] **UF-504 [SKIP]**: 記録フィルター設定（既に実装済み）
  - [ ] ドメインホワイトリスト/ブラックリスト機能は既に実装済み
  - [ ] `src/popup/domainFilter.js` 確認済み
  - [ ] `src/utils/domainUtils.js` 確認済み
### 実行順序

1. ~~**マスク情報改善** (UF-401) - 理由：プライバシー機能の強化~~ ✅ 完了
2. ~~**UI/UX改善** (UF-402, UF-403, UF-404) - 理由：使用体験の向上~~
   - ~~CSS外部ファイル化は拡張時に実施~~
   - ~~ローディングスピナー~~ ✅ 完了
   - ~~ポップアップ自動クローズ~~ ✅ 完了
3. **操作性改善** (UF-405) - キーボードショートカット機能 → 実装しないことに決定（ドキュメントのみでコード未実装）
4. **将来的な機能拡張** (UF-501, UF-502, UF-503) - 理由：追加機能 → 実装しないことに決定

### 実装プロセス

[TDD]タスクは以下の順序で実装:

1. UF-{taskID}/tdd-requirements.md - 詳細要件定義
2. UF-{taskID}/tdd-testcases.md - テストケース作成
3. UF-{taskID}/tdd-red.md - テスト実装（失敗）
4. UF-{taskID}/tdd-green.md - 最小実装
5. UF-{taskID}/tdd-refactor.md - リファクタリング
6. UF-{taskID}/tdd-verify-complete.md - 品質確認

[DIRECT]タスクは以下の順序で実行:

1. UF-{taskID}/direct-setup.md - 設定作業の実行
2. UF-{taskID}/direct-verify.md - 設定確認

### 既存実装との連携

- **`src/popup/navigation.js`**: `showMainScreen()` / `showSettingsScreen()` - 画面状態追跡に利用
- **`src/popup/main.js`**: 手動記録ロジック - 拡張ポイント
- **`src/popup/sanitizePreview.js`**: PII確認UI - マスク情報表示の拡張
- **`src/background/service-worker.js`**: 記録処理ロジック - メッセージハンドラ追加

---

## PBI-001: 手動記録機能 - 実装完了後の改善候補（元テキスト）

### マスクされた情報を簡単に確認する

- [x] マスクされた情報簡単に確認できるようにする ✅ **完了 (UF-401)**
  - 現状: 特に工夫なし
  - ~~改善: マスク箇所が何箇所あるかを出す、赤い文字にする~~ ✅ 実装済み
  - ~~改善: なぜマスク対象になったのかを表示する~~ ✅ 実装済み



### UI/UX改善

- [ ] **CSS外部ファイル化** (未実装 - UF-402)
  - 現状: インラインCSS約130行
  - 改善: `src/popup/popup.css` として分離
  - メリット: 保守性向上、スタイル再利用
  - タイミング: インラインCSSが150行を超えた場合

- [x] **ローディングスピナー追加** ✅ **完了 (UF-403)**
  - 現状: テキストのみの「記録中...」表示
  - ~~改善: スピナーアニメーションを追加~~ ✅ 実装済み
  - ~~実装: CSSアニメーション or SVGスピナー~~ ✅ 実装済み
  - ~~配置: 記録ボタンの隣、またはステータスメッセージエリア~~ ✅ 実装済み

- [x] **記録成功後のポップアップ自動クローズ** ✅ **完了 (UF-404)**
  - 現状: ポップアップは手動で閉じる必要がある
  - ~~改善: 記録成功後2秒でポップアップを自動クローズ~~ ✅ 実装済み
  - ~~実装: `setTimeout(() => window.close(), 2000);`~~ ✅ 実装済み
  - ~~注意: ユーザーが設定画面に遷移中の場合は閉じない~~ ✅ 実装済み

### 操作性改善（キーボードショートカット機能 - 実装しない）

- [ ] **キーボードショートカット対応** （ドキュメントのみ存在、実装コードなし）
  - 予定だった機能: Ctrl+S / Cmd+S によるクイック記録
  - 備考: docs/implements/UF-405/ にTDDドキュメントが存在するが、実際のソースコードは実装されていない
  - 決定: 実装しない


### 将来的な機能拡張候補（2026-01-24時点で実装しないことに決定）
  - 参考: `manifest.json` の `commands` セクション ✅ 設定済み
### 将来的な機能拡張候補（2026-01-24時点で実装しないことに決定）

- [ ] **閲覧履歴一覧表示** (実装しない)
  - メイン画面に最近保存した5件を表示
  - クリックでObsidianのノートを開く

- [ ] **記録前のプレビュー** (実装しない)
  - AI要約を事前生成して確認
  - 編集してから保存する機能

- [ ] **バッチ記録機能** (実装しない)
  - 複数のタブを一括記録
  - タブリストで選択して記録

- [x] **記録フィルター設定** ✅ 既に実装済み
  - 特定ドメインを自動記録から除外
  - ホワイトリスト/ブラックリスト機能 (Domain Filterとして実装完了)


---

# 次のステップ 2026-01-24 更新

## 🚀 これからやること

### 直近の優先タスク (UF-400シリーズ: PBI-001完了後の改善候補)

- [ ] **UF-402 [DIRECT]**: CSS外部ファイル化 (未実装)
  - `popup.html` の `<style>` ブロック（約130行）を `popup.css` に移動
  - セレクタの整理とファイル構造化
  - スタイルの動作確認・トレリシビリティ確認
  - 推定: 約1時間

### ✅ 完了済みタスク

1. ✅ **UF-403 [TDD]**: ローディングスピナー追加 (完了)
   - ユーザー体験向上のための視覚的フィードバック
   - 実装: SVGスピナー + CSSアニメーション

2. ✅ **UF-404 [TDD]**: 記録成功後のポップアップ自動クローズ (完了)
   - 記録ボタンを押した後、手動で閉じる手間を省く
   - メイン画面でのみクローズ、設定画面では閉じない
   - **リファクタ完了**: 循環参照解消（screenState.js分離）
   - **品質**: 高品質 (9/9テスト通過、重大な脆弱性・性能課題なし)

     - エラーハンドリング: null/undefined/非配列のスキップ処理
     - 後方互換性: 単一引数呼び出し対応
   - **テスト結果**: Test Suites: 1 passed, Tests: 13 passed, 13 total (100%成功率)
   - **品質判定**: 合格 (要件網羅率 92%)

### 中期タスク (UF-300シリーズ: uBlock Origin形式インポート)

- [ ] **UF-001 [DIRECT]**: uBlock構成分析と要件定義
  - https://github.com/gorhill/ublock/wiki/static-filter-syntax の詳細分析
  - サポート範囲策定（ドメインブロックに限定）
  - 推定: 30分

- [ ] **UF-101 [TDD]**: uBlockフィルターパーサーコア実装
  - src/utils/ublockParser.js 新規作成
  - 推定: 2時間

### TDDタスクの実装手順

1. /UF-{taskID}/tdd-requirements.md - 詳細要件定義
2. /UF-{taskID}/tdd-testcases.md - テストケース作成
3. /UF-{taskID}/tdd-red.md - テスト実装（失敗）
4. /UF-{taskID}/tdd-green.md - 最小実装
5. /UF-{taskID}/tdd-refactor.md - リファクタリング
6. /UF-{taskID}/tdd-verify-complete.md - 品質確認

### 既存実装のステータス
✅ 完了済み:
- PBI-001: 手動記録機能
- PII Sanitizing機能（4つのプライバシーモード）
- OpenAI Migration（3つのAIプロバイダー対応）
- Domain Filter（ホワイトリスト/ブラックリスト）
- ユーティリティのリグレッションテスト（31テスト/31合格）
