/**
 * Jest„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´
 * Chrome Extensions API„ÅÆ„É¢„ÉÉ„ÇØË®≠ÂÆö
 * jsdomÁí∞Â¢É„ÇíÂà©Áî®„Åó„Åü„ÉÜ„Çπ„ÉàË®≠ÂÆö
 */

// jest„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©
global.jest = global.jest || {};

// vi„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©
global.vi = global.jest;

// document„ÅØjsdom„ÅåÊèê‰æõ„Åô„Çã„Åü„ÇÅ‰∏äÊõ∏„Åç„Åó„Å™„ÅÑ
// jsdom„Å´„Çà„ÇäÂü∫Êú¨ÁöÑ„Å™DOMÊìç‰ΩúÔºàgetElementById, createElement, querySelectorÁ≠âÔºâ„ÅåÂà©Áî®ÂèØËÉΩ

// „ÄêÊîπÂñÑ„ÄëÔºöglobal.document„ÅÆ‰∏äÊõ∏„Åç„ÇíÂâäÈô§„Åójsdom„ÅÆÊ©üËÉΩ„ÇíÊ¥ªÁî®
// üü¢ ‰ø°È†ºÊÄß„É¨„Éô„É´: jest.config.cjs„ÅßtestEnvironment: 'jsdom'„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ
// jsdom„Å´„Çà„ÇãÂÆåÂÖ®„Å™DOMÁí∞Â¢É„ÅåÊèê‰æõ„Åï„Çå„Çã„ÄÇÊâãÂãï„É¢„ÉÉ„ÇØ„ÇíÂâäÈô§„Åô„Çã„Åì„Å®„Åß„ÄÅ
// DOM„ÅÆÊìç‰ΩúÔºàappendChild, remove, classListÁ≠âÔºâ„ÅåÊ≠£„Åó„ÅèÂãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´„Å™„Çã„ÄÇ

// Chrome Extensions API„ÅÆ„É¢„ÉÉ„ÇØÔºàjsdom„ÅåÊèê‰æõ„Åó„Å™„ÅÑ„ÇÇ„ÅÆ„ÅÆ„ÅøÔºâ
global.chrome = {
  storage: {
    local: {
      get: jest.fn((keys, callback) => {
        if (callback) callback({});
        return Promise.resolve({});
      }),
      set: jest.fn((items, callback) => {
        if (callback) callback();
        return Promise.resolve();
      })
    },
    sync: {
      get: jest.fn((keys, callback) => {
        if (callback) callback({});
        return Promise.resolve({});
      }),
      set: jest.fn((items, callback) => {
        if (callback) callback();
        return Promise.resolve();
      })
    }
  },
  runtime: {
    lastError: null,
    sendMessage: jest.fn(),
    onMessage: {
      addListener: jest.fn()
    }
  },
  tabs: {
    query: jest.fn(),
    sendMessage: jest.fn(),
    onUpdated: {
      addListener: jest.fn()
    }
  },
  i18n: {
    getMessage: jest.fn((key, substitutions) => {
      // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„Éá„Éï„Ç©„É´„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøî„Åô
      const messages = {
        'loading': 'Loading...',
        'processing': 'Processing...',
        'appTitle': 'Smart History',
        'recordNow': 'üìù Record Now',
        'cannotRecordPage': 'Cannot record this page',
        'noTitle': 'No title',
        'save': 'Save',
        'cancel': 'Cancel',
        'connectionError': 'Please refresh the page and try again',
        'domainBlockedError': 'This domain is not allowed to be recorded. Do you want to record it anyway?',
        'success': '‚úì Saved to Obsidian',
        'cancelled': 'Cancelled',
        'unknownError': 'Unknown error occurred',
        'errorPrefix': '‚úó Error:',
        'fetchingContent': 'Fetching content...',
        'localAiProcessing': 'Local AI processing...',
        'saving': 'Saving...',
        'recording': 'Recording...',
        'forceRecord': 'Force Record',
        'errorColon': 'Error:',
        'manualInput': 'Manual Input',
        'rulesLabel': 'Rules',
        'reload': 'Reload',
        'delete': 'Delete',
        'fileLoaded': 'Loaded "{filename}"',
        'fileReadError': 'File read error',
        'exportError': 'Export error',
        'copyError': 'Copy error',
        'deleteError': 'Delete error',
        'reloadError': 'Reload error',
        'textFileOnly': 'Only text files are supported',
        'noTextToCopy': 'No text to copy',
        'copiedToClipboard': 'Copied to clipboard',
        'nothingToExport': 'Nothing to export',
        'fileExported': 'File exported',
        'loadEmptyUrl': 'Please enter a URL',
        'loadingUrl': 'Loading...',
        'importFromUrl': 'Import from URL',
        'loadedFromUrl': 'Loaded filters from "{url}"',
        'sourceUpdated': 'Source updated ({ruleCount} rules)',
        'clipboardCopyFailed': 'Failed to copy to clipboard',
        'generatedBy': '! Generated by Obsidian Smart History',
        'previousMaskedItem': 'Previous masked item',
        'nextMaskedItem': 'Next masked item',
        'maskStatusCount': 'Masked {count} items of personal information',
        'maskStatusDetails': 'Masked {details}',
        'itemsCount': '{count} items',
        'items': ', ',
        'modeRequired': 'Please select a mode',
        'saveError': 'Save error',
        'privacySaved': 'Privacy settings saved',
        'testingConnection': 'Testing connection...',
        'successConnected': 'Success! Connected to Obsidian. Settings Saved.',
        'connectionFailed': 'Connection Failed: {message}',
        'acceptCertificate': 'Click here to accept self-signed certificate',
        'errorProtocol': 'Error: Protocol must be "http" or "https".',
        'errorPort': 'Error: Port must be a number between 1 and 65535.',
        'errorDuration': 'Error: Minimum visit duration must be a non-negative number.',
        'errorScrollDepth': 'Error: Minimum scroll depth must be a number between 0 and 100.',
        'domainListError': 'Domain list errors:',
        'noActiveTab': 'No active tab found',
        'filterModeRequired': 'Please select a filter mode',
        'domainFilterSaved': 'Domain filter settings saved',
        'cannotRecordHttpHttps': 'Current page is not an HTTP/HTTPS page',
        'failedToExtractDomain': 'Failed to extract domain',
        'domainAdded': 'Added domain "{domain}"',
        'domainAlreadyExists': 'Domain "{domain}" already exists in the list',
        'domainList': 'Domain List (1 domain per line)',
        'closeModalBtn': '√ó',
        'cancelPreviewBtn': 'Cancel',
        'sendBtn': 'Send',
        'confirmContent': 'Review Content',
        'confirmContentDesc': 'You can review and edit the content to be saved to Obsidian.<br><span class="text-danger">Note: Check masked items.</span>',
        'mainTab': 'General',
        'domainTab': 'Domain Filter',
        'privacyTab': 'Privacy',
        'back': '‚Üê',
        'apiKey': 'Obsidian API Key',
        'apiKeyPlaceholder': 'Paste your key here...',
        'protocol': 'Protocol (http/https)',
        'port': 'Port',
        'dailyNotePath': 'Daily Note Path',
        'dailyNotePathPlaceholder': 'e.g. 092.Daily',
        'aiProvider': 'AI Provider',
        'googleGemini': 'Google Gemini',
        'openaiCompatible': 'OpenAI Compatible (Groq, etc.)',
        'openaiCompatible2': 'OpenAI Compatible 2 (Local, etc.)',
        'geminiApiKey': 'Gemini API Key',
        'geminiApiKeyPlaceholder': 'Paste your Gemini key here...',
        'modelName': 'Model Name (e.g. gemini-1.5-flash)',
        'baseUrl': 'Base URL',
        'openaiBaseUrlPlaceholder': 'https://api.openai.com/v1',
        'openaiApiKeyPlaceholder': 'sk-...',
        'openaiModelPlaceholder': 'gpt-3.5-turbo',
        'openai2BaseUrlPlaceholder': 'http://127.0.0.1:11434/v1',
        'openai2ApiKeyPlaceholder': 'Optional for some local LLMs',
        'openai2ModelPlaceholder': 'llama3',
        'minVisitDuration': 'Min Visit Duration (seconds)',
        'minScrollDepth': 'Min Scroll Depth (%)',
        'saveAndTest': 'Save & Test Connection',
        'domainFilterMode': 'Domain Filter Mode',
        'filterDisabled': 'Disabled (record all)',
        'filterWhitelist': 'Whitelist (record only specified domains)',
        'filterBlacklist': 'Blacklist (exclude specified domains)',
        'filterFormat': 'Filter Format (can be combined)',
        'simpleFormat': 'Simple (1 domain per line)',
        'ublockFormat': 'uBlock Origin Format',
        'domainListPlaceholder': 'example.com\n*.example.org\ncompany.net',
        'wildcardHelp': 'Wildcards are supported (e.g. *.example.com)',
        'addCurrentDomain': 'Add Current Page Domain',
        'saveDomainSettings': 'Save',
        'ublockFilter': 'uBlock Filter',
        'ublockFilterPlaceholder': '||example.com^\n@@||trusted.com^\n0.0.0.0 ads.example.com\n! Comment line',
        'ublockHelp': 'Paste uBlock Origin or hosts format filters\nuBlock: ||hostname^, @@||hostname^, *, !Comments\nhosts: 0.0.0.0/127.0.0.1 hostname (#comments supported)',
        'loadFromFile': 'Load from file (.txt)',
        'selectFile': 'Select File',
        'dropFileHere': 'Drop file here',
        'loadFromUrl': 'Load from URL',
        'urlPlaceholder': 'https://example.com/filters.txt',
        'registeredFilterSources': 'Registered Filter Sources',
        'noSourcesRegistered': 'No sources registered',
        'loadPreview': 'Load Preview',
        'ruleCount': 'Rules: {count}',
        'exceptionCount': 'Exceptions: {count}',
        'errorCount': 'Errors: {count}',
        'export': 'Export',
        'copyToClipboard': 'Copy to Clipboard',
        'privacyMode': 'Privacy Mode',
        'modeA': 'Mode A: Local Only',
        'modeADesc': 'Summarize page content using only local AI, without sending data externally.\nCurrently not supported on most browsers.',
        'modeADetail': '(Under development)',
        'modeB': 'Mode B: Full Pipeline',
        'modeBDesc': 'Local AI summary ‚Üí PII masking ‚Üí Cloud AI refinement.\nCurrently not supported on most browsers.',
        'modeBCurrently': '(Under development)',
        'modeC': 'Mode C: Masked Cloud',
        'modeCDesc': 'Send only masked data to cloud AI.\nFor environments where local AI is not available.',
        'modeCRecommended': '(Recommended)',
        'modeD': 'Mode D: Cloud Only',
        'modeDDesc': 'Send raw text directly to cloud AI.\nPrioritize speed.',
        'confirmSettings': 'Confirmation Settings',
        'confirmBeforeSending': 'Confirm masking result before sending',
        'savePrivacySettings': 'Save',
        'settings': 'Settings',
        'piiCreditCard': 'Credit Card Number',
        'piiMyNumber': 'My Number',
        'piiBankAccount': 'Bank Account Number',
        'piiEmail': 'E-mail',
        'piiPhoneJp': 'Phone Number',
      };

      let message = messages[key] || key;

      // ÁΩÆÊèõÂá¶ÁêÜ
      if (substitutions && typeof substitutions === 'object') {
        Object.keys(substitutions).forEach((placeholder) => {
          const value = substitutions[placeholder];
          message = message.replace(`{${placeholder}}`, value);
        });
      }

      return message;
    }),
    getUILanguage: jest.fn(() => 'en'),
  }
};

// „ÄêÁ∞°Áï•Âåñ„ÄëÔºögetElementById„ÅÆË§áÈõë„Å™„É¢„ÉÉ„ÇØ„ÇíÂâäÈô§
// üü° ÈªÑ‰ø°Âè∑: „Åì„Çå„ÅØÊó¢Â≠ò„ÉÜ„Çπ„Éà„Å®„ÅÆ‰∫íÊèõÊÄß„Çí‰øù„Å§„Åü„ÇÅ„ÅÆÊö´ÂÆöÂØæÁ≠ñ
// Â∞ÜÊù•ÁöÑ„Å´„ÅØÂêÑ„ÉÜ„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅßbeforeEach„ÅßÂøÖË¶Å„Å™Ë¶ÅÁ¥†„Çí‰ΩúÊàê„Åô„ÇãÊñπÂºè„Å∏ÁßªË°åÊé®Â•®
//
// „ÄêÁßªË°åË®àÁîª„Äë:
// 1. uBlockÈñ¢ÈÄ£„ÅÆË¶ÅÁ¥†„É¢„ÉÉ„ÇØ„ÅØ„ÄÅublockImport.test.jsÁ≠â„ÅßbeforeEach„ÅßÂãïÁöÑ„Å´‰ΩúÊàê
// 2. domainFilterÈñ¢ÈÄ£„ÅÆË¶ÅÁ¥†„É¢„ÉÉ„ÇØ„ÅØ„ÄÅdomainFilter.test.js„ÅßbeforeEach„ÅßÂãïÁöÑ„Å´‰ΩúÊàê
// 3. ÂÖ±ÈÄöË¶ÅÁ¥†Ôºàmodal, spinner„Å™„Å©Ôºâ„ÅØ„ÄÅÂÖ±ÈÄöbeforeEach„Éï„ÉÉ„ÇØ„Çí‰ΩúÊàê

// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆ„É™„Çª„ÉÉ„ÉàÔºàÂêÑ„ÉÜ„Çπ„ÉàÂâç„Å´ÂÆüË°åÔºâ
beforeEach(() => {
  jest.clearAllMocks();
  // Chrome API„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
  global.chrome.runtime.lastError = null;
});

// „ÉÜ„Çπ„ÉàÁµÇ‰∫ÜÂæå„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
afterEach(() => {
  // DOM„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàjsdom„ÅÆdomNodes„Éó„É≠„Éë„ÉÜ„Ç£„Çí„ÇØ„É™„Ç¢Ôºâ
  document.body.innerHTML = '';
});