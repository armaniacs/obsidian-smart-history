# ADR-002: Default Port Migration to 27124 for HTTPS Support

## Status

**Accepted** (2026-02-22)

## Context（背景・経緯）

### 初期実装

Obsidian Smart History は、Obsidian Local REST API と通信するためにデフォルトポート `27123` を使用していました。これは Obsidian が提供する HTTP（非暗号化）通信の標準ポートです。

### 変更が必要になった理由

HTTPS（暗号化）通信のサポートは、セキュリティ強化の観点から重要な機能追加です。特に以下の理由で HTTPS 化が求められています：

1. **セキュリティ強化**: API キーやプライベートページの内容が暗号化されて保護される
2. **中間者攻撃の防止**: ローカルネットワーク内での攻撃リスクを軽減
3. **プライバシー保護**: PII（個人を特定できる情報）のマスキング処理と組み合わせた二重の保護

### Obsidian のポート割り当て

Obsidian Local REST API は、HTTP と HTTPS で異なるポートを使用します：

| プロトコル | ポート番号 |
|-----------|-----------|
| HTTP | 27123 |
| HTTPS | 27124 |

### 既存ユーザーへの影響

デフォルトポートを `27123` から `27124` に変更することは、既存ユーザーに対して以下の影響を及ぼします：

1. **ポート設定済みのユーザー**: 影響なし（拡張機能は既存の設定を維持）
2. **デフォルト設定を使用しているユーザー**: 接続エラーが発生する

## Decision（決定事項）

**デフォルトポートを `27124` に変更し、HTTPS を優先する**

### 理由

1. **セキュリティ優先**: HTTPS 暗号化による保護は、既存設定を維持することよりも重要
2. **将来への投資**: 既存ユーザーは一度だけ設定変更が必要だが、新規ユーザーは最初から安全な通信方式を使用できる
3. **専門家間のコンセンサス**: セキュリティ専門家は非暗号化通信よりも暗号化通信を推奨

### 変更内容

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| デフォルトプロトコル | `http` | `https` |
| デフォルトポート | `27123` | `27124` |

### 互換性の維持

既存ユーザーがスムーズに移行できるように、以下の対応を行います：

1. **明確なリリースノート**: 破壊的変更を明記
2. **移行ガイド**: ユーザー向けの手順書の提供
3. **エラーメッセージの改善**: 接続失敗時に具体的な対処法を表示

## Rationale（根拠・理由）

### なぜ変更が必要なのか

1. **デフォルトで安全**: セキュリティ機能はデフォルトで有効であるべき
2. **HTTPS の普及**: ローカル通信でも HTTPS は業界標準になりつつある
3. **インシデント予防**: デフォルト設定のままで運用されるリスクを回避

### なぜマイグレーション機能を追加しないのか

自動マイグレーションを検討しましたが、以下の理由で採用しませんでした：

1. **意図的なBreaking Change**: これを意図的に通知し、ユーザーに HTTPS の重要性を認識してもらう
2. **設定の複雑化**: 自動切り替えロジックがコードに残り、今後のメンテナンス負荷が増える
3. **非常手段を誤用防止**: 「なんとなく繋がらない」という状況を明確にすることで、問題への気づきを促進

## Consequences（影響）

### Positive（良い影響）

1. **セキュリティの大幅な向上**: デフォルトで暗号化通信を使用
2. **新規ユーザー体験の改善**: 初期設定不要で安全な通信が可能
3. **プライバシー保護の強化**: PII マスキングと組み合わせた二重保護

### Negative（考慮すべき点）

1. **既存ユーザーへの配慮が必要**: 一度だけ設定変更を要求
2. **ドキュメンテーションコスト**: 移行ガイドの作成とメンテナンス
3. **サポート対応**: 移行に関する問い合わせへの対応

## Implementation（実装）

### 修正ファイル

#### `src/utils/storage.ts`

```typescript
const DEFAULT_SETTINGS: Settings = {
    [StorageKeys.OBSIDIAN_API_KEY]: '',
    [StorageKeys.OBSIDIAN_PROTOCOL]: 'https',  // Changed from 'http'
    [StorageKeys.OBSIDIAN_PORT]: '27124',      // Changed from '27123'
    // ... other settings
};
```

#### `src/utils/storage.ts:994-1002`

```typescript
export function buildAllowedUrls(settings: Settings): Set<string> {
    const allowedUrls = new Set<string>();

    // Obsidian API
    const protocol = settings[StorageKeys.OBSIDIAN_PROTOCOL] || 'https';  // Changed default
    const port = settings[StorageKeys.OBSIDIAN_PORT] || '27124';        // Changed default
    // ...
}
```

### 接続エラー時のメッセージ（改善案）

ユーザーが接続エラーに遭遇した場合、以下のガイダンスを表示します：

```
Obsidianに接続できません

設定を確認してください：

1. Obsidianで「設定 > コア拡張機能 > Local REST API」が有効になっているか確認
2. この拡張機能の設定で、以下を確認してください：
   - プロトコル: HTTPS
   - ポート: 27124

以前はポート27123（HTTP）を使用していました。バージョン3.9.8からは
ポート27124（HTTPS）がデフォルトです。

まだ設定を変更していない場合は、拡張機能設定画面で
「プロトコル: HTTPS」「ポート: 27124」に変更してください。
```

## References（参照）

### プロジェクト内ドキュメント

- [docs/PORT_MIGRATION.md](../PORT_MIGRATION.md) - ユーザー向け移行ガイド
- [docs/plans/2026-02-22-review1930.md](../plans/2026-02-22-review1930.md) - レビュードキュメント

### Obsidian 公式ドキュメント

- [Local REST API Plugin](https://help.obsidian.md/Extending+Obsidian/Obsidian+URI)

## まとめ

デフォルトポートを `27123`（HTTP）から `27124`（HTTPS）に変更することで、セキュリティを大幅に強化します。既存ユーザーには一度だけ設定変更を求めますが、これは将来のセキュリティ標準への投資であり、長期的にはすべてのユーザーにとってメリットがあります。