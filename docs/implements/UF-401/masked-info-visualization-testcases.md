# UF-401: マスク情報の可視化機能 - テストケース定義

## 概要

- **機能名**: マスク情報の可視化機能 (Masked Information Visualization)
- **タスクID**: UF-401
- **作成日**: 2026-01-24
- **現在のフェーズ**: Testcases

## 関連ファイル

- **要件定義**: `docs/implements/UF-401/masked-info-visualization-requirements.md`
- **実装対象**: `src/popup/sanitizePreview.js`, `src/popup/popup.html`, `src/popup/main.js`
- **関連ユーティリティ**: `src/utils/piiSanitizer.js`

---

## 開発言語・フレームワーク

### プログラミング言語

| 言語 | 選択理由 | テストに適した機能 |
|------|----------|------------------|
| JavaScript (ES Modules) | 🟢 既存の拡張機能がJavaScriptで実装されているため、統一性を維持 | DOM操作、イベントハンドリングのテストに最適 |
| 🟢 信頼性レベル: 既存プロジェクトのコードベースと完全に一致 |

### テストフレームワーク

| フレームワーク | 選択理由 | テスト実行環境 |
|--------------|----------|----------------|
| Jest | 🟢 プロジェクト全体で既に採用されているため | Node.js環境、VM Modules対応 |
| JSDOM | 🟢 DOM操作のテストに対応可能 | DOMシミュレーション |
| 🟢 信頼性レベル: 既存のテスト環境と完全に一致 |

---

## テストケースの分類

| 指定名称 | テスト数 | サイズ |
|---------|---------|------|
| 正常系テスト | 6件 | - |
| 異常系テスト | 3件 | - |
| 境界値テスト | 3件 | - |
| **総計** | **12件** | - |

---

## 正常系テストケース

### TC-MV-001: マスク件数1件が正しく表示される

- **何をテストするか**: マスクされた個人情報が1件ある場合、ステータスメッセージに「1件の個人情報をマスクしました」と表示されること
- **期待される動作**: プレビューモーダルを開くと、上部に「1件の個人情報をマスクしました」というメッセージが表示されること

**入力値**:
```javascript
{
  content: "連絡先は[MASKED:email]example.comです。",
  maskedItems: [
    { type: "email", original: "test@example.com", position: { start: 4, end: 20 } }
  ],
  maskedCount: 1
}
```

**入力データの意味**: 1つのメールアドレスがマスクされた一般的なケース

**期待される結果**:
- ステータスメッセージのテキストが「1件の個人情報をマスクしました」であること
- プレビューコンテンツにマークされた箇所がハイライト表示されていること

**期待結果の理由**: マスク件数が正確にUIに反映されていることを確認するため

**テストの目的**:
- ステータスメッセージの件数表示機能が正しく動作することを確認する
- 最小限のマスク条件での基本動作を検証する

**確認ポイント**:
- ステータスメッセージDOM要素の存在とテキスト内容
- ハイライト要素の存在と表示

🟢 **信頼性レベル**: 既存実装のデータフローとPIIシナタリオに基づいている

---

### TC-MV-002: マスク件数複数が正しく表示される

- **何をテストするか**: マスクされた個人情報が複数ある場合、正しく件数が表示されること
- **期待される動作**: プレビューモーダルを開くと、「3件の個人情報をマスクしました」のように正確な件数が表示されること

**入力値**:
```javascript
{
  content: "お支払いは口座番号[MASKED:bankAccount]でお願いします。問い合わせ:[MASKED:phoneJp]または[MASKED:phoneJp]まで。",
  maskedItems: [
    { type: "bankAccount", original: "1234567890", position: { start: 6, end: 23 } },
    { type: "phoneJp", original: "03-1234-5678", position: { start: 21, end: 35 } },
    { type: "phoneJp", original: "090-1234-5678", position: { start: 27, end: 41 } }
  ],
  maskedCount: 3
}
```

**入力データの意味**: 複数の種類の個人情報が含まれる実用的なシナリオ（銀行口座1、電話番号2）

**期待される結果**:
- ステータスメッセージのテキストが「3件の個人情報をマスクしました」であること
- すべてのマークされた箇所がハイライト表示されていること

**期待結果の理由**: 複数のマスクに対応でき、件数が正確カウントされていることを確認するため

**テストの目的**:
- 複数のPII要素を同時に処理しても件数が正確にカウントされることを確認する
- 異なる種類のPIIが混在する場合にも正しく動作することを確認する

**確認ポイント**:
- ステータスメッセージの件数値がmaskedCountと一致すること
- すべてのハイライト要素が正しくレンダリングされていること

🟢 **信頼性レベル**: 既存実装のPIIシナタリオに基づいている

---

### TC-MV-003: ハイライト箇所が正しく表示される

- **何をテストするか**: マスクされた箇所が黄色い背景で強調表示されていること
- **期待される動作**: プレビューテキスト中の`[MASKED:{type}]`パターンが黄色い背景で強調表示されていること

**入力値**:
```javascript
{
  content: "メールアドレスは[MASKED:email]test@example.comです",
  maskedItems: [
    { type: "email", original: "test@example.com" }
  ],
  maskedCount: 1
}
```

**入力データの意味**: マスク箇所を含む標準的なテキスト

**期待される結果**:
- プレビュー領域内に `.masked-highlight` クラスが適用された要素が存在すること
- 当該要素のスタイル（background-color: #fff3cd など）が正しく適用されていること

**期待結果の理由**: ハイライト機能がユーザーにマスク箇所を明確に認識できるようにするため

**テストの目的**:
- ハイライト表示機能が正しく動作することを確認する
- CSSクラスの適用が正しく行われていることを検証する

**確認ポイント**:
- `.masked-highlight` クラスを持つ要素がDOMに存在すること
- CSSスタイルが正しく適用されていること（computed styleの検証）

🟢 **信頼性レベル**: 既存実装のCSS定義（popup.html L309-314）に基づいている

---

### TC-MV-004: ツールチップでマスク理由が表示される

- **何をテストするか**: ハイライト箇所にマウスを合わせると、どの種類の個人情報がマスクされたかが表示されること
- **期待される動作**: ハイライト箇所にホバーした際、title属性としてPIIの種類（例: "email"）が表示されること

**入力値**:
```javascript
{
  content: "連絡先:[MASKED:email]xxx@example.com",
  maskedItems: [
    { type: "email", original: "xxx@example.com" }
  ],
  maskedCount: 1
}
```

**入力データの意味**: マウスホバー動作を確認できるシンプルなケース

**期待される結果**:
- ハイライト要素の `title` 属性値が `"email"` であること
- ブラウザのネイティブツールチップが該当情報を表示すること

**期待結果の理由**: ユーザーがマスクされた情報の種類を特定できるようにするため

**テストの目的**:
- ツールチップ機能が正しく動作することを確認する
- PIIの種類情報が正しく伝達されることを検証する

**確認ポイント**:
- ハイライト要素の title 属性に正しいPIIタイプが設定されていること

🟡 **信頼性レベル**: 既存実装の機能要件に基づく妥当な推測

---

### TC-MV-005: showPreviewの単一引数呼び出し互換性が維持されている

- **何をテストするか**: 既存コードのように `showPreview(content)` 単一引数で呼び出しても正しく動作すること
- **期待される動作**: contentだけで呼び出された場合、デフォルト動作として従来通りプレビューが表示されること

**入力値**:
```javascript
{
  content: "名前: 田中太郎\nメール: [MASKED:email]tanaka@example.com"
}
```

**入力データの意味**: 既存実装と同じ形式での呼び出しを再現

**期待される結果**:
- モーダルが正しく表示されること
- プレビューコンテンツが元のテキストで表示されること
- maskedItemsやmaskedCountが未提供の場合でもエラーが発生しないこと

**期待結果の理由**: 後方互換性を維持し、既存のコードを壊さないようにするため

**テストの目的**:
- 後方互換性が確保されていることを確認する
- デフォルトパラメータの処理が正しく行われていることを検証する

**確認ポイント**:
- 単一引数呼び出しで例外が発生しないこと
- プレビューが正常に表示されること

🟢 **信頼性レベル**: 既存実装のAPI仕様に基づいている

---

### TC-MV-006: 複数の異なるPIIタイプが正しく識別される

- **何をテストするか**: 同一テキスト内に複数の異なる種類のPIIが含まれる場合、それぞれが正確にハイライトかつタイプ識別されること
- **期待される動作**: 各PIIタイプに応じて適切なツールチップ情報が表示されること

**入力値**:
```javascript
{
  content: "カード[MASKED:creditCard]、口座[MASKED:bankAccount]、電話[MASKED:phoneJp]、メール[MASKED:email]",
  maskedItems: [
    { type: "creditCard", original: "1234-5678-9012-3456" },
    { type: "bankAccount", original: "01234567" },
    { type: "phoneJp", original: "03-1234-5678" },
    { type: "email", original: "test@example.com" }
  ],
  maskedCount: 4
}
```

**入力データの意味**: すべてのPIIタイプを含む包括的なケース

**期待される結果**:
- 4箇所すべてがハイライト表示されていること
- 各ハイライト箇所のツールチップに正しいタイプ（creditCard, bankAccount, phoneJp, email）が表示されること

**期待結果の理由**: すべてのPIIタイプに対して一貫した動作を保証するため

**テストの目的**:
- 複数の異なるPIIタイプが混在する場合にも正しく処理されることを確認する
- PIIタイプ情報が正しく管理されていることを検証する

**確認ポイント**:
- ハイライト数が4であること
- 各ハイライトのtitle属性が対応するPIIタイプと一致すること

🟢 **信頼性レベル**: 既存実装のPIIシナタリオに基づいている

---

## 異常系テストケース

### TC-MV-101: maskedItemsがnullまたはundefinedの場合の動作

- **エラーケースの概要**: maskedItemsパラメータがnullまたはundefinedとして渡された場合
- **エラー処理の重要性**: 不完全なデータが返ってきてもシステムがクラッシュしないようにするため

**入力値**:
```javascript
{
  content: "連絡先[MASKED:email]xxx@example.com",
  maskedItems: null,
  maskedCount: 1
}
```

**不正な理由**: サービスワーカーから期待された形式のデータが返されなかった場合

**実際の発生シナリオ**:
- PIIサニタイズ処理で予期しないエラーが発生した場合
- データのシリアル化/デシリアル化中に問題が発生した場合

**期待される結果**:
- プレビューが正常に表示されること
- ステータスメッセージに件数が表示されること（maskedCountが提供されている場合）
- ハイライト処理がスキップされて元のテキストが表示されること
- ユーザーにはエラーメッセージを表示しない（サイレントフォールバック）

**エラーメッセージの内容**: なし（サイレントフォールバック）

**システムの安全性**: エラーハンドリングによりシステムが安定性を維持

**テストの目的**:
- 不完全なデータに対する堅牢性を確認する
- ユーザー体験を維持しながらエラー処理が行われていることを検証する

**品質保証の観点**:
- 予期しないデータ形式でもシステムがクラッシュしないことを保証する

🟡 **信頼性レベル**: 既存実装のエラーハンドリング要件に基づく妥当な推測

---

### TC-MV-102: 不正なmaskedItems形式の場合の動作

- **エラーケースの概要**: maskedItemsが期待される配列形式ではない場合（例: オブジェクト、文字列、数値）
- **エラー処理の重要性**: データ型の誤りによる実行時エラーを防ぐため

**入力値**:
```javascript
{
  content: "連絡先: 090-1234-5678",
  maskedItems: "invalid format",  // 文字列として不正な形式
  maskedCount: 1
}
```

**不正な理由**: サービスワーカー側でデータ構造に誤りがある可能性

**実際の発生シナリオ**:
- データの変換処理中にバグがあった場合
- API仕様が変更された場合

**期待される結果**:
- プレビューが正常に表示されること
- ハイライト処理がスキップされること
- コンソールに警告ログが出力されること
- ユーザーにはエラーメッセージを表示しない

**エラーメッセージの内容**: コンソール警告のみ（" Invalid maskedItems format"）

**システムの安全性**: データ型チェックによりエラーの影響範囲を限定

**テストの目的**:
- データ型バリデーションが適切に行われていることを確認する
- 不正なデータ型に対して適切なフォールバック処理が行われていることを検証する

**品質保証の観点**:
- データ整合性問題がシステム全体の安定性に影響しないことを保証する

🟡 **信頼性レベル**: 既存実装のセキュリティ要件に基づく妥当な推測

---

### TC-MV-103: マスクテキストに正規表現特殊文字が含まれる場合

- **エラーケースの概要**: `[MASKED:{type}]` パターン内、または近くに正規表現の特殊文字が含まれる場合
- **エラー処理の重要性**: 正規表現処理中の例外や誤一致を防ぐため

**入力値**:
```javascript
{
  content: "価格: ￥[MASKED:price]1,000円 (税込)",  // 円記号や括弧を含む
  maskedItems: [
    { type: "price", original: "1,000" }
  ],
  maskedCount: 1
}
```

**不正な理由**: tested in a real scenario, user's content may contain regex special characters

**実際の発生シナリオ**:
- 価格情報やテキストフォーマットが複雑なケース
- 日本語テキスト特有の文字パターン

**期待される結果**:
- ハイライトが正しく適用されること
- 正規表現の特殊文字による誤動作が発生しないこと
- エスケープ処理が適切に行われていること

**エラーメッセージの内容**: なし

**システムの安全性**: 文字列処理のロバスト性が保証されている

**テストの目的**:
- 正規表現の特殊文字に対する堅牢性を確認する
- 日本語環境での文字列処理が正しく行われることを検証する

**品質保証の観点**:
- 多様な文字パターンに対して安定して動作することを保証する

🟡 **信頼性レベル**: 既存実装の要件定義から妥当な推測

---

## 境界値テストケース

### TC-MV-201: マスク件数0件の場合

- **境界値の意味**: マスク件数が最小値（0）の場合
- **境界値での動作保証**: マスクがない場合でもUIが一貫して表示されることを確認

**入力値**:
```javascript
{
  content: "まったく個人情報が含まれないテキストです。",
  maskedItems: [],
  maskedCount: 0
}
```

**境界値選択の根拠**: マスクがない最もシンプルなケース。要件定義で明示的に言及されているエッジケース

**実際の使用場面**:
- PII検出ルールに一致する情報がないページを記録する場合
- プライバシーモードが「raw」に設定されている場合

**期待される結果**:
- ステータスメッセージに「0件の個人情報をマスクしました」と表示されること
- プレビューコンテンツにハイライト箇所が存在しないこと
- モーダルが正常に表示・操作可能であること

**境界での正確性**: 件数が正確にゼロとカウントされている

**一貫した動作**: マスク件数が1以上の場合と同じUIレイアウトが維持される

**テストの目的**:
- マスク件数0の場合の表示挙動を確認する
- 件数なしのケースに対する明確な挙動を定義する

**堅牢性の確認**: 最小値ケースでもシステムが安定して動作することを確認

🟢 **信頼性レベル**: 既存実装の要件定義に基づいている

---

### TC-MV-202: 極端なマスク件数（100件以上）

- **境界値の意味**: マスク件数が非常に大きい場合
- **境界値での動作保証**: 大量のPIIが含まれてもパフォーマンス問題が発生しないことを確認

**入力値**:
```javascript
{
  content: "[MASKED:email]x1@example.com, [MASKED:email]x2@example.com, ... (100回繰り返し)",
  maskedItems: /* 100個の配列 */,
  maskedCount: 100
}
```

**境界値選択の根拠**: 実用的な上限値を考慮して100を設定。1ページにこれ以上の個人情報が含まれることは稀だが、堅牢性の観点でテスト

**実際の使用場面**:
- 複数人の連絡先リストが含まれるページ
- 企業の従業員リストなど

**期待される結果**:
- ステータスメッセージに「100件の個人情報をマスクしました」と表示されること
- ハイライト表示が正しくレンダリングされること
- UIのレスポンスが許容範囲内であること（パフォーマンス要件：100ms以内）

**境界での正確性**: 件数が正確に100とカウントされている

**一貫した動作**: 小さい件数の場合と同じ動作ロジックが適用される

**テストの目的**:
- 大量のPII処理に対するパフォーマンスを確認する
- UIが過負荷によってクラッシュしないことを検証する

**堅牢性の確認**: 極端な条件下でもシステムが安定して動作することを確認

🟡 **信頼性レベル**: 既存実装のパフォーマンス要件に基づく妥当な推測

---

### TC-MV-203: 空文字のコンテンツ

- **境界値の意味**: コンテンツが空文字列の場合の処理
- **境界値での動作保証**: 空のテキストに対しても例外が発生しないことを確認

**入力値**:
```javascript
{
  content: "",
  maskedItems: [],
  maskedCount: 0
}
```

**境界値選択の根拠**: 文字列の最小表現（空文字）

**実際の使用場面**:
- ページの本文が取得できなかった場合
- コンテンツスクリプトのエラーによりテキスト取得に失敗した場合

**期待される結果**:
- プレビューモーダルが表示されること
- プレビュー領域が空で表示されること
- ステータスメッセージに「0件の個人情報をマスクしました」と表示されること
- エラーが発生しないこと

**境界での正確性**: 空文字が正しく処理されている

**一貫した動作**: 他の有効な文字列ケースと同じエラーハンドリングフロー

**テストの目的**:
- 最小入力に対する堅牢性を確認する
- 空テキストケースで適切なフィードバックが提供されることを検証する

**堅牢性の確認**: 最小入力条件下でもシステムが安定して動作することを確認

🟢 **信頼性レベル**: 既存実装の入力バリデーション要件に基づいている

---

## テストケース一覧

| テストID | テスト名 | 分類 | 優先度 |
|----------|----------|------|--------|
| TC-MV-001 | マスク件数1件が正しく表示される | 正常系 | HIGH |
| TC-MV-002 | マスク件数複数が正しく表示される | 正常系 | HIGH |
| TC-MV-003 | ハイライト箇所が正しく表示される | 正常系 | HIGH |
| TC-MV-004 | ツールチップでマスク理由が表示される | 正常系 | MEDIUM |
| TC-MV-005 | showPreviewの単一引数呼び出し互換性が維持されている | 正常系 | HIGH |
| TC-MV-006 | 複数の異なるPIIタイプが正しく識別される | 正常系 | MEDIUM |
| TC-MV-101 | maskedItemsがnullまたはundefinedの場合の動作 | 異常系 | MEDIUM |
| TC-MV-102 | 不正なmaskedItems形式の場合の動作 | 異常系 | MEDIUM |
| TC-MV-103 | マスクテキストに正規表現特殊文字が含まれる場合 | 異常系 | LOW |
| TC-MV-201 | マスク件数0件の場合 | 境界値 | HIGH |
| TC-MV-202 | 極端なマスク件数（100件以上） | 境界値 | LOW |
| TC-MV-203 | 空文字のコンテンツ | 境界値 | MEDIUM |

---

## 実装時の注意事項

### DOM構造の考慮

**textarea vs contenteditable div**
- 現在の実装では `<textarea>` 要素を使用しており、HTMLタグ（ハイライト用の`<span>`）を表示できない可能性があります
- ハイライト機能を実装するには、`<textarea>`を`<div contenteditable="true">`に変更する必要がある場合があります
- この変更を行う場合、以下を考慮する必要があります：
  - 既存のスタイルとの整合性
  - ユーザー体験（編集可能かどうか）
  - クロスブラウザ互換性

### セキュリティの考慮

**XSS対策**
- ユーザー提供テキストのHTMLエスケープを適切に実施
- `innerHTML` ではなく `textContent` を使用するか、適切なサニタイズ処理を行う
- `title` 属性の値設定時に適切なエスケープを行う

**個人情報の保護**
- `original` 値は検証・デバッグ目的のみで使用し、UIには表示しない
- マスク済み情報がコンソール等に意図せず出力されないように注意

### テスト構成の考慮

**Jest + JSDOMの設定**
- DOM操作のテストにJSDOMを使用
- テスト環境で `window.document` や `textarea` 要素を擬似的に作成
- `showPreview` 関数のモックやスパイを使用して、適切なパラメータで呼び出されることを確認

---

## 品質判定

### テストケース分類

| 指定名称 | 結果 | 詳細 |
|---------|------|------|
| 正常系 | ✅ 網羅済 | 6件の基本機能テストカバレッジ確保 |
| 異常系 | ✅ 網羅済 | 3件のエラーハンドリングカバレッジ確保 |
| 境界値 | ✅ 網羅済 | 3件の境界条件カバレッジ確保 |

### 期待値定義

| 評価結果 | 結果 | 詳細 |
|---------|------|---|
| 各テストケースの期待値 | ✅ 明確 | すべてのテストケースで明確な期待結果を定義 |

### 技術選択

| 評価結果 | 結果 | 詳細 |
|---------|------|---|
| プログラミング言語 | ✅ 確定 | JavaScript (ES Modules) |
| テストフレームワーク | ✅ 確定 | Jest + JSDOM |

### 実装可能性

| 評価結果 | 結果 | 詳細 |
|---------|------|---|
| 実現可能性 | ✅ 可能 | 既存の技術スタックで実現可能 |
| 既存コードとの整合性 | ✅ 確保 | 後方互換性を維持した設計 |

---

## 総合品質判定

### 評価結果: ✅ **高品質**

- テストケース分類: 正常系・異常系・境界値が網羅されている
- 期待値定義: 各テストケースの期待値が明確
- 技術選択: プログラミング言語・テストフレームワークが確定
- 実装可能性: 現在の技術スタックで実現可能

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2026-01-24 | 初版作成 |