# UF-401: マスク情報の可視化機能 - 要件定義

## 概要

- **機能名**: マスク情報の可視化機能 (Masked Information Visualization)
- **タスクID**: UF-401
- **開発開始日**: 2026-01-24
- **現在のフェーズ**: Requirements

## 関連ファイル

- **実装対象**: `src/popup/sanitizePreview.js`, `src/popup/popup.html`, `src/popup/main.js`
- **関連ユーティリティ**: `src/utils/piiSanitizer.js`
- **計画文書**: `plan/TODO.md`

---

## 1. 機能の概要

### 何をする機能か (ユーザストーリー)

🟡 **妥当な推測**: 既存実装とTODO.mdに基づく

ユーザーがプレビュー画面でマスクされた内容を確認する際、**マスクされた個人情報の件数がどれくらいあるかを一目で把握でき**、**どの箇所がどの種類の個人情報としてマスクされたかを視覚的に理解できる**機能を提供します。

- 画面上部に「X件の個人情報をマスクしました」というステータスメッセージを表示
- マスクされた箇所を目立つハイライトで表示（現在は黄色背景のみ）
- ハイライト箇所にマウスを合わせると、どの種類の個人情報がマスクされたかを表示（ツールチップ）
- ログ等で使用する必要がある場合に備えて、テキスト形式でもタイプ情報を保持

### どのような問題を解決するか (As a / So that)

🟡 **妥当な推測**: プライバシー機能の発見性と理解性の改善を目的とする

**問題**: 現在の実装では、マスクされた個人情報がある場合、ユーザーはマスク箇所を数えることなく、どのような種類の個人情報がマスクされたかを把握できません。

**解決**:
- マスク件数を明示的に表示することで、ユーザーは即座に何件マスクされたかを把握できます
- マスク理由の表示により、ユーザーはどの種類の個人情報が検出されたかを理解できます
- ハイライト強化により、マスク箇所がより目立ちます

### 想定されるユーザー (As a)

🟢 **既存実装に基づく**

- プライバシー保護に関心のあるユーザー
- PII（個人識別情報）がどのように扱われているかを確認したいユーザー
- データの精度を確認したいユーザー

### システム内での位置づけ (アーキテクチャ設計)

🟢 **既存実装に基づく**

```
┌─────────────────────────────────────────────────────────────┐
│                        Popup UI                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │         Preview Modal (sanitizePreview.js)           │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Status Bar: "X件の個人情報をマスクしました"      │  │  │ ← 追加
│  │  ├─────────────────────────────────────────────────┤  │  │
│  │  │  Preview Content (textarea with highlighting)    │  │  │
│  │  │  [MASKED:email]xxxxx@xxxx.com  ← ハイライト強化 │  │  │
│  │  │  [MASKED:phone]xxx-xxxx-xxxx  ← ツールチップ追加 │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
         ↕ 服务 消息通信 (chrome.runtime.sendMessage)
┌─────────────────────────────────────────────────────────────┐
│            Service Worker (service-worker.js)               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │         processUrlRecording()                        │  │
│  │         - Privacy Pipeline                           │  │
│  │         - L2: PII Masking (piiSanitizer.js)         │  │
│  │           ├─ sanitizeRegex()                         │  │
│  │           └─ returns: { text, maskedItems[] }       │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 参照したEARS要件

🔴 **EARS要件定義書が存在しない** - 本 requirements.md が初稿

### 参照した設計文書

🟢 **既存実装ファイルに基づく**

- `src/popup/sanitizePreview.js` - プレビューモーダルの表示ロジック
- `src/popup/popup.html` - モーダルのDOM構造とCSSスタイル
- `src/popup/main.js` - プレビューフローの実装
- `src/utils/piiSanitizer.js` - PII検出とマスキングロジック

---

## 2. 入出力の仕様

### 入力パラメータ

🟢 **既存実装 + 妥当な推測**に基づく

**sanitizePreview.showPreview()への追加入力**:

| パラメータ名 | 型 | 必須 | 説明 | 🟢🟡🔴 |
|-------------|-----|------|------|--------|
| `content` | `string` | はい | プレビュー表示するマスク済みテキスト | 🟢 既存 |
| `maskedItems` | `Array<MaskedItem>` | いいえ | マスクされた項目の情報配列 | 🟡 推測 |
| `maskedCount` | `number` | いいえ | マスクされた項目の総数 | 🟢 既存実装と整合 |

**MaskedItemの型定義**:

```typescript
interface MaskedItem {
  type: PIIType;              // マスクされたPIIの種類
  original: string;           // 元の値（検証・デバッグ用）
  position?: { start: number, end: number }; // テキスト内の位置（未来拡張用）
}

type PIIType = 'creditCard' | 'myNumber' | 'bankAccount' | 'email' | 'phoneJp';
```

### 出力値

🟢 **既存実装 + 妥当な推測**に基づく

**プレビューモーダルのUI出力**:

| 要素 | 型 | 説明 | 🟢🟡🔴 |
|------|-----|------|--------|
| ステータスメッセージ | `string` | "X件の個人情報をマスクしました" | 🟡 新規追加 |
| プレビューコンテンツ | `HTML string` | ハイライト付きのテキスト | 🟡 拡張 |
| ハイライトスタイル | `CSS class` | `.masked-highlight` の強化版 | 🟡 拡張 |
| ツールチップ | `title属性` | マスク箇所にホバーでタイプ表示 | 🟡 新規追加 |

### 入出力の関係性

🟢 **既存実装 + 妥当な推測**に基づく

```
main.js (preview flow)
  ├─ send PREVIEW_RECORD message
  │   └─ payload: { title, url, content, force }
  │
  └─ receive previewResponse
      ├─ processedContent: string  (マスク済みテキスト)
      ├─ maskedCount: number       (マスク件数)
      └─ maskedItems: MaskedItem[] (マスク項目詳細) ← 新規出力

sanitizePreview.showPreview(content, maskedItems, maskedCount)
  │
  ├─ ステータスメッセージ表示: `${maskedCount}件の個情報をマスクしました`
  │
  ├─ プレビューテキスト内の `[MASKED:{type}]` パターンを検出
  │   └─ 各マークを<span class="masked-highlight" title="{type}">に変換
  │
  └─ モーダル表示
```

### データフロー

🟢 **既存実装 + 妥当な推測**に基づく

```
┌─────────────┐
│  UI User    │ 1. プレビューボタンクリック
└──────┬──────┘
       │ send PREVIEW_RECORD message
       ↓
┌─────────────────────────────────┐
│   Service Worker                │
│   processUrlRecording()         │
│   ├─ L2: PII Masking            │
│   │   └─ sanitizeRegex()        │
│   │       └─ { text, maskedItems } │
│   └─ previewResponse{           │
│         processedContent,        │
│         maskedCount,             │
│         maskedItems ← 新規        │
│       }                         │
└─────────────────────────────────┘
       │ message response
       ↓
┌─────────────────────────────────┐
│   main.js                       │
│   showPreview(                  │
│     previewResponse.processedContent,  // 既存
│     previewResponse.maskedItems,      ← 新規拡張
│     previewResponse.maskedCount       ← 新規拡張
│   )                             │
└───────┬─────────────────────────┘
        │
        ↓
┌─────────────────────────────────┐
│   sanitizePreview.js            │
│   showPreview(content, maskedItems, maskedCount) │
│   │                             │
│   ├─ ステータスメッセージ生成     │ ← 新規
│   ├─ ハイライト変換処理          │ ← 拡張
│   └─ モーダル表示                │
└─────────────────────────────────┘
```

### 参照した設計文書

🟢 **既存実装ファイルに基づく**

- `src/popup/main.js` L58-94 - プレビューフローの実装
- `src/utils/piiSanitizer.js` L25-48 - `sanitizeRegex()` の戻り値定義

---

## 3. 制約条件

### パフォーマンス要件

🟢 **既存実装 + 妥当な推測**に基づく

| 要件 | 値 | 説明 | 🟢🟡🔴 |
|------|----|----|--------|
| テキスト処理時間 | < 100ms | マスク部分のハイライト変換処理 | 🟡 既存UIに追従 |
| モーダル表示時間 | < 50ms | モーダルのレンダリング | 🟢 既存実装と整合 |

### セキュリティ要件

🟡 **妥当な推測**に基づく

| 要件 | 説明 | 🟢🟡🔴 |
|------|------|--------|
| 個人情報の保護 | `original` 値はブラウザ内での検証用のみで使用 | 🟡 |
| XSS対策 | テキストのHTMLエスケープを適切に実施 | 🟡 |
| データ漏洩防止 | マスク済みテキストのみを表示、元の値はUIに表示しない | 🟡 |

### 互換性要件

🟢 **既存実装に基づく**

| 要件 | 内容 | 🟢🟡🔴 |
|------|------|--------|
| 既存フローの互換性 | `showPreview(content)` は単一引数呼び出しを維持 | 🟡 後方互換 |
| ブラウザ互換性 | Chrome Extension Manifest V3 | 🟢 |
| 既存CSSとの統合 | `.masked-highlight` クラスのスタイルを維持・拡張 | 🟢 |

### アーキテクチャ制約

🟢 **既存実装に基づく**

| 制約 | 内容 | 🟢🟡🔴 |
|------|------|--------|
| DOM構造変更の最小化 | 既存のモーダル構造を保持し、必要な要素のみ追加 | 🟢 |
| textarea の制約事項 | textarea内でHTMLタグは直接表示できないため、contenteditable divへ変更あり得る | 🟡 |
| 既存CSSの維持 | インラインCSS（約340行）を分割せず、必要な追加のみ | 🟡 |

### API制約

🟢 **既存実装に基づく**

| API | 制約 | 🟢🟡🔴 |
|-----|------|--------|
| chrome.runtime.sendMessage | 既存のメッセージタイプを維持、`maskedItems` をレスポンスに追加 | 🟡 |

### 参照した設計文書

🟢 **既存実装ファイルに基づく**

- `src/popup/popup.html` - モーダルDOM構造
- `src/popup/sanitizePreview.js` - 既存のAPI署名

---

## 4. 想定される使用例

### 基本的な使用パターン

🟢 **既存実装 + 妥当な推測**に基づく

**使用例1: マスク件数1件の表示**

```
ユーザー操作:
1. メイン画面で「プレビュー」ボタンをクリック
2. 1件のメールアドレスが検出される

UI表示:
┌─────────────────────────────────────────┐
│ 内容の確認                  [×]         │
├─────────────────────────────────────────┤
│ 1件の個人情報をマスクしました             │  ← ステータスメッセージ
├─────────────────────────────────────────┤
│ こんにちは、[MASKED:email]example.com様   │  ← ハイライト表示
│ ご連絡ありがとうございます。               │
├─────────────────────────────────────────┤
│              [キャンセル] [保存]         │
└─────────────────────────────────────────┘
```

**使用例2: マスク件数複数の表示**

```
ユーザー操作:
1. メイン画面で「プレビュー」ボタンをクリック
2. 3件の個人情報が検出される（口座番号1、電話番号2）

UI表示:
┌─────────────────────────────────────────┐
│ 内容の確認                  [×]         │
├─────────────────────────────────────────┤
│ 3件の個人情報をマスクしました             │  ← ステータスメッセージ
├─────────────────────────────────────────┤
│ お支払いは口座番号[MASKED:bankAccount]   │  ← 黄色ハイライト
│ からお願いします。                       │
│ 問い合わせ:[MASKED:phoneJp]              │  ← 黄色ハイライト
│ または[MASKED:phoneJp]まで               │  ← 黄色ハイライト
├─────────────────────────────────────────┤
│              [キャンセル] [保存]         │
└─────────────────────────────────────────┘
```

### エッジケース

🟡 **妥当な推測**に基づく

**エッジケース1: マスク件数0件**

```
ユーザー操作:
1. メイン画面で「プレビュー」ボタンをクリック
2. 検出された個人情報がない

UI表示:
┌─────────────────────────────────────────┐
│ 内容の確認                  [×]         │
├─────────────────────────────────────────┤
│ 0件の個人情報をマスクしました             │  ← 空メッセージは表示
├─────────────────────────────────────────┤
│ ご連絡ありがとうございます。               │  ← ハイライトなし
│ 继续して進めてください。                  │
├─────────────────────────────────────────┤
│              [キャンセル] [保存]         │
└─────────────────────────────────────────┘
```

**エッジケース2: 極端なマスク件数**

```
ユーザー操作:
1. メイン画面で「プレビュー」ボタンをクリック
2. 大量の個人情報が検出される（例: 100件以上）

UI表示:
┌─────────────────────────────────────────┐
│ 内容の確認                  [×]         │
├─────────────────────────────────────────┤
│ 100件の個人情報をマスクしました           │  ← 大数字も表示
├─────────────────────────────────────────┤
│ [MASKED:email]...[MASKED:phoneJp]...    │  ← 多数のハイライト
├─────────────────────────────────────────┤
│              [キャンセル] [保存]         │
└─────────────────────────────────────────┘
```

### エラーケース

🟡 **妥当な推測**に基づく

**エラーケース1: モーダル表示時のエラー**

```
状況:
- maskedItems が null または undefined として渡される

動作:
- ステータスメッセージ: "個人情報のマスク情報の取得に失敗しました"
- ハイライト処理をスキップして元のテキストを表示
- ユーザーにはエラーメッセージを表示しない（サイレントフォールバック）
```

**エラーケース2: 不正な maskedItems 形式**

```
状況:
- maskedItems が期待される配列形式ではない

動作:
- ステータスメッセージ: "~件の個人情報をマスクしました"（件数不明の場合）
- ハイライト処理をスキップ
- コンソールに警告ログを出力
```

### 参照した設計文書

🟢 **既存実装ファイルに基づく**

- `src/utils/piiSanitizer.js` - PII検出パターン定義

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

🔴 **EARS要件定義書が存在しない** - 本 requirements.md が初稿

### 参照した機能要件

| 要件ID | 終了 | 内容 | 🟢🟡🔴 |
|--------|-----|------|--------|
| UF-401-1 | MUST | マスク箇所のカウント表示を実装すること | 🟡 TODO.md |
| UF-401-2 | MUST | プレビューモーダルにステータスメッセージを表示すること | 🟡 TODO.md |
| UF-401-3 | SHOULD | マスク箇所のハイライトを強化すること | 🟡 TODO.md |
| UF-401-4 | SHOULD | ハイライトにツールチップでマスク理由を表示すること | 🟡 TODO.md |

### 参照した非機能要件

| 要件ID | 重要度 | 内容 | 🟢🟡🔴 |
|--------|--------|------|--------|
| UF-401-NFR-1 | HIGH | 既存フローとの後方互換性を維持すること | 🟡 |
| UF-401-NFR-2 | MEDIUM | テキスト処理時間を 100ms 以内に抑えること | 🟡 |
| UF-401-NFR-3 | HIGH | XSS対策を適切に実施すること | 🟡 |

### 参照したEdgeケース

| 要件ID | 内容 | 🟢🟡🔴 |
|--------|------|--------|
| UF-401-EDGE-1 | マスク件数0件の場合の表示 | 🟡 |
| UF-401-EDGE-2 | マスク件数不明の場合の表示 | 🟡 |
| UF-401-EDGE-3 | 極端なマスク件数（100件以上）の場合の表示 | 🟡 |

### 参照した受け入れ基準

| 基準 | 内容 | 🟢🟡🔴 |
|------|------|--------|
| AC-401-1 | マスク件数が正しく表示されること | 🟡 |
| AC-401-2 | マスク件数0の場合、"0件の個人情報をマスクしました"と表示されること | 🟡 |
| AC-401-3 | ハイライト箇所が視覚的に区別されること | 🟡 |
| AC-401-4 | 既存のテストがすべて通過すること | 🟢 |

### 参照した設計文書

| 種類 | パス | 🟢🟡🔴 |
|------|------|--------|
| 実装コード | `src/popup/sanitizePreview.js` | 🟢 |
| 実装コード | `src/popup/main.js` | 🟢 |
| 実装コード | `src/popup/popup.html` | 🟢 |
| ユーティリティ | `src/utils/piiSanitizer.js` | 🟢 |

---

## 補足事項

### 既知の実装上の課題

🟢 **既存実装分析に基づく**

1. **textareaの制約**: 現在プレビューコンテンツは `<textarea>` 要素で表示されているが、HTMLタグ（ハイライト用の`<span>`）を表示するには `contenteditable` 属性を持つ `div` に変更する必要がある可能性があります。この変更はブラウザ互換性やレイアウトに影響を与えるため、慎重に検討が必要です。

2. **既存の `maskedCount` 使用**: `main.js` L79ですでに `previewResponse.maskedCount` を参照していますが、この値は画面には表示されていません。今回の機能拡張で、この値をUIに反映する必要があります。

3. **既存の `maskedHighlight` スタイル**: `popup.html` L309-314で定義されていますが、色やパディングなどのスタイル値は固定されています。将来的にはテーマや設定でカスタマイズ可能にすることを検討する価値があります。

---

## 要件の変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|----------|--------|
| 1.0 | 2026-01-24 | 初版作成 | Claude Code Assistant |