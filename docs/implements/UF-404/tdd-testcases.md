# UF-404: 記録成功後のポップアップ自動クローズ - TDDテストケース定義

## 概要

**【機能名】**: 記録成功後のポップアップ自動クローズ

**TDDタスクID**: UF-404

**作成日**: 2026-01-23

---

## 開発言語・フレームワーク

### 信頼性レベル: 🟢 青信号

**プログラミング言語**: JavaScript (ES Modules)
- **言語選択の理由**: プロジェクトの既存コードがJavaScript (ES Modules)で記述されているため一貫性を保つため
- **テストに適した機能**: Jestのモック機能、タイマーモック、DOM操作のシミュレーション

**テストフレームワーク**: Jest
- **フレームワーク選択の理由**: プロジェクトの既存テストで使用されており、Jestのタイマーモック機能が自動クローズのタイミング検証に適しているため
- **テスト実行環境**: Node.js環境でDOMをjsdomを使用してシミュレート（既存テストと同じ構成）

**参照した既存テスト**:
- `src/popup/__tests__/mainSpinner.test.js` - テスト構造、コメントパターンを参考

---

## テストケース一覧

| テスト分類 | テストケース数 | 内容 |
|------------|----------------|------|
| 正常系 | 4 | メイン画面でのクローズ、カウントダウン表示、設定画面での非クローズ、設定画面での非クローズ |
| 異常系 | 2 | エラー時の非クローズ、window.close()失敗時 |
| エッジ/境界値 | 3 | 連続記録、画面遷移中のキャンセル、タイマーリファレンス保持 |
| **合計** | **9** | |

---

## 1. 正常系テストケース（基本的な動作）

### TC-001: メイン画面での記録成功時に自動クローズが実行される

- **テスト名**: メイン画面での記録成功時に自動クローズが実行される
  - **何をテストするか**: 記録成功時に2秒後にwindow.close()が呼び出されること、カウントダウンが表示されること
  - **期待される動作**: 記録成功後、ステータスエリアにカウントダウン表示（3...2...自動閉じる）がされ、2000ms後にwindow.close()が実行される
- **入力値**:
  - `recordResult.success` = `true`
  - `screenState` = `'main'`
  - **入力データの意味**: 記録処理が成功し、メイン画面が表示されている状態
- **期待される結果**:
  - ステータスエリアのテキストが「3...2...自動閉じる」と更新される
  - `window.close()` が1回呼び出される
  - タイマーの遅延時間が2000msであること
  - **期待結果の理由**: TODO.md「記録成功後にクローズロジック追加」「setTimeout(() => window.close(), 2000); 実装」に基づく
- **テストの目的**: 成功時の自動クローズ基本動作の確認
  - **確認ポイント**: window.close()の呼び出しタイミングと回数、カウントダウン表示の更新
- 🟢 要件定義(tdd-requirements.md 132-140行目)に基づき仕様が明確

### TC-002: カウントダウン表示が正しく更新される

- **テスト名**: カウントダウン表示が正しく更新される
  - **何をテストするか**: ステータスエリアにカウントダウンが正しく表示・更新されること
  - **期待される動作**: ステータスエリアのtextContentが「3...2...1...自動閉じる」のように更新される
- **入力値**:
  - `recordResult.success` = `true`
  - `screenState` = `'main'`
  - **入力データの意味**: 記録成功時のカウントダウン表示挙動
- **期待される結果**:
  - ステータスエリアのtextContentが「3...2...自動閉じる」であること
  - カウントダウンの更新間隔が1000msであること
  - **期待結果の理由**: TODO.md「カウントダウン秒数の表示（3...2...1...）」に基づく
- **テストの目的**: UIフィードバックの確認
  - **確認ポイント**: カウントダウンの表示形式、更新タイミング
- 🟢 要件定義(tdd-requirements.md 103-104行目)に基づき仕様が明確

### TC-003: 設定画面で記録成功時に自動クローズされない

- **テスト名**: 設定画面で記録成功時に自動クローズされない
  - **何をテストするか**: 設定画面で記録成功した場合、自動クローズが行われないこと
  - **期待される動作**: 記録成功メッセージは表示されるが、カウントダウン表示と自動クローズは行われない
- **入力値**:
  - `recordResult.success` = `true`
  - `screenState` = `'settings'`
  - **入力データの意味**: 設定画面で記録処理が成功した状態
- **期待される結果**:
  - ステータスエリアに成功メッセージ「✓ Obsidianに保存しました」が表示されること
  - カウントダウン表示が行われないこと
  - `window.close()` が呼び出されないこと
  - **期待結果の理由**: TODO.md「設定画面にいる場合はクローズしない判定」に基づく
- **テストの目的**: 画面条件分岐の確認
  - **確認ポイント**: 画面状態による自動クローズの制御
- 🟢 要件定義(tdd-requirements.md 111行目)に基づき仕様が明確

### TC-004: 記録成功後に成功メッセージが表示される

- **テスト名**: 記録成功後に成功メッセージが表示される
  - **何をテストするか**: 記録成功時に適切な成功メッセージが表示されること
  - **期待される動作**: ステータスエリアに「✓ Obsidianに保存しました」と表示され、クラス名が'success'になる
- **入力値**:
  - `recordResult.success` = `true`
  - **screenState` = `'main'` または `'settings'`
  - **入力データの意味**: 記録成功時のメッセージ表示挙動
- **期待される結果**:
  - ステータスエリアのtextContentに「✓ Obsidianに保存しました」が含まれること
  - ステータスエリアのclassNameに'success'が含まれること
  - **期待結果の理由**: 既存コードmain.js:122-123行目の動作を踏襲
- **テストの目的**: メッセージ表示の確認
  - **確認ポイント**: メッセージ内容、CSSクラスの適用
- 🟢 既存コードmain.js:120-126行目からの仕様継承

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-101: 記録失敗時（エラー発生時）に自動クローズされない

- **テスト名**: 記録失敗時に自動クローズされない
  - **エラーケースの概要**: 記録処理が例外またはエラーを返した場合
  - **エラー処理の重要性**: ユーザーにエラー内容を認識させるため、ポップアップを閉じずエラーメッセージを表示する必要がある
- **入力値**:
  - `recordResult.success` = `false` または `Error` がスローされる
  - **screenState` = `'main'`
  - **不正な理由**: 記録処理が失敗したため、成功時の自動クローズロジックを実行すべきではない
  - **実際の発生シナリオ**: APIエラー、ネットワークエラー、ドメインブロック等
- **期待される結果**:
  - ステータスエリアにエラーメッセージが表示されること
  - カウントダウン表示が行われないこと
  - `window.close()` が呼び出されないこと
  - ステータスエリアのclassNameに'error'が含まれること
  - **エラーメッセージの内容**: エラーの種類に応じた適切なメッセージ
  - **システムの安全性**: ユーザーがエラー内容を確認できるため、安全な状態
- **テストの目的**: エラー時の自動クローズ防止の確認
  - **品質保証の観点**: ユーザビリティとエラー通知の確保
- 🟢 要件定義(tdd-requirements.md 152-158行目)に基づき仕様が明確

### TC-102: window.close()失敗時のサイレントフェール

- **テスト名**: window.close()失敗時の挙動
  - **エラーケースの概要**: window.close()がブラウザによってブロックされる、または例外がスローされる
  - **エラー処理の重要性**: クローズ失敗は致命的なエラーではないため、サイレントフェールで例外をスローすべきではない
- **入力値**:
  - `window.close()` が例外をスローする（モック設定）
  - **不正な理由**: ブラウザのポリシーによりスクリプトからのクローズがブロックされる場合がある
  - **実際の発生シナリオ**: ブラウザ設定、セキュリティポリシー
- **期待される結果**:
  - 例外がスローされないこと
  - テストが正常にパスすること
  - console.warn などで警告が出力されること（オプション）
  - **エラーメッセージの内容**: なし（サイレントフェール）
  - **システムの安全性**: クローズ失敗してもシステムは正常な状態を保つ
- **テストの目的**: クローズ失敗時の適切なエラーハンドリングの確認
  - **品質保証の観点**: 堅牢性の確保
- 🟡 要件定義(tdd-requirements.md 176-181行目)からの妥当な推測

---

## 3. 境界値・エッジケーステストケース（最小値、最大値、null等）

### TC-201: 連続記録時のタイマー管理

- **テスト名**: 連続記録時に前のタイマーがキャンセルされる
  - **境界値の意味**: 2回以上の連続記録操作が行われた場合のタイマー状態管理
  - **境界値での動作保証**: 前のタイマーがクリアされないと、意図しないタイミングでクローズされたり、メモリリークの原因となる
- **入力値**:
  - 1回目の記録開始（成功）
  - タイマー遅延完了前に2回目の記録開始（成功）
  - 2回目の記録処理完了
  - **境界値選択の根拠**: 連続操作というエッジケースを想定
  - **実際の使用場面**: ユーザーが誤ってボタンを連打した場合
- **期待される結果**:
  - 1回目のタイマーがキャンセルされていること（clearTimeout呼び出し）
  - 2回目のタイマーのみが実行されること
  - `window.close()` が1回だけ呼び出されること
  - **境界での正確性**: タイマー参照が適切に管理され、不要なタイマーが残らないこと
  - **一貫した動作**: 最新の記録処理に対してのみクローズが行われること
- **テストの目的**: タイマーリファレンス管理の確認
  - **堅牢性の確認**: メモリリーク防止、意図しない動作防止
- 🟢 要件定義(tdd-requirements.md 162-167行目)に基づき仕様が明確

### TC-202: カウントダウン中の画面遷移時のタイマーキャンセル

- **テスト名**: カウントダウン中に設定画面へ遷移した場合のタイマーキャンセル
  - **境界値の意味**: 自動クローズ待ち中の状態から画面遷移操作が行われた場合
  - **境界値での動作保証**: 設定画面では自動クローズすべきでないため、タイマーをキャンセルする必要がある
- **入力値**:
  - 記録開始（成功）、カウントダウン開始（main画面）
  - カウントダウン完了前に「設定」ボタンクリックを実行
  - 画面遷移（main → settings）
  - **境界値選択の根拠**: タイマー実行中の画面遷移というエッジケース
  - **実際の使用場面**: 記録後、設定を変更しようとしたユーザー操作
- **期待される結果**:
  - 自動クローズタイマーがキャンセルされていること（clearTimeout呼び出し）
  - `window.close()` が呼び出されないこと
  - 設定画面が正常に表示されること
  - カウントダウン表示が停止または削除されていること
  - **境界での正確性**: 画面遷移操作によってタイマーが確実にキャンセルされること
  - **一貫した動作**: 設定画面で記録開始した場合と同様、ポップアップは開いたままであること
- **テストの目的**: 画面遷移によるタイマー制御の確認
  - **堅牢性の確認**: ユーザー操作による意図しないクローズ防止
- 🟢 要件定義(tdd-requirements.md 169-174行目)に基づき仕様が明確

### TC-203: タイマーオブジェクトの適切な保持とクリア

- **テスト名**: タイマーオブジェクト（setTimeoutの戻り値）が適切に管理される
  - **境界値の意味**: グローバルスコープまたはモジュールスコープでのタイマー参照の管理
  - **境界値での動作保証**: 複数のタイマーコンテキストで参照が正しく維持され、clearTimeoutで正しくクリアできること
- **入力値**:
  - タイマー開始 → タイマー参照を保持
  - タイマー開始 → タイマー参照を上書き → クリア
  - **境界値選択の根拠**: タイマー参照のライフサイクル管理
  - **実際の使用場面**: 連続した記録操作や画面遷移
- **期待される結果**:
  - タイマー参照を保持する変数が定義されていること
  - タイマー開始時にこの変数にsetTimeoutの戻り値が代入されていること
  - タイマークリア時にこの変数の値が渡されていること
  - **境界での正確性**: タイマー参照が正しく取得・代入・渡されていること
  - **一貫した動作**: どのタイミングでタイマーを管理しても正しくクリアできること
- **テストの目的**: タイマー参照管理の構造確認
  - **堅牢性の確認**: 実装パターンの検証
- 🟢 要件定義(tdd-requirements.md 166-167行目)からの妥当な推測

---

## 4. テストカバレッジ分析

### 要件カバレッジ

| 要件項目 | 対応テスト | カバレッジ |
|----------|------------|------------|
| 記録成功時にタイマー起動 | TC-001 | ✅ |
| 2秒遅延でwindow.close() | TC-001 | ✅ |
| 設定画面ではクローズしない | TC-003, TC-202 | ✅ |
| エラー時はクローズしない | TC-101 | ✅ |
| カウントダウン表示 | TC-002 | ✅ |
| 画面遷移時のタイマーキャンセル | TC-202 | ✅ |
| 連続記録のタイマー管理 | TC-201 | ✅ |
| window.close()失敗時の処理 | TC-102 | ✅ |

### コードカバレッジ対象

| コード部分 | 対応テスト | カバレッジ |
|------------|------------|------------|
| main.js: 成功時の処理（タイマー起動） | TC-001, TC-002, TC-003, TC-004 | ✅ |
| main.js: 失敗時の処理（タイマー未起動） | TC-101 | ✅ |
| navigation.js: showMainScreen | TC-001, TC-002, TC-004, TC-201 | ✅ |
| navigation.js: showSettingsScreen | TC-003, TC-202 | ✅ |
| タイマー管理（clearTimeout） | TC-201, TC-202 | ✅ |

---

## 5. テスト実装時の注意点

### タイマー操作のモック

JestのFake Timers機能を使用して、実際の待機時間なしにタイマー動作をテストします：

```javascript
beforeEach(() => {
  jest.useFakeTimers();
});

afterEach(() => {
  jest.useRealTimers();
});
```

### DOM操作のシミュレーション

jsdomを使用してDOM要素とその状態を検証します。

### window.close()のモック

window.close()をjest.fn()でモックし、呼び出し回数とタイミングを検証します：

```javascript
global.close = jest.fn();
// または
Object.defineProperty(window, 'close', {
  writable: true,
  value: jest.fn(),
});
```

### 非同期処理のハンドリング

タイマー完了後の処理を検証するために、`jest.runAllTimers()`または`jest.advanceTimersByTime()`を使用します。

---

## 6. テスト不可能・検証困難な項目

| 項目 | 理由 | 対応方法 |
|------|------|----------|
| ブラウザでの実際のポップアップ閉じ動作 | jsdom環境ではwindow.close()は実ウィンドウを閉じない | コール回数・タイミングの検証で代替 |
| ユーザーによる手動クローズ操作 | Selenium/E2Eテストが必要 | Jestでは検証範囲外 |
| 実際のブラウザポリシーによるクローズ制限 | ブラウザ固有の挙動を再現できない | サイレントフェールの検証のみ |

---

## 品質判定結果

### ✅ 高品質

- **テストケース分類**: 正常系(4)・異常系(2)・エッジケース(3)が網羅されている
- **期待値定義**: 各テストケースの期待値が明確
- **技術選択**: JavaScript + Jestが確定（既存プロジェクトと一貫性あり）
- **実装可能性**: 現在の技術スタックで実現可能

### 判定理由
1. 正常系・異常系・エッジケースの3分類が網羅されている
2. 期待結果が具体的で検証可能
3. 使用するテスト技術が明確（Jest、Fake Timers、jsdom）
4. 既存テストパターン（mainSpinner.test.js）を踏襲し実装コスト低減
5. 要件定義との完全な対応関係が確立

---

## TODO更新パターン

- 現在のTODO「テストケース洗い出し」を「completed」にマーク
- テストケース定義フェーズの完了をTODO内容に反映
- 次のフェーズ「Redフェーズ（失敗テスト作成）」をTODOに追加

---

## 次のステップ

**推奨コマンド**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

Redフェーズでは以下を実装します：
1. `src/popup/__tests__/autoClose.test.js` 新規作成
2. navigation.js: 画面状態追跡のモジュール化とテスト
3. main.jsへのタイマー管理モジュールの統合テスト