# UF-404: è¨˜éŒ²æˆåŠŸå¾Œã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º - TDD Redãƒ•ã‚§ãƒ¼ã‚¹

## æ¦‚è¦

**ã€æ©Ÿèƒ½åã€‘**: è¨˜éŒ²æˆåŠŸå¾Œã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

**TDDã‚¿ã‚¹ã‚¯ID**: UF-404

**ä½œæˆæ—¥**: 2026-01-23

---

## å¯¾è±¡ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

**ã€å¯¾è±¡ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã€‘**: è¨˜éŒ²æˆåŠŸå¾Œã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºæ©Ÿèƒ½ï¼ˆUF-404ï¼‰

---

## é–‹ç™ºè¨€èªãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

**ä½¿ç”¨è¨€èª/ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: JavaScript (ES Modules) + Jest

---

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `src/popup/__tests__/autoClose.test.js`

```javascript
/**
 * UF-404 è¨˜éŒ²æˆåŠŸå¾Œã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
 *
 * Redãƒ•ã‚§ãƒ¼ã‚º: æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½ã«é–¢ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
 * ç”»é¢çŠ¶æ…‹è¿½è·¡ã€è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºãƒ­ã‚¸ãƒƒã‚¯ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã€ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã®å‹•ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
 */

import { describe, test, expect, beforeEach, afterEach } from '@jest/globals';
import { jest } from '@jest/globals';

// ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»é–¢æ•°ã®importï¼ˆRedãƒ•ã‚§ãƒ¼ã‚ºç”¨ï¼‰
import {
  getScreenState,
  setScreenState,
  clearScreenState
} from '../navigation.js';

import {
  startAutoCloseTimer,
  clearAutoCloseTimer,
  showCountdown
} from '../autoClose.js';

describe('ç”»é¢çŠ¶æ…‹è¿½è·¡ (navigation.js)', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: ç”»é¢ãŒãƒ¡ã‚¤ãƒ³ç”»é¢ã‹è¨­å®šç”»é¢ã‹ã‚’åˆ¤å®šã§ãã‚‹æ©Ÿèƒ½ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã®å–å¾—ãƒ»è¨­å®šãƒ»ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ç”»é¢çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    clearScreenState();
  });

  test('getScreenStateã§åˆæœŸçŠ¶æ…‹ãŒmainã§ã‚ã‚‹ã“ã¨', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: åˆæœŸç”»é¢çŠ¶æ…‹ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä½•ã‚‚è¨­å®šã—ã¦ã„ãªã„çŠ¶æ…‹ã§getScreenStateã‚’å‘¼ã³å‡ºã™ã¨'main'ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸçŠ¶æ…‹ã¨ã—ã¦'main'ãŒè¿”ã‚‹ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 49-52è¡Œç›®ã€åˆæœŸç”»é¢ãŒãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: getScreenStateé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    // ã€å‡¦ç†å†…å®¹ã€‘: ç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’å–å¾—
    const screenState = getScreenState();

    // ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸçŠ¶æ…‹ãŒ'main'ã§ã‚ã‚‹ã“ã¨
    expect(screenState).toBe('main'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç”»é¢çŠ¶æ…‹ãŒ'main'ã§ã‚ã‚‹ã“ã¨
  });

  test('setScreenStateã§è¨­å®šç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç”»é¢çŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: setScreenState('settings')ã‚’å‘¼ã³å‡ºã—å¾Œã€getScreenStateã§ç¢ºèª
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ç”»é¢çŠ¶æ…‹ãŒ'settings'ã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 49-52è¡Œç›®ã€screenStateå‹å®šç¾©ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç”»é¢ã‚’è¨­å®šç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
    // ã€å‡¦ç†å†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã‚’'settings'ã«è¨­å®š
    setScreenState('settings');

    // ã€çµæœæ¤œè¨¼ã€‘: ç”»é¢çŠ¶æ…‹ãŒ'settings'ã§ã‚ã‚‹ã“ã¨
    expect(getScreenState()).toBe('settings'); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šç”»é¢ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸã“ã¨
  });

  test('setScreenStateã®å¾Œã€clearScreenStateã§åˆæœŸçŠ¶æ…‹ã«æˆ»ã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç”»é¢çŠ¶æ…‹ã®ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç”»é¢ã‚’è¨­å®šã«å¤‰æ›´ã—ãŸå¾Œã€ã‚¯ãƒªã‚¢ã™ã‚‹ã¨'main'ã«æˆ»ã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¯ãƒªã‚¢å¾Œã«ç”»é¢çŠ¶æ…‹ãŒ'main'ã«æˆ»ã‚‹ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ã«åŸºã¥ãåˆæœŸçŠ¶æ…‹ã‚’'main'ã¨ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç”»é¢ã‚’è¨­å®šç”»é¢ã«è¨­å®š
    setScreenState('settings');
    expect(getScreenState()).toBe('settings'); // ã€å‰ææ¡ä»¶ç¢ºèªã€‘: è¨­å®šç”»é¢ã§ã‚ã‚‹ã“ã¨

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç”»é¢çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    // ã€å‡¦ç†å†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã‚’åˆæœŸå€¤'main'ã«æˆ»ã™
    clearScreenState();

    // ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸçŠ¶æ…‹'main'ã«æˆ»ã£ã¦ã„ã‚‹ã“ã¨
    expect(getScreenState()).toBe('main'); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ã«æˆ»ã£ãŸã“ã¨
  });
});

describe('è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ (autoClose.js)', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: è¨˜éŒ²æˆåŠŸå¾Œã®è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã€ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†ã€ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢ã‚’ãƒ†ã‚¹ãƒˆ

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: DOMã¨ã‚¿ã‚¤ãƒãƒ¼ã‚’åˆæœŸåŒ–çŠ¶æ…‹ã«ã™ã‚‹
    jest.useFakeTimers();
    document.body.innerHTML = `
      <div id="mainScreen" style="display: block;">
        <div id="mainStatus"></div>
      </div>
      <div id="settingsScreen" style="display: none;"></div>
    `;
    clearScreenState();

    // ã€ãƒ¢ãƒƒã‚¯è¨­å®šã€‘: window.close()ã‚’ãƒ¢ãƒƒã‚¯
    Object.defineProperty(window, 'close', {
      writable: true,
      value: jest.fn(),
    });
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ã‚¿ã‚¤ãƒãƒ¼ã¨ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
    jest.useRealTimers();
    clearAutoCloseTimer();
    jest.restoreAllMocks();
  });

  test('startAutoCloseTimerã§ã‚¿ã‚¤ãƒãƒ¼ãŒèµ·å‹•ã—ã€2000mså¾Œã«window.closeãŒå‘¼ã°ã‚Œã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºåŸºæœ¬å‹•ä½œã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: startAutoCloseTimerå‘¼ã³å‡ºã—å¾Œã€2000msçµŒéã§window.closeãŒå‘¼ã°ã‚Œã‚‹ã“ã¨
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚¤ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã€æ­£ã—ã„é…å»¶æ™‚é–“å¾Œã«window.closeãŒå®Ÿè¡Œã•ã‚Œã‚‹
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 46-48è¡Œç›®ã€2000msé…å»¶ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
    // ã€å‡¦ç†å†…å®¹ã€‘: 2000mså¾Œã«window.closeã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
    startAutoCloseTimer();

    // ã€çµæœæ¤œè¨¼ã€‘: ã¾ã window.closeã¯å‘¼ã°ã‚Œã¦ã„ãªã„
    expect(window.close).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¿ã‚¤ãƒãƒ¼è¨­å®šç›´å¾Œã¯å‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    jest.advanceTimersByTime(2000);

    // ã€çµæœæ¤œè¨¼ã€‘: window.closeãŒ1å›å‘¼ã°ã‚ŒãŸã“ã¨
    expect(window.close).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: 2000mså¾Œã«1å›å‘¼ã°ã‚ŒãŸã“ã¨
  });

  test('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: showCountdownã‚’å‘¼ã³å‡ºã™ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ã®textContentãŒã€Œ3...2...è‡ªå‹•é–‰ã˜ã‚‹ã€ã«æ›´æ–°ã•ã‚Œã‚‹
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-testcases.md TC-002ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºï¼‰

    const statusDiv = document.getElementById('mainStatus');

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’é–‹å§‹
    // ã€å‡¦ç†å†…å®¹ã€‘: 1000msé–“éš”ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    showCountdown(statusDiv);

    // ã€åˆæœŸçŠ¶æ…‹ç¢ºèªã€‘: åˆæœŸå€¤ãŒã€Œ3...ã€ã§ã‚ã‚‹ã“ã¨
    expect(statusDiv.textContent).toContain('3...'); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸè¡¨ç¤ºãŒ3ã§ã‚ã‚‹ã“ã¨

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 1ç§’é€²ã‚ã‚‹
    jest.advanceTimersByTime(1000);
    expect(statusDiv.textContent).toContain('2...'); // ã€ç¢ºèªå†…å®¹ã€‘: 2ã«æ›´æ–°ã•ã‚ŒãŸã“ã¨

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: ã‚‚ã†1ç§’é€²ã‚ã‚‹
    jest.advanceTimersByTime(1000);
    expect(statusDiv.textContent).toContain('1...'); // ã€ç¢ºèªå†…å®¹ã€‘: 1ã«æ›´æ–°ã•ã‚ŒãŸã“ã¨
  });

  test('è¨­å®šç”»é¢ã§ã¯è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç”»é¢æ¡ä»¶ã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºåˆ¶å¾¡ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è¨­å®šç”»é¢ã§startAutoCloseTimerã‚’å‘¼ã³å‡ºã—ã¦ã‚‚ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ä½œã—ãªã„
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚¤ãƒãƒ¼ãŒè¨­å®šã•ã‚Œãšã€window.closeã‚‚å‘¼ã°ã‚Œãªã„ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 111è¡Œç›®ã€è¨­å®šç”»é¢ã§ã¯ã‚¯ãƒ­ãƒ¼ã‚ºã—ãªã„ï¼‰

    // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç”»é¢ã‚’è¨­å®šç”»é¢ã«è¨­å®š
    setScreenState('settings');

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆè¨­å®šç”»é¢çŠ¶æ…‹ï¼‰
    // ã€å‡¦ç†å†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã¯ãšã®é–¢æ•°
    startAutoCloseTimer();

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    jest.advanceTimersByTime(2000);

    // ã€çµæœæ¤œè¨¼ã€‘: window.closeãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨
    expect(window.close).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: è¨­å®šç”»é¢ã§ã¯ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œãªã„ã“ã¨
  });

  test('clearAutoCloseTimerã§ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ã‚¤ãƒãƒ¼è¨­å®šå¾Œã«clearAutoCloseTimerã‚’å‘¼ã³å‡ºã™ã¨ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œãªã„
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚¤ãƒãƒ¼ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€window.closeãŒå‘¼ã°ã‚Œãªã„ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 166-167è¡Œç›®ã€é€£ç¶šè¨˜éŒ²æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
    startAutoCloseTimer();

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    // ã€å‡¦ç†å†…å®¹ã€‘: è¨­å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
    clearAutoCloseTimer();

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    jest.advanceTimersByTime(2000);

    // ã€çµæœæ¤œè¨¼ã€‘: window.closeãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨
    expect(window.close).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã“ã¨
  });
});

describe('é€£ç¶šè¨˜éŒ²æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: é€£ç¶šæ“ä½œæ™‚ã®ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ç®¡ç†ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 2å›ç›®ã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã§1å›ç›®ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã“ã¨

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–
    jest.useFakeTimers();
    document.body.innerHTML = `
      <div id="mainScreen" style="display: block;">
        <div id="mainStatus"></div>
      </div>
    `;
    clearScreenState();

    Object.defineProperty(window, 'close', {
      writable: true,
      value: jest.fn(),
    });
  });

  afterEach(() => {
    jest.useRealTimers();
    clearAutoCloseTimer();
    jest.restoreAllMocks();
  });

  test('é€£ç¶šã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨å‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: é€£ç¶šè¨˜éŒ²æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 2å›é€£ç¶šã§startAutoCloseTimerã‚’å‘¼ã³å‡ºã—ã€ã‚¯ãƒ­ãƒ¼ã‚ºå›æ•°ã‚’ç¢ºèª
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1å›ã ã‘window.closeãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ï¼ˆ2å›ç›®ã®ã¿å®Ÿè¡Œï¼‰
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 162-167è¡Œç›®ã€é€£ç¶šè¨˜éŒ²æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 1å›ç›®ã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
    startAutoCloseTimer();

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 2å›ç›®ã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®šï¼ˆ1å›ç›®ãŒå®Œäº†ã™ã‚‹å‰ï¼‰
    startAutoCloseTimer();

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    jest.advanceTimersByTime(2000);

    // ã€çµæœæ¤œè¨¼ã€‘: window.closeãŒ1å›ã ã‘å‘¼ã°ã‚ŒãŸã“ã¨
    expect(window.close).toHaveBeenCalledTimes(1); // ã€ç¢ºèªå†…å®¹ã€‘: å‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€1å›åˆ†ã®ã¿å®Ÿè¡Œã•ã‚ŒãŸã“ã¨
  });
});

describe('ç”»é¢é·ç§»æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: ç”»é¢é·ç§»ã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã«ç”»é¢é·ç§»ã™ã‚‹ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹

  beforeEach(() => {
    jest.useFakeTimers();
    document.body.innerHTML = `
      <div id="mainScreen" style="display: block;">
        <div id="mainStatus"></div>
      </div>
      <div id="settingsScreen" style="display: none;"></div>
    `;

    Object.defineProperty(window, 'close', {
      writable: true,
      value: jest.fn(),
    });
  });

  afterEach(() => {
    jest.useRealTimers();
    clearAutoCloseTimer();
    jest.restoreAllMocks();
  });

  test('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã«è¨­å®šç”»é¢ã¸é·ç§»ã™ã‚‹ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç”»é¢é·ç§»ã«ã‚ˆã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ã‚¤ãƒãƒ¼è¨­å®šå¾Œã«setScreenState('settings')ã‚’å‘¼ã³å‡ºã™
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€window.closeãŒå‘¼ã°ã‚Œãªã„ã“ã¨
    // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 169-174è¡Œç›®ã€ç”»é¢é·ç§»æ™‚ã®ã‚¿ã‚¤ãƒãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
    startAutoCloseTimer();

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç”»é¢ã‚’è¨­å®šç”»é¢ã«é·ç§»
    // ã€å‡¦ç†å†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã‚’'settings'ã«å¤‰æ›´ã™ã‚‹ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹
    setScreenState('settings');

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    jest.advanceTimersByTime(2000);

    // ã€çµæœæ¤œè¨¼ã€‘: window.closeãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨
    expect(window.close).not.toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: ç”»é¢é·ç§»ã«ã‚ˆã‚Šã‚¿ã‚¤ãƒãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã“ã¨
  });
});

describe('ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ™å‹•', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã§ã®é©åˆ‡ãªæŒ™å‹•ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: window.closeå¤±æ•—æ™‚ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ•ã‚§ãƒ¼ãƒ«å‹•ä½œ

  beforeEach(() => {
    jest.useFakeTimers();
    document.body.innerHTML = `
      <div id="mainScreen" style="display: block;"></div>
    `;
  });

  afterEach(() => {
    jest.useRealTimers();
    jest.restoreAllMocks();
  });

  test('window.closeãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ•ã‚§ãƒ¼ãƒ«ï¼‰', () => {
    // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: window.closeå¤±æ•—æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¢ºèª
    // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: window.closeãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ãƒ¢ãƒƒã‚¯ã‚’è¨­å®šã—ã¦å®Ÿè¡Œ
    // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œãšã€ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
    // ğŸŸ¡ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 176-181è¡Œç›®ï¼‰ã‹ã‚‰ã®å¦¥å½“ãªæ¨æ¸¬

    // ã€ãƒ¢ãƒƒã‚¯è¨­å®šã€‘: window.closeãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
    Object.defineProperty(window, 'close', {
      writable: true,
      value: jest.fn(() => {
        throw new Error('Close blocked by browser');
      }),
    });

    // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¿ã‚¤ãƒãƒ¼ã®å®Ÿè£…å†…ã§ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¦ã‚‚å‡¦ç†ãŒç¶šãã¯ãš
    startAutoCloseTimer();

    // ã€ã‚¿ã‚¤ãƒãƒ¼é€²è¡Œã€‘: 2000msçµŒéã•ã›ã‚‹
    expect(() => {
      jest.advanceTimersByTime(2000);
    }).not.toThrow(); // ã€ç¢ºèªå†…å®¹ã€‘: ä¾‹å¤–ãŒå¤–éƒ¨ã«ä¼æ’­ã—ãªã„ã“ã¨
  });
});
```

---

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
npm test -- src/popup/__tests__/autoClose.test.js
```

---

## æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã™ï¼š

### 1. autoClose.jsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„
```
Jest encountered an unexpected token

  Details:

    /Users/yaar/Playground/obsidian-smart-history/src/popup/__tests__/autoClose.test.js:14
    import {
      startAutoCloseTimer,
      clearAutoCloseTimer,
      showCountdown
    } from '../autoClose.js';

    SyntaxError: Cannot find module '../autoClose.js'
```

ã¾ãŸã¯

```
Cannot find module '../autoClose.js' from 'autoClose.test.js'
```

### 2. navigation.jsã«é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„
```
ReferenceError: getScreenState is not defined
    at Object.<anonymous> (src/popup/__tests__/autoClose.test.js:28:26)
```

---

## ã‚³ãƒ¡ãƒ³ãƒˆã®èª¬æ˜

### ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
describe('ç”»é¢çŠ¶æ…‹è¿½è·¡ (navigation.js)', () => {
  // ã€ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®ç›®çš„ã€‘: ç”»é¢ãŒãƒ¡ã‚¤ãƒ³ç”»é¢ã‹è¨­å®šç”»é¢ã‹ã‚’åˆ¤å®šã§ãã‚‹æ©Ÿèƒ½ã‚’æ¤œè¨¼
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç”»é¢çŠ¶æ…‹ã®å–å¾—ãƒ»è¨­å®šãƒ»ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
```

**æ„å›³**: ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã§ä½•ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‹ã‚’æ˜ç¢ºã«ã—ã€å¾Œã§èª­ã‚€äººãŒç†è§£ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹é–‹å§‹æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
test('getScreenStateã§åˆæœŸçŠ¶æ…‹ãŒmainã§ã‚ã‚‹ã“ã¨', () => {
  // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: åˆæœŸç”»é¢çŠ¶æ…‹ã®ç¢ºèª
  // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä½•ã‚‚è¨­å®šã—ã¦ã„ãªã„çŠ¶æ…‹ã§getScreenStateã‚’å‘¼ã³å‡ºã™ã¨'main'ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
  // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸçŠ¶æ…‹ã¨ã—ã¦'main'ãŒè¿”ã‚‹ã“ã¨
  // ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 49-52è¡Œç›®ã€åˆæœŸç”»é¢ãŒãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰
```

**æ„å›³**:
- ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã“ã®ãƒ†ã‚¹ãƒˆã§ä½•ã‚’ç¢ºèªã—ãŸã„ã®ã‹
- ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’ã¨ã‚‹ã®ã‹
- ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ­£å¸¸ã«å‹•ä½œã—ãŸå ´åˆã©ã†ãªã‚‹ã¹ãã‹
- ğŸŸ¢ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ãƒ†ã‚¹ãƒˆå†…å®¹ãŒã©ã®è³‡æ–™ã«åŸºã¥ã„ã¦ã„ã‚‹ã‹

### Givenï¼ˆæº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
beforeEach(() => {
  // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–
  // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  clearScreenState();
});
```

**æ„å›³**:
- ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: ãªãœã“ã®æº–å‚™ãŒå¿…è¦ãªã®ã‹
- ã€ç’°å¢ƒåˆæœŸåŒ–**: ã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹

### Whenï¼ˆå®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
// ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: getScreenStateé–¢æ•°ã‚’å‘¼ã³å‡ºã—
// ã€å‡¦ç†å†…å®¹ã€‘: ç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’å–å¾—
const screenState = getScreenState();
```

**æ„å›³**:
- ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã©ã®é–¢æ•°/ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã®ã‹
- ã€å‡¦ç†å†…å®¹ã€‘ï¼šå¼•ã„ãŸæ“ä½œãŒä½•ã‚’æ„å‘³ã™ã‚‹ã®ã‹ã‚’èª¬æ˜

### Thenï¼ˆæ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
// ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸçŠ¶æ…‹ãŒ'main'ã§ã‚ã‚‹ã“ã¨
expect(screenState).toBe('main'); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç”»é¢çŠ¶æ…‹ãŒ'main'ã§ã‚ã‚‹ã“ã¨
```

**æ„å›³**:
- ã€çµæœæ¤œè¨¼ã€‘: ä½•ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã®ã‹å¤§ããªè¦³ç‚¹
- ã€ç¢ºèªå†…å®¹ã€‘: å…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªç‚¹ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã®ã‹

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ¡ãƒ³ãƒˆ

```javascript
// ğŸŸ¢ è¦ä»¶å®šç¾©ï¼ˆtdd-requirements.md 49-52è¡Œç›®ã€åˆæœŸç”»é¢ãŒãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰
```

**æ„å›³**:
- ğŸŸ¢ é’ä¿¡å·: è¦ä»¶å®šç¾©ã‹ã‚‰ç›´æ¥æŠ½å‡ºã—ã€æ¨æ¸¬ãŒã»ã¨ã‚“ã©ãªã„
- ğŸŸ¡ é»„ä¿¡å·: è¦ä»¶å®šç¾©ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ èµ¤ä¿¡å·: è³‡æ–™ã«ãªã„æ¨æ¸¬

---

## æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®è¦æ±‚äº‹é …

### Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã™ã¹ãå†…å®¹

#### 1. navigation.js ã¸ã®è¿½åŠ 

æ—¢å­˜ã® `src/popup/navigation.js` ã«ä»¥ä¸‹ã®é–¢æ•°ã‚’è¿½åŠ ï¼š

```javascript
// ç”»é¢çŠ¶æ…‹ã®ä¿æŒï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ•°ï¼‰
let currentScreen = 'main';

/**
 * ç¾åœ¨ã®ç”»é¢çŠ¶æ…‹ã‚’å–å¾—
 * @returns {'main' | 'settings'} ç¾åœ¨ã®ç”»é¢çŠ¶æ…‹
 */
export function getScreenState() {
  return currentScreen;
}

/**
 * ç”»é¢çŠ¶æ…‹ã‚’è¨­å®š
 * @param {'main' | 'settings'} state è¨­å®šã™ã‚‹ç”»é¢çŠ¶æ…‹
 */
export function setScreenState(state) {
  currentScreen = state;
}

/**
 * ç”»é¢çŠ¶æ…‹ã‚’åˆæœŸå€¤ã«æˆ»ã™
 */
export function clearScreenState() {
  currentScreen = 'main';
}
```

#### 2. autoClose.js æ–°è¦ä½œæˆ

`src/popup/autoClose.js` ã‚’æ–°è¦ä½œæˆï¼š

```javascript
import { getScreenState } from './navigation.js';

let autoCloseTimerId = null;
let countdownIntervalId = null;

/**
 * è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
 * è¨­å®šç”»é¢ã®å ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•ã—ãªã„
 */
export function startAutoCloseTimer() {
  // è¨­å®šç”»é¢ã§ã¯è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã—ãªã„
  if (getScreenState() !== 'main') {
    return;
  }

  // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
  clearAutoCloseTimer();

  // 2000mså¾Œã«window.closeã‚’å‘¼ã³å‡ºã™
  autoCloseTimerId = setTimeout(() => {
    try {
      window.close();
    } catch (error) {
      // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ•ã‚§ãƒ¼ãƒ«: ã‚¯ãƒ­ãƒ¼ã‚ºå¤±æ•—æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
    }
  }, 2000);
}

/**
 * è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
 */
export function clearAutoCloseTimer() {
  if (autoCloseTimerId !== null) {
    clearTimeout(autoCloseTimerId);
    autoCloseTimerId = null;
  }
  if (countdownIntervalId !== null) {
    clearInterval(countdownIntervalId);
    countdownIntervalId = null;
  }
}

/**
 * ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’é–‹å§‹
 * @param {HTMLElement} statusDiv ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨ã®DOMè¦ç´ 
 */
export function showCountdown(statusDiv) {
  let count = 3;
  statusDiv.textContent = `3...`;

  countdownIntervalId = setInterval(() => {
    count--;
    if (count > 0) {
      statusDiv.textContent = `${count}...`;
    } else {
      statusDiv.textContent = 'è‡ªå‹•é–‰ã˜ã‚‹';
      clearInterval(countdownIntervalId);
      countdownIntervalId = null;
    }
  }, 1000);
}
```

#### 3. main.js ã¸ã®çµ±åˆ

`src/popup/main.js` ã®è¨˜éŒ²æˆåŠŸå‡¦ç†ï¼ˆ120-126è¡Œç›®ã‚ãŸã‚Šï¼‰ã«è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã®èµ·å‹•ã‚’è¿½åŠ ï¼š

```javascript
if (result.success) {
  hideSpinner();
  statusDiv.textContent = 'âœ“ Obsidianã«ä¿å­˜ã—ã¾ã—ãŸ';
  statusDiv.className = 'success';

  // è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
  startAutoCloseTimer();
} else {
  throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
```

---

## å“è³ªåˆ¤å®šçµæœ

### âœ… é«˜å“è³ª

- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**: å®Ÿè¡Œå¯èƒ½ã§å¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿ï¼ˆã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’importã—ã¦ã„ã‚‹ãŸã‚ï¼‰
- **æœŸå¾…å€¤**: æ˜ç¢ºã§å…·ä½“çš„ï¼ˆå„ãƒ†ã‚¹ãƒˆã§æœŸå¾…ã™ã‚‹å‹•ä½œãŒæ˜è¨˜ï¼‰
- **ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³**: é©åˆ‡ï¼ˆtoBe, toHaveBeenCalled, toContainãªã©é©åˆ‡ã«ä½¿ç”¨ï¼‰
- **å®Ÿè£…æ–¹é‡**: æ˜ç¢ºï¼ˆGreenãƒ•ã‚§ãƒ¼ã‚ºã¸ã®è¦æ±‚äº‹é …ã‚’è©³ç´°ã«è¨˜è¿°ï¼‰

### åˆ¤å®šç†ç”±
1. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ç¶²ç¾…
2. å„ãƒ†ã‚¹ãƒˆã«æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆã§ç›®çš„ãƒ»å†…å®¹ãƒ»æœŸå¾…å‹•ä½œã‚’æ˜è¨˜
3. ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ï¼ˆğŸŸ¢ğŸŸ¡ğŸ”´ï¼‰ã‚’ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«è¨˜è¿°
4. Greenãƒ•ã‚§ãƒ¼ã‚ºã§ã®å®Ÿè£…æ–¹é‡ãŒå…·ä½“çš„ã‹ã¤å®Ÿè¡Œå¯èƒ½
5. æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆmainSpinner.test.jsï¼‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ã—ä¸€è²«æ€§ç¢ºä¿

---

## TODOæ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

- ç¾åœ¨ã®TODOã€ŒRedãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå¤±æ•—ãƒ†ã‚¹ãƒˆä½œæˆï¼‰ã€ã‚’ã€Œcompletedã€ã«ãƒãƒ¼ã‚¯
- å¤±æ•—ãƒ†ã‚¹ãƒˆä½œæˆãƒ•ã‚§ãƒ¼ã‚ºã®å®Œäº†ã‚’TODOå†…å®¹ã«åæ˜ 
- å“è³ªåˆ¤å®šçµæœã‚’TODOå†…å®¹ã«è¨˜éŒ²
- æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã€ŒGreenãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæœ€å°å®Ÿè£…ï¼‰ã€ã‚’TODOã«è¿½åŠ 