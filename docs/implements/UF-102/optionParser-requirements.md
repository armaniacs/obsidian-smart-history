# UF-102: uBlockオプション解析実装 - TDD要件定義

## 作成情報

- **機能名**: uBlockオプション解析実装
- **TDDタスクID**: UF-102
- **作成日**: 2026-01-24
- **現在のフェーズ**: Requirements

---

## 1. 機能の概要

### 信頼性レベル: 🟢 青信号

- EARS要件定義書: 存在しない（uBlockインポート機能は独自実装）
- 設計文書: `plan/UII/02-phase2-parser.md`, `plan/UII/10-data-structures.md` に基づいて把握可能
- 既存実装: `src/utils/ublockParser.js` に `parseOptions` の簡易実装が存在

### ユーザーストーリー

> As a ユーザー,
> I want uBlock Origin形式のオプション（domain=、$3p、$1pなど）を正しく解析できること,
> So that EasyListなどのフィルターリストにある高度なルールも正しく扱える

### 何をする機能か

uBlock Origin形式のフィルタールールに含まれるオプション部分をパースし、内部データ構造に変換する機能です。

**主要機能**:
- `domain=` オプションのパース（複数ドメイン対応、`|`区切り）
- `~domain=` オプションのパース（否定ドメイン）
- `$3p` オプション（サードパーティのみ）
- `$1p` オプション（ファーストパーティのみ）
- `$important` オプション（重要フラグ）
- 複合オプションのパース（カンマ区切りの複数オプション）

### どのような問題を解決するか

**問題**: UF-101で実装した `parseOptions` 関数は `domain=` の最小限りのパースのみ対応しており、EasyListなどの既存フィルターリストに含まれる高度なオプションが扱えない。

**解決**:
- すべての主要uBlockオプションに対応
- 複数ドメインを`|`区切りでパース
- 論理フラグ（$3p、$1p、$important）を正しく解釈
- UF-103でのマッチング時にオプションを適用可能にする

### 想定されるユーザー

- EasyListなどの既存フィルターリストをインポートするユーザー
- 高度なブロック制御が必要なユーザー
- サードパーティリソースのみブロックしたいユーザー

### システム内での位置づけ

```
┌─────────────────────────────────────────────────────────────┐
│                  parseUblockFilterLine()                    │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  ||hostname^$options のパース                        │  │
│  │    │                                             │  │
│  │    ▼                                             │  │
│  │  $の位置検出 → optionsStringを分離               │  │
│  │    │                                             │  │
│  │    ▼                                             │  │
│  │  parseOptions(optionsString) ───────────────────→ │  │
│  │    │                                             │  │
│  │    ▼                                             │  │
│  │  UblockRuleOptionsオブジェクト生成               │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  UblockRule.options                         │
│  {                                                        │
│    domains?: string[],        // domain= 的ドメイン         │
│    negatedDomains?: string[],  // domain=~ 除外ドメイン      │
│    thirdParty?: boolean,      // $3p サードパーティのみ     │
│    firstParty?: boolean,      // $1p ファーストパーティのみ  │
│    important?: boolean        // $important 重要フラグ      │
│  }                                                        │
└─────────────────────────────────────────────────────────────┘
```

### 参照した設計文書

| 種類 | パス | 信頼性レベル |
|------|------|-------------|
| フェーズ2計画 | `plan/UII/02-phase2-parser.md` | 🟢 |
| データ構造 | `plan/UII/10-data-structures.md` | 🟢 |
| タスク定義 | `plan/TODO.md` | 🟢 |
| 既存実装 | `src/utils/ublockParser.js` | 🟢 |

### 参照したEARS要件

🔴 EARS要件定義書は存在しない

---

## 2. 入力・出力の仕様

### 信頼性レベル: 🟢 青信号

### 入力パラメータ

#### parseOptions(optionsString)

| パラメータ名 | 型 | 必須 | 説明 | デフォルト | 制約 |
|-------------|-----|------|------|---------|------|
| `optionsString` | `string` | はい | $の後のオプション文字列 | - | なし |

### 出力値

#### UblockRuleOptions

```typescript
interface UblockRuleOptions {
  /** サードパーティのみ適用 */
  thirdParty?: boolean;
  /** ファーストパーティのみ適用 */
  firstParty?: boolean;
  /** 重要フラグ（他ルールを上書き） */
  important?: boolean;
  /** $domain= 指定ドメインリスト */
  domains?: string[];
  /** $domain=~ 指定除外ドメインリスト */
  negatedDomains?: string[];
}
```

### 入出力の関係性

```
入力: "domain=example.com|test.com,3p"
    │
    ▼
parseOptions()
    │
    ├─ カンマ区切りで分割 → ["domain=example.com|test.com", "3p"]
    │
    ├─ 各トークンをパース:
    │   ├─ "domain=example.com|test.com"
    │   │   └─ domain= を削除後に | で分割
    │   │       └─ ["example.com", "test.com"]
    │   │
    │   └─ "3p"
    │       └─ booleanフラグに変換
    │
    ▼
出力: {
  domains: ['example.com', 'test.com'],
  thirdParty: true
}
```

### データフロー

```
┌─────────────────────────────────────────────────────────────┐
│              parseUblockFilterLine() 内の呼び出し           │
│                     UF-101 → UF-102への連携                │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  ||hostname^domain=example.com,3p のパース処理            │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  1. $記号の位置検存する                               │  │
│  │  2. $より前の部分 → domain = "hostname"             │  │
│  │  3. $より後の部分 → optionsStr = "domain=example.com,3p" │  │
│  │  4. parseOptions(optionsStr) を呼び出し             │  │
│  └─────────────────────────────────────────────────────┘  │
└────────────────────────┬──────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              parseOptions(optionsStr) 内部処理              │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  trim() で前後空白を除去                            │  │
│  │  空文字またはnullの場合 → 空オブジェクトを返す        │  │
│  │                                                     │  │
│  │  split(',') でカンマ区切りで分割                   │  │
│  │  各トークンをループ処理:                             │  │
│  │    ├─ token.startsWith('domain=') → domains配列    │  │
│  │    ├─ token.startsWith('~domain=') → negatedDomains │  │
│  │    ├─ token === '3p' → thirdParty = true          │  │
│  │    ├─ token === '1p' → firstParty = true          │  │
│  │    ├─ token === 'important' → important = true    │  │
│  │    └─ token === '~important' → important = false  │  │
│  └─────────────────────────────────────────────────────┘  │
└────────────────────────┬──────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     UblockRuleOptions                      │
│  {                                                       │
│    domains: ['example.com'],                            │
│    thirdParty: true                                      │
│  }                                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 制約条件

### 信頼性レベル: 🟢 青信号

### パフォーマンス要件

| 要件 | 値 | 説明 |
|------|----|------|
| 単一オプションパース | < 0.1ms | 単一オプション文字列のパース速度 |
| 複合オプションパース | < 0.5ms | 複数オプションのパース速度 |
| メモリ使用量 | 最小限 | 1ルールあたりのオーバーヘッド |

### セキュリティ要件

| 要件 | 説明 |
|------|------|
| ドメイン検証 | パースされたドメインの有効性を確認（UF-101で実装済み） |
| オプション注入防止 | 不正なオプション文字列を安全に処理 |
| エラー無視 | 不明なオプションは警告なしでスキップ |

### 互換性要件

| 要件 | 内容 |
|------|------|
| 既存parseOptionsとの互換性 | 既存の簡易実装を拡張して維持 |
| 後方互換性 | 戻り値の構造を既存のUblockRuleOptionsに合わせる |
| 既存テスト維持 | parseOptionsの簡易実装テストは引き続き合格 |

### アーキテクチャ制約

| 制約 | 内容 |
|------|------|
| 実装場所 | `src/utils/ublockParser.js` 内のexport関数 |
| 依存 | UF-101のデータ構造（UblockRuleOptions） |
| 正規表現使用可能 | カンマ区切り、パイプ区切りの分割に使用 |

---

## 4. 想定される使用例

### 信頼性レベル: 🟢 青信号

### 基本的な使用パターン

#### 使用例1: domainオプション単独

```
入力: "domain=example.com"

期待出力:
{
  domains: ['example.com']
}
```

#### 使用例2: 複数domainオプション（パイプ区切り）

```
入力: "domain=example.com|test.com|site.com"

期待出力:
{
  domains: ['example.com', 'test.com', 'site.com']
}
```

#### 使用例3: 3pオプション

```
入力: "3p"

期待出力:
{
  thirdParty: true
}
```

#### 使用例4: 1pオプション

```
入力: "1p"

期待出力:
{
  firstParty: true
}
```

#### 使用例5: importantオプション

```
入力: "important"

期待出力:
{
  important: true
}
```

#### 使用例6: 複合オプション（カンマ区切り）

```
入力: "domain=example.com,3p"

期待出力:
{
  domains: ['example.com'],
  thirdParty: true
}
```

#### 使用例7: 否定domainオプション

```
入: "domain=~trusted.com|safe.com"

期待出力:
{
  negatedDomains: ['trusted.com', 'safe.com']
}
```

### エッジケース

#### エッジケース1: オプションなし

```
入力: "" または null

期待挙動:
- 空オブジェクト {} を返す
- エラーをスローしない
```

#### エッジケース2: 重要フラグの解除

```
入力: "~important"

期待挙動:
- important: false を返す
```

#### エッジケース3: 不明なオプション（安全なスキップ）

```
入力: "unknown_option"

期待挙動:
- 不明なオプションは無視
- エラーをスローしない
- 空オブジェクト {} を返す
```

#### エッジケース4: 複合重要オプション

```
入力: "domain=example.com,important,BADSTRING,3p"

期待挙動:
- BADSTRINGは無視
- 有効なオプションのみパース
```

### エラーケース

#### エラーケース1: 空のdomainオプション

```
状況: "domain="（ドメインなし）

挙動:
- 不明なオプションとして扱う
- domainsプロパティは生成されない
```

#### エラーケース2: 不正な形式

```
状況: "domain=example.com,test.com"（カンマ区切りでない）

挙動:
- test.comは無視
- パイプ区切りのみ正しく処理
```

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

```markdown
> As a ユーザー,
> I want uBlock Origin形式のオプション（domain=、$3p、$1pなど）を正しく解析できること,
> So that EasyListなどのフィルターリストにある高度なルールも正しく扱える
```

### 参照した設計文書

| 種類 | パス | 信頼性レベル |
|------|------|-------------|
| フェーズ2計画 | `plan/UII/02-phase2-parser.md` | 🟢 |
| データ構造 | `plan/UII/10-data-structures.md` | 🟢 |
| タスク定義 | `plan/TODO.md` | 🟢 |
| 既存実装 | `src/utils/ublockParser.js` | 🟢 |

### 要件カバレッジ表

| 要件ID | ステータス | 内容 |
|--------|-----------|------|
| UF-102-1 | 未 | parseOptions関数の拡張 |
| UF-102-2 | 未 | domain=オプションのパース |
| UF-102-3 | 未 | ~domain=オプションのパース |
| UF-102-4 | 未 | $3pオプションのパース |
| UF-102-5 | 未 | $1pオプションのパース |
| UF-102-6 | 未 | $importantオプションのパース |
| UF-102-7 | 未 | 複合オプションのパース |

---

## 6. 実装優先度と判断基準

### 必須実装（P0）

1. **domain=オプションパース**
   - 単一ドメイン対応
   - 複数ドメイン対応（`|`区切り）

2. **~domain=オプションパース**
   - 否定ドメイン対応

3. **基本論理フラグ**
   - `$3p` → thirdParty
   - `$1p` → firstParty

### 推奨実装（P1）

4. **importantフラグ**
   - `$important` → important = true
   - `~important` → important = false

### オプション（P2）

5. **不明オプションの安全スキップ**
   - 不明なトークンを警告なしで無視

---

## 7. 未決定事項・懸念点

| 項目 | 内容 | 判断基準 |
|------|------|----------|
| 既存parseOptionsとの置き換え | 完全に置き換えるか拡張するか | 既存テスト合格を優先して拡張実装 |
| エラーハンドリング | 不明なオプションに対する処理 | 記述方針に基づき安全スキップを採用 |
| ドメイン検証 | パース後にドメインの有効性チェック |UF-101で実装済みなのでここでは不要 |

---

## 8. テスト戦略

### テスト可能な単位

1. **単体テスト（Jest）**
   - parseOptions() テスト
   - 各オプションごとのパース確認
   - 複合オプションのパース確認

### テスト不可・検証困難な項目

- オプション適用ロジック → UF-103で実装後に検証

---

## 品質判定結果

### ✅ 高品質

- **要件の曖昧さ**: なし（計画ドキュメントが詳細）
- **入出力定義**: 完全（型定義あり）
- **制約条件**: 明確
- **実装可能性**: 確実（拡張のみの実装）

### 判定理由

- `plan/UII/02-phase2-parser.md` に詳細なパースロジックが記載されている
- `plan/UII/10-data-structures.md` に完全な型定義（UblockRuleOptions）が記載されている
- 既存の`ublockParser.js`に`parseOptions`の簡易実装があるため、拡張のみで確実
- 計画ドキュメントに8つのテストケースが明記されている

---

## 次のステップ

**推奨コマンド**: `/tdd-testcases` でテストケースの洗い出しを行います。

テストケースでは以下を網羅します：
1. domain=オプション（単一/複数）
2. ~domain=（否定オプション）
3. $3p/$1p（サード/ファーストパーティ）
4. $important（重要フラグ）
5. 複合オプション（カンマ区切り）
6. エッジケース（空文字、不明オプション）