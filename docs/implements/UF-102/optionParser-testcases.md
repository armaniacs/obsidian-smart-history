# UF-102: uBlockオプション解析実装 - テストケース洗い出し

## 作成情報

- **作成日**: 2026-01-24
- **担当フェーズ**: Testcases
- **前のフェーズ**: Requirements

## テスト開発コンテキスト

### 開発コンテキスト情報

- **対象機能**: uBlockオプション解析実装（parseOptions関数の拡張）
- **現在のTDDフェーズ**: Testcases
- **前回の完了フェーズ**: Requirements（要件定義完了）
- **今回の実行予定**: Redフェーズ（失敗テスト実装）

### 要件・仕様情報

**機能概要**: uBlock Origin形式のフィルターオプションをパースし、内部データ構造に変換

**入力仕様**:
- `parseOptions(optionsString)`: オプション文字列（`string`）

**出力仕様**:
- `UblockRuleOptions`: オプションオブジェクトクト/否定/フラグ）

**サポートオプション**:
- `domain=` - 許可ドメイン指定
- `~domain=` - 除外ドメイン指定
- `3p` - サードパーティのみ
- `1p` - ファーストパーティのみ
- `important` - 重要フラグ
- `~important` - 重要フラグ解除

**制約条件**:
- 既存parseOptionsとの後方互換性を維持
- 不明なオプションは警告なしでスキップ

### 技術情報

- **プログラミング言語**: JavaScript (ES Modules)
- **テストフレームワーク**: Jest
- **テスト対象ファイル**: `src/utils/ublockParser.test.js`（既存ファイルに追加）

---

## テストケース一覧

### 合計: 11テスト（正常系: 6 / 異常系: 2 / エッジケース: 3）

---

## 1. 正常系テストケース

#### テスト 1: 単一domainオプション

- **テスト名**: domainオプション単独のパース
- **何をテストするか**: `domain=` オプションを使用して単一ドメインを正しくパースできることを確認
- **期待される動作**: `"domain=example.com"` を入力すると、`domains=['example.com']` が設定されたオブジェクトが返される
- **入力値**: `"domain=example.com"`
  - **入力データの意味**: 最も基本的なdomainオプションパターン
- **期待される結果**:
  ```javascript
  {
    domains: ['example.com']
  }
  ```
  - **期待結果の理由**: `domain=` プレフィックスを削除し、ドメイン値を配列として正しく抽出すべき
- **テストの目的**: domainオプションの基本機能確認
  - **確認ポイント**: プレフィックス削除後のドメイン値が正しく配列に格納されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 2: 複数domainオプション（パイプ区切り）

- **テスト名**: 複数のドメインを含むdomainオプションのパース
- **何をテストするか**: `|` 区切りで複数のドメインを指定したオプションを正しくパースできることを確認
- **期待される動作**: `"domain=example.com|test.com|sample.com"` を入力すると、すべてのドメインを含む配列が設定される
- **入力値**: `"domain=example.com|test.com|sample.com"`
  - **入力データの意味**: 複数のドメインを1つのルールで設定する一般的なパターン
- **期待される結果**:
  ```javascript
  {
    domains: ['example.com', 'test.com', 'sample.com']
  }
  ```
  - **期待結果の理由**: uBlock標準の `|` 区切りでドメインを分割して配列化すべき
- **テストの目的**: パイプ区切りの複数ドメイン対応確認
  - **確認ポイント**: 各ドメインが正しく分割され、配列要素として格納されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 3: 3pオプション

- **テスト名**: サードパーティオプションのパース
- **何をテストするか**: `$3p` オプションを正しく論理フラグに変換できることを確認
- **期待される動作**: `"3p"` を入力すると、`thirdParty=true` が設定されたオブジェクトが返される
- **入力値**: `"3p"`
  - **入力データの意味**: サードパーティリソースのみにルールを適用するオプション
- **期待される結果**:
  ```javascript
  {
    thirdParty: true
  }
  ```
  - **期待結果の理由**: `$3p` 文字列を論理フラグに変換すべき
- **テストの目的**: 論理フラグオプションの基本機能確認
  - **確認ポイント**: フラグがboolean値として正しく設定されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 4: 1pオプション

- **テスト名**: ファーストパーティオプションのパース
- **何をテストするか**: `$1p` オプションを正しく論理フラグに変換できることを確認
- **期待される動作**: `"1p"` を入力すると、`firstParty=true` が設定されたオブジェクトが返される
- **入力値**: `"1p"`
  - **入力データの意味**: ファーストパーティリソースのみにルールを適用するオプション
- **期待される結果**:
  ```javascript
  {
    firstParty: true
  }
  ```
  - **期待結果の理由**: `$1p` 文字列を論理フラグに変換すべき
- **テストの目的**: 論理フラグオプションの基本機能確認
  - **確認ポイント**: フラグがboolean値として正しく設定されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 5: importantオプション

- **テスト名**: 重要フラグオプションのパース
- **何をテストするか**: `$important` オプションを正しく論理フラグに変換できることを確認
- **期待される動作**: `"important"` を入力すると、`important=true` が設定されたオブジェクトが返される
- **入力値**: `"important"`
  - **入力データの意味**: 他のルールを上書きする重要フラグ
- **期待される結果**:
  ```javascript
  {
    important: true
  }
  ```
  - **期待結果の理由**: `$important` 文字列を論理フラグに変換すべき
- **テストの目的**: 重要フラグオプションの基本機能確認
  - **確認ポイント**: フラグがboolean値として正しく設定されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/10-data-structures.md` に記載されるデータ構造 |

---

#### テスト 6: 複合オプション（カンマ区切り）

- **テスト名**: 複数のオプションを組み合わせたパース
- **何をテストするか**: カンマ区切りで複数のオプションを指定した場合に、すべてのオプションが正しくパースできることを確認
- **期待される動作**: `"domain=example.com,3p,important"` を入力すると、すべてのオプションが設定されたオブジェクトが返される
- **入力値**: `"domain=example.com,3p,important"`
  - **入力データの意味**: 実運用で頻繁に使用される複合オプションのパターン
- **期待される結果**:
  ```javascript
  {
    domains: ['example.com'],
    thirdParty: true,
    important: true
  }
  ```
  - **期待結果の理由**: 各オプションが正しく解析され、対応するプロパティに設定されるべき
- **テストの目的**: 複合オプション対応の確認
  - **確認ポイント**: 各トークンが正しく解析され、同じオプションプロパティが設定されないこと

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される機能 |

---

## 2. 異常系テストケース

#### テスト 7: 不明なオプションはスキップされる

- **テスト名**: 不明なオプション文字列は安全にスキップされる
- **エラーケースの概要**: 知らないオプション文字列が渡された場合、システムがクラッシュすることなく安全に処理できるか
- **エラー処理の重要性**: 不明なオプションを無視することで、新しいuBlock機能追加時にも既存コードが破壊されない
- **入力値**: `"unknown_option"`
  - **不正な理由**: 未定義のオプション文字列
  - **実際の発生シナリオ**: ユーザーが誤って入力、または将来のuBlock機能拡張時
- **期待される結果**: `{}`
  - **エラーメッセージの内容**: エラーはスローされず、サイレントにスキップ
  - **システムの安全性**: 不明なオプションにより処理が中断されない
- **テストの目的**: 頑健性確認
  - **品質保証の観点**: 不明なオプションがシステム安定性を損なわないことを保証

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される安全スキップ要件 |

---

#### テスト 8: 空のdomainオプションはスキップされる

- **テスト名**: 値がないdomainオプションは安全にスキップされる
- **エラーケースの概要**: `domain=` のように値がないオプションが渡された場合の挙動を確認
- **エラー処理の重要性**: 不完全なオプション仕様に対する防御的プログラミング
- **入力値**: `"domain="`
  - **不正な理由**: ドメイン値が指定されていない不完全なオプション
  - **実際の発生シナリオ**: スクリプト生成ミスやユーザー入力エラー
- **期待される結果**: `{}`
  - **エラーメッセージの内容**: エラーはスローされず、不完全なオプションは無視
  - **システムの安全性**: 不完全なオプションにより処理が中断されない
- **テストの目的**: 不完全入力に対する頑健性確認
  - **品質保証の観点**: 不完全な形式でもシステムが正常に動作することを保証

| 信頼性レベル | 内容 |
|-----------|------|
| 🟡 | 不完全な形式の安全なスキップから妥当な推測 |

---

## 3. エッジケース（境界値・特殊ケース）

#### テスト 9: 重要フラグの解除（~important）

- **テスト名**: 重要フラグの解除オプションのパース
- **エッジケースの意味**: `~important` で重要フラグを明示的に解除できることを確認
- **入力値**: `"~important"`
  - **入力データの意味**: 親ルールで設定されたimportantフラグを解除する特殊構文
- **期待される動作**: `important: false` が設定される
- **信頼性レベル**: 🟡 - `plan/UII/02-phase2-parser.md` には明記がないが、uBlock標準として妥当
- **パターン検証**: `~` プレフィックスで否定フラグを設定する動作
- **システム安全性**: 重要フラグの明示的な解除を行うことで予期せぬ動作を防止

---

#### テスト 10: 否定domainオプション（~domain=）

- **テスト名**: 除外ドメインオプションのパース
- **エッジケースの意味**: `~domain=` で特定ドメインをルール適用から除外する機能を確認
- **入力値**: `"domain=~trusted.com|safe.com"`
  - **入力データの意味**: 指定ドメインでのみルールを適用しない設定
- **期待される動作**: `negatedDomains: ['trusted.com', 'safe.com']` が設定される
- **信頼性レベル**: 🟢 - `plan/UII/10-data-structures.md` に記載されるデータ構造
- **パターン検証**: `~domain=` プレフィックスと `|` 区切りの正確なパース
- **システム安全性**: 除外ドメインリストを正しく適用することによる誤ブロック防止

---

#### テスト 11: 複合オプションに不明なトークンを含む場合

- **テスト名**: 有効なオプションと不明なトークンが混在した場合のパース
- **エッジケースの意味**: 有効オプション間に不明なトークンが混入しても妥当なオプションが正しくパースされることを確認
- **入力値**: `"domain=example.com,important,BADSTRING,3p"`
  - **入力データの意味**: 実運用で発生しうる典型的な混在パターン
- **期待される動作**: `BADSTRING` はスキップされ、有効なオプションのみがパースされる
- **信頼性レベル**: 🟢 - 頑健性確保のための安全スキップ戦略
- **パターン検証**: 不明なトークンを無視しつつ有効オプションを正しく処理
- **システム安全性**: 不明なトークンにより有効なオプションが失われないように安全スキップ

---

## 実装に関する情報

### プログラミング言語

- **言語**: JavaScript (ES Modules)
  - **言語選択の理由**: プロジェクト全体がJavaScriptで記述されており、既存`ublockParser.js`との統合が容易
  - **テストに適した機能**:動的型システムにより柔軟なテスト記述が可能、Jestのモック機能が充実

### テストフレームワーク

- **フレームワーク**: Jest
  - **フレームワーク選択の理由**: プロジェクトで既に使用されているテストフレームワーク、UF-101とのテスト環境統一
  - **テスト実行環境**: Node.js環境、`npm test` で実行可能

### テスト対象ファイル

- **既存テストファイル**: `src/utils/__tests__/ublockParser.test.js`
  - 既存の `describe('ヘルパー関数 - parseOptions')` にテストを追加

---

## テストケース追加計画

### 既存テストとの整合性

UF-101で既に実装されているparseOptionsテスト：

| 既存テスト | 内容 | 拡張との関係 |
|-----------|------|-------------|
| オプションなしのルールは空オブジェクトを返す | 空文字入力 → `{}` | 維続して合格させる |
| domainオプションをパースできる | `"domain=example.com"` → `{domains: ['example.com']}` | 拡張して詳細化 |

### UF-102で追加するテスト

| テスト番号 | カテゴリ | 既存/新規 |
|-----------|---------|----------|
| 1 | 正常系（domain単一） | 拡張（既存テストの詳細化） |
| 2 | 正常系（domain複数） | 新規 |
| 3 | 正常系（3p） | 新規 |
| 4 | 正常系（1p） | 新規 |
| 5 | 正常系（important） | 新規 |
| 6 | 正常系（複合） | 新規 |
| 7 | 異常系（不明オプション） | 新規 |
| 8 | 異常系（空domain） | 新規 |
| 9 | エッジ（~important） | 新規 |
| 10 | エッジ（~domain=） | 新規 |
| 11 | エッジ（不明トークン混在） | 新規 |

---

## 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系（6）/ 異常系（2）/ エッジケース（3）で網羅完了
- **期待値定義**: 各テストケースの期待値が明確
- **技術選択**: JavaScript + Jest は既存プロジェクトから確定
- **実装可能性**: 確実（拡張実装のみ、新規ファイル作成不要）

### 判定理由

- `plan/UII/02-phase2-parser.md` に詳細なパースロジックとテストケース例が記載されている
- `plan/UII/10-data-structures.md` に完全な型定義（UblockRuleOptions）が記載されている
- 既存の `ublockParser.js` に `parseOptions` の簡易実装があり、拡張のみで対応可能
- 正常系・異常系・エッジケースのバランスが適切
- 既存テストとの後方互換性を考慮済み

---

## 参照した設計文書

| 種類 | 信頼性レベル |
|------|-------------|
| `plan/UII/02-phase2-parser.md` | 🟢 |
| `plan/UII/10-data-structures.md` | 🟢 |
| `src/utils/__tests__/ublockParser.test.js` | 🟢 |
| `docs/implements/UF-102/optionParser-requirements.md` | 🟢 |

---

## 要件網羅率

| カテゴリ | テスト数 | カバー率 |
|--------|--------|--------|
| domain=オプション（単一） | 1 | 100% |
| domain=オプション（複数） | 1 | 100% |
| ~domain=オプション | 1 | 100% |
| $3pオプション | 1 | 100% |
| $1pオプション | 1 | 100% |
| importantオプション | 2 | 100% |
| 複合オプション | 1 | 100% |
| 不明なオプション | 1 | 100% |

---

## 次のステップ

**推奨コマンド**: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

Redフェーズでは以下を実行します：
1. `src/utils/__tests__/ublockParser.test.js` の `describe('ヘルパー関数 - parseOptions')` に拡張テストを追加
2. 11テストケースの実装（既存2テストは維持、新規テストを追加）
3. 実装していない機能を呼び出す形でテストを作成
4. `npm test` で全テストが失敗していることを確認