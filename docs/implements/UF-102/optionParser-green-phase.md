## Greenãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæœ€å°å®Ÿè£…ï¼‰

### å®Ÿè£…æ—¥æ™‚

2026-01-24

### å®Ÿè£…æ–¹é‡

parseOptionsé–¢æ•°ã‚’æ‹¡å¼µã—ã¦ã€uBlock Originå½¢å¼ã®ä¸»è¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦ã‚µãƒãƒ¼ãƒˆã™ã‚‹å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚

**å®Ÿè£…åŸå‰‡**:
- ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ†å‰²ã—ã€å„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å€‹åˆ¥ã«å‡¦ç†
- æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆ3ä»¶ï¼‰ã¨ã®å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒ
- ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¨ãƒ­ãƒ¼ãƒ­ã‚°ãªã—ï¼‰
- å˜ä¸€è²¬ä»»åŸå‰‡ã«åŸºã¥ãåˆ†ã‹ã‚Šã‚„ã™ã„å®Ÿè£…

### å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```javascript
/**
 * ãƒ«ãƒ¼ãƒ«ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’ãƒ‘ãƒ¼ã‚¹
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: uBlock Originå½¢å¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›
 * ã€å®Ÿè£…æ–¹é‡ã€‘: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ†å‰²ã—ã€å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã”ã¨ã«é©åˆ‡ã«å‡¦ç†
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: UF-102ã®11ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å¯¾å¿œï¼ˆæ­£å¸¸ç³»6/ç•°å¸¸ç³»2/ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹3ï¼‰
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: plan/UII/02-phase2-parser.md ãŠã‚ˆã³ uBlock Originæ¨™æº–æ§‹æ–‡ã«åŸºã¥ãå®Ÿè£…
 */
export function parseOptions(optionsString) {
  // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefined/ç©ºæ–‡å­—ã®å ´åˆã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ ğŸŸ¢
  if (!isValidString(optionsString) || optionsString.trim() === '') {
    return {};
  }

  // ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æã€‘: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ†å‰²ã—ã¦å€‹åˆ¥ã«ãƒ‘ãƒ¼ã‚¹ ğŸŸ¢
  const result = {};
  const trimmed = optionsString.trim();
  const optionTokens = trimmed.split(',');

  // ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ãƒ«ãƒ¼ãƒ—ã€‘: å„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†ã—ã¦å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®š ğŸŸ¢
  for (const token of optionTokens) {
    const processed = token.trim();

    // ã€ç©ºç™½ãƒˆãƒ¼ã‚¯ãƒ³ã‚¹ã‚­ãƒƒãƒ—ã€‘: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— ğŸŸ¢
    if (processed === '') {
      continue;
    }

    // ã€domainã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã€‘: `domain=` ã¾ãŸã¯ `domain=~` å½¢å¼ã®ãƒ‘ãƒ¼ã‚¹ ğŸŸ¢
    if (processed.startsWith('domain=')) {
      const domainValue = processed.substring(7); // `domain=` ä»¥é™ã‚’æŠ½å‡º

      // ã€ç©ºãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¹ã‚­ãƒƒãƒ—ã€‘: å€¤ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— ğŸŸ¢
      if (domainValue === '') {
        continue;
      }

      // ã€é™¤å¤–ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¤å®šã€‘: `~` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§é™¤å¤–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦å‡¦ç† ğŸŸ¢
      if (domainValue.startsWith('~')) {
        const negatedList = domainValue.substring(1); // `~` ä»¥é™ã‚’æŠ½å‡º
        const negatedDomains = negatedList.split('|').filter(d => d !== '');
        if (negatedDomains.length > 0) {
          result.negatedDomains = negatedDomains;
        }
      } else {
        // ã€è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³å‡¦ç†ã€‘: `|` åŒºåˆ‡ã‚Šã§è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’åˆ†å‰² ğŸŸ¢
        const domains = domainValue.split('|').filter(d => d !== '');
        if (domains.length > 0) {
          result.domains = domains;
        }
      }
    }

    // ã€3pã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã€‘: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’è¨­å®š ğŸŸ¢
    else if (processed === '3p') {
      result.thirdParty = true;
    }

    // ã€1pã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã€‘: ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’è¨­å®š ğŸŸ¢
    else if (processed === '1p') {
      result.firstParty = true;
    }

    // ã€importantã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã€‘: é‡è¦ãƒ•ãƒ©ã‚°ã‚’è¨­å®š ğŸŸ¢
    else if (processed === 'important') {
      result.important = true;
    }

    // ã€~importantã‚ªãƒ—ã‚·ãƒ§ãƒ³å‡¦ç†ã€‘: é‡è¦ãƒ•ãƒ©ã‚°ã‚’è§£é™¤ ğŸŸ¡
    else if (processed === '~important') {
      result.important = false;
    }

    // ã€ä¸æ˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—ã€‘: ä¸Šè¨˜ä»¥å¤–ã¯å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ— ğŸŸ¢
    // ã€æ³¨è¨˜ã€‘ï¼šã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚„è­¦å‘Šã¯å‡ºã•ãšã€é™ã‹ã«å‡¦ç†ç¶™ç¶š
  }

  return result;
}
```

### ãƒ†ã‚¹ãƒˆçµæœ

```
Test Suites: 1 passed, 1 total
Tests:       39 passed, 39 total
Time:        0.467 s
```

**åˆæ ¼ç‡**: 100% (39/39)

**parseOptionsãƒ†ã‚¹ãƒˆçµæœ**:
- æ—¢å­˜ãƒ†ã‚¹ãƒˆ: 3/3 é€šéï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
- æ–°è¦ãƒ†ã‚¹ãƒˆ: 9/9 é€šé

### ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | å…¥åŠ›ä¾‹ | å‡ºåŠ› | ä¿¡é ¼æ€§ |
|----------|--------|------|--------|
| domain= | `domain=example.com` | `domains: ['example.com']` | ğŸŸ¢ |
| domain=(è¤‡æ•°) | `domain=a.com\|b.com\|c.com` | `domains: ['a.com', 'b.com', 'c.com']` | ğŸŸ¢ |
| ~domain= | `domain=~trusted.com\|safe.com` | `negatedDomains: ['trusted.com', 'safe.com']` | ğŸŸ¢ |
| 3p | `3p` | `thirdParty: true` | ğŸŸ¢ |
| 1p | `1p` | `firstParty: true` | ğŸŸ¢ |
| important | `important` | `important: true` | ğŸŸ¢ |
| ~important | `~important` | `important: false` | ğŸŸ¡ |
| è¤‡åˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `domain=a.com,3p,important` | ã™ã¹ã¦è¨­å®š | ğŸŸ¢ |
| ä¸æ˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | `unknown` | `: {}` | ğŸŸ¢ |
| æ··åœ¨æœ‰åŠ¹/ä¸æ˜ | `domain=a.com,important,BAD,3p` | `BAD`ã®ã¿ã‚¹ã‚­ãƒƒãƒ— | ğŸŸ¢ |

### èª²é¡Œãƒ»æ”¹å–„ç‚¹ï¼ˆRefactorãƒ•ã‚§ãƒ¼ã‚ºã§å¯¾å¿œï¼‰

**æ½œåœ¨çš„ãªæ”¹å–„ç‚¹**:
1. **ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã®å®šæ•°åŒ–**: domain=ã€3pã€1pã€importantç­‰ã®æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã‚’å®šæ•°åŒ–å¯èƒ½
2. **ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°åˆ†å‰²**: domain= ã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç‹¬ç«‹ã—ãŸé–¢æ•°ã«åˆ†å‰²å¯èƒ½
3. **æ­£è¦è¡¨ç¾ã®æœ€é©åŒ–**: å¤šæ•°ã®startsWithå‘¼ã³å‡ºã—ã‚’æ­£è¦è¡¨ç¾ã«çµ±åˆå¯èƒ½
4. **JSDocã®è©³ç´°åŒ–**: å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ›´ãªã‚‹è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ 

**ç¾åœ¨ã®çŠ¶æ…‹**:
- âœ… å…¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ
- âœ… å¾Œæ–¹äº’æ›æ€§ãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹
- âœ… ã‚³ãƒ¼ãƒ‰ã¯ç›´æ„Ÿçš„ã§ç†è§£ã—ã‚„ã™ã„
- âš ï¸ Refactorãƒ•ã‚§ãƒ¼ã‚ºã§ã•ã‚‰ãªã‚‹å“è³ªå‘ä¸ŠãŒå¯èƒ½

---

## Refactorãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå“è³ªæ”¹å–„ï¼‰

æœªå®Ÿæ–½

---

## Verifyãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå®Œå…¨æ€§æ¤œè¨¼ï¼‰

æœªå®Ÿæ–½