# テストケース定義書: UF-403 ローディングスピナー追加

## プロジェクト情報

- **タスクID**: UF-403
- **プロジェクト名**: Obsidian Smart History
- **対象モジュール**: `src/popup/main.js`, `src/popup/popup.html`
- **作成日**: 2026-01-23
- **フェーズ**: TDD TestCases（テストケース洗い出し）

---

## 📋 開発コンテキスト情報

### 🎯 現在のフェーズ・状況
- **タスク名**: UF-403 ローディングスピナー追加
- **プロジェクト種別**: Chrome拡張機能（Manifest V3）
- **現在のTDDフェーズ**: TestCases（テストケース洗い出し）
- **前回の完了フェーズ**: Requirements（要件定義完了）
- **今回の実行予定**: ローディングスピナー機能のテストケース定義

### 📄 要件・仕様情報
- **機能概要**: 記録処理中表示時にSVGアニメーションスピナーを表示
- **主要機能**:
  1. `showSpinner(text)` - スピナー表示とテキスト更新
  2. `hideSpinner()` - スピナー非表示
  3. 処理状況に応じたテキスト更新（処理中→コンテンツ取得中→保存中）
  4. 成功・エラー時のスピナー非表示

- **入出力仕様**:
  - 入力: forceフラグ（boolean）
  - 出力: スピナー表示状態、処理状況テキスト

- **受け入れ基準**:
  - AC-1: 記録ボタン押下後、スピナーが表示される
  - AC-2: スピナーは60fpsで滑らかに回転する
  - AC-3: 処理状況に応じてテキストが更新される
  - AC-4: 成功時、スピナーが非表示になり成功メッセージが表示される
  - AC-5: エラー時、スピナーが非表示になりエラーメッセージが表示される
  - AC-6: 強制記録ボタン押下時もスピナーが正常に表示される
  - AC-7: 二重処理が発生しない

### 🧪 テスト情報
- **予定テストケース総数**: 12個
  - 正常系: 7個（スピナー表示・非表示基本機能、テキスト更新、統合動作）
  - 異常系: 3個（エラー時の非表示、DOMエラー、例外発生時）
  - 境界値: 2個（即時完了時のフラッシュ防止、連続操作時の挙動）
- **実装済みテスト**: 0個（本機能は新規実装）
- 🟡 **黄信号**: 新規実装機能のため、実装挙動に基づき調整の可能性あり

### 🔧 技術・実装情報
- **使用言語**: JavaScript（ES2022+）
- **テストフレームワーク**: Jest（既に導入済み）
- **使用環境**: jsdom（DOM操作のテスト用）
- **既存実装パターン**:
  - `src/popup/main.js` - `recordCurrentPage()`関数
  - `src/popup/popup.html` - ポップアップUI
- 🟢 **青信号**: 既存コードベースとJestフレームワークの構成が確認済み

---

## 📦 開発言語・フレームワーク

### プログラミング言語
- **言語**: JavaScript (ES2022+)
- **言語選択の理由**:
  - 既存コードベースがJavaScriptで記述されている
  - Chrome拡張機能のエコシステムと完全互換
  - DOM操作関数の実装に適している
- **テストに適した機能**:
  - DOM要素の操作と検証
  - 非同期処理（async/await）のテスト
  - jsdomによるブラウザ環境シミュレーション
- 🟢 **青信号**: 既存コードベースと完全一致

### テストフレームワーク
- **テストフレームワーク**: **Jest** (既導入済み)
- **フレームワーク選択の理由**:
  - 既にpackage.jsonに設定済み（test: 2.1.1）
  - jsdom環境を既に構築済み
  - DOM要素のテストに適している
- **テスト実行環境**:
  - Node.js環境（jsdom使用）
  - Chrome拡張API用のmock/stubを使用
- 🟢 **青信号**: プロジェクトで既に導入済み

---

## 🧪 テストケース定義

### 1. `main.js` スピナー制御関数のテストケース

対象ファイル: `src/popup/main.js` (新規実装)

#### 1-1. 正常系テストケース

##### テスト1-1-1: showSpinner - 基本的な表示
- **テスト名**: showSpinner()呼び出しでスピナー要素が表示される
  - **何をテストするか**: showSpinner関数がスピナー要素を表示する基本機能
  - **期待される動作**: displayがnoneからflexに変更され、スピナーが表示される
- **入力値**: `"処理中..."`
  - **入力データの意味**: デフォルトの処理状況テキスト
- **期待される結果**:
  - `spinner.style.display === 'flex'`
  - `spinnerText.textContent === '処理中...'`
  - **期待結果の理由**: showSpinner関数は要素を表示し、テキストを設定する
- **テストの目的**: 基本的なスピナー表示機能の確認
  - **確認ポイント**: displayプロパティとtextContentの正しい設定
- 🟢 **青信号**: 要件定義（186-196行目）に基づき仕様が明確

##### テスト1-1-2: showSpinner - テキスト更新
- **テスト名**: showSpinner()でテキスト引数を渡して表示テキストを更新できる
  - **何をテストするか**: showSpinner(text)引数によるテキスト更新機能
  - **期待される動作**: スピナーの横に表示されるテキストが引数の値になる
- **入力値**: `"コンテンツ取得中..."`
  - **入力データの意味**: 処理段階に応じた異なるテキストのテスト
- **期待される結果**:
  - `spinnerText.textContent === 'コンテンツ取得中...'`
  - `spinner.style.display === 'flex'`
  - **期待結果の理由**: 処理状況に応じて表示テキストが変わる仕様
- **テストの目的**: テキスト更新機能の確認
  - **確認ポイント**: 引数が正しくtextContentに反映されること
- 🟢 **青信号**: 要件定義（7.3節）でAPI仕様が明確

##### テスト1-1-3: showSpinner - デフォルト引数
- **テスト名**: showSpinner()引数省略時はデフォルトテキストが表示される
  - **何をテストするか**: デフォルト引数 `text = '処理中...'` の動作
  - **期待される動作**: 引数を省略しても'処理中...'が表示される
- **入力値**: `undefined`（引数省略）
  - **入力データの意味**: 呼び出し元でテキストを指定しないケース
- **期待される結果**:
  - `spinnerText.textContent === '処理中...'`
  - **期待結果の理由**: デフォルト引数により省略時も適切なテキストが表示される
- **テストの目的**: デフォルト引数の動作確認
  - **確認ポイント**: 引数がなくてもデフォルト値が使用されること
- 🟢 **青信号**: 要件定義（191行目）でデフォルト値が仕様として定義

##### テスト1-1-4: hideSpinner - 基本的な非表示
- **テスト名**: hideSpinner()呼び出しでスピナー要素が非表示になる
  - **何をテストするか**: hideSpinner関数によるスピナー非表示機能
  - **期待される動作**: displayがflexからnoneに変更され、スピナーが消える
- **入力値**: なし（引数なし）
  - **入力データの意味**: 常に非表示のみを実行するシンプルな関数
- **期待される結果**:
  - `spinner.style.display === 'none'`
  - **期待結果の理由**: 処理完了時やエラー時にスピナーを隠す
- **テストの目的**: 基本的なスピナー非表示機能の確認
  - **確認ポイント**: displayプロパティがnoneに設定されること
- 🟢 **青信号**: 要件定義（201-204行目）に基づき仕様が明確

##### テスト1-1-5: recordCurrentPage - 記録開始時のスピナー表示
- **テスト名**: recordCurrentPage()実行開始時にスピナーが表示される
  - **何をテストするか**: recordCurrentPage関数の先頭でスピナー表示が呼ばれる統合動作
  - **期待される動作**: 記録処理開始直後にshowSpinner('処理中...')が呼ばれる
- **入力値**: `force: false`
  - **入力データの意味**: 通常の記録処理（強制記録なし）
- **期待される結果**:
  - `showSpinner()`が最初に呼ばれる
  - `spinner.style.display === 'flex'` になる
  - **期待結果の理由**: ユーザーに処理開始を伝えるため最初に表示
- **テストの目的**: recordCurrentPageとの統合動作確認
  - **確認ポイント**: 関数の先頭で適切にスピナー表示が呼ばれること
- 🟡 **黄信号**: 既存のrecordCurrentPageロジック（32-36行目）に基づく推測

##### テスト1-1-6: recordCurrentPage - 成功時のスピナー非表示
- **テスト名**: 記録成功時にスピナーが非表示になる
  - **何をテストするか**: 成功パスでのhideSpinner呼び出し
  - **期待される動作**: 結果がsuccessの場合、hideSpinner()が呼ばれる
- **入力値**: `force: false`, `result: { success: true }`
  - **入力データの意味**: 通常モードで記録が成功したケース
- **期待される結果**:
  - `result.success` true時、`hideSpinner()`が呼ばれる
  - `spinner.style.display === 'none'` になる
  - 成功メッセージが表示される
  - **期待結果の理由**: 成功時はスピナーを隠し、結果メッセージを表示する
- **テストの目的**: 成功フローの終了処理確認
  - **確認ポイント**: result.success判定後にhideSpinnerが呼ばれること
- 🟢 **青信号**: 既存main.js（274-277行目）に基づき成功時のフローが確認済み

##### テスト1-1-7: recordCurrentPage - 強制記録時のスピナー表示
- **テスト名**: 強制記録モードでもスピナーが正常に表示される
  - **何をテストするか**: force=trueの場合のスピナー表示動作
  - **期待される動作**: 強制記録フラグがあっても通常通りスピナーが表示される
- **入力値**: `force: true`
  - **入力データの意味**: ドメインブロック時に強制記録を試みるケース
- **期待される結果**:
  - `showSpinner()`が呼ばれる
  - スピナーが表示される
  - **期待結果の理由**: 強制記録でも処理中であることを示す必要がある
- **テストの目的**: 強制記録モードでのスピナー動作確認
  - **確認ポイント**: forceフラグがあってもスピナー表示ロジックに影響しないこと
- 🟡 **黄信号**: 要件定義（FR-4）に基づき挙動を推測

#### 1-2. 異常系テストケース

##### テスト1-2-1: recordCurrentPage - エラー発生時のスピナー非表示
- **テスト名**: 記録処理中にエラーが発生した場合スピナーが非表示になる
  - **エラーケースの概要**: try-catchブロックのcatchパスへの移行
  - **エラー処理の重要性**: スピナーが回り続けるバグを防ぐ
- **入力値**: `force: false`, エラー発生（例: chrome.tabs.sendMessageが失敗）
  - **不正な理由**: Content Scriptが準備できていない等
  - **実際の発生シナリオ**: ページを再読み込みした直後に記録を試みる
- **期待される結果**:
  - catchブロックに入った時点で `hideSpinner()` が呼ばれる
  - `spinner.style.display === 'none'`
  - エラーメッセージが表示される
  - **エラーメッセージの内容**: ステータスにエラー情報が表示される
  - **システムの安全性**: エラー時でもスピナーが消えることを保証
- **テストの目的**: エラーハンドリング時のスピナー制御確認
  - **品質保证の観点**: エラーフローでもUIが適切にリセットされることを保証
- 🟢 **青信号**: 既存main.js（281-283行目）のcatchブロック構造に基づく

##### テスト1-2-2: showSpinner - DOM要素が見つからない場合
- **テスト名**: loadingSpinner要素が存在しない場合のエラーハンドリング
  - **エラーケースの概要**: DOM要素取得失敗（documenet.getElementByIdがnullを返す）
  - **エラー処理の重要性**: DOMインジェクションエラーの検知
- **入力値**: "処理中..."（ただしDOM要素が存在しない状態）
  - **不正な理由**: HTML構成が壊れている、またはIDが変更されている
  - **実際の発生シナリオ**: HTML変更時にIDを更新し忘れた場合
- **期待される結果**:
  - エラーが発生するか、安全に失敗する（実装ポリシー次第）
  - **エラーメッセージの内容**: 要素が見つからないことを示すエラー、またはコンソール警告
  - **システムの安全性**: アプリケーションがクラッシュしない
- **テストの目的**: DOMエラーに対する堅牢性確認
  - **品質保证の観点**: 不正なDOM状態でもシステムが安定することを確認
- 🟡 **黄信号**: 要件定義にDOM要素存在チェックの明示なし、実装方針を確認必要

##### テスト1-2-3: recordCurrentPage - 例外発生時のスピナー非表示
- **テスト名**: catchブロック外で予期せぬ例外が発生した場合の挙動
  - **エラーケースの概要**: try-catchでキャッチされない予期せぬ例外
  - **エラー処理の重要性**: 未ハンドル例外による状態不整合の検知
- **入力値**: 予期せぬ例外発生（例: メモリ不足、同期処理での例外）
  - **不正な理由**: システムリソース不足、予期しない副作用
  - **実際の発生シナリオ**: 極端に低リソース環境、またはバグによる未ハンドル例外
- **期待される結果**:
  - 未ハンドル例外の場合、スピナーの状態は保証されない（技術的制約）
  - **システムの安全性**: 未ハンドル例外は別途エラーハンドリングで対応が必要
- **テストの目的**: 最悪ケースの挙動確認
  - **品質保证の観点**: 技術的制約と期待される挙動を明確にする
- 🔴 **赤信号**: 要件定義に未ハンドル例外の仕様記述なし、技術的検討必要

#### 1-3. 境界値・エッジケーステストケース

##### テスト1-3-1: recordCurrentPage - 即時完了時のスピナー表示フラッシュ防止
- **テスト名**: 処理が即時完了した場合にスピナーが一瞬だけ表示されない
  - **境界値の意味**: 極端に短い処理時間（数ミリ秒以下）
  - **境界値での動作保証**: 視覚的なちらつき（フラッシュ）を防止
- **入力値**: 即時完了するモック処理（0ms遅延）
  - **境界値選択の根拠**: ネットワーク高速、キャッシュヒット等の極速応答
  - **実際の使用場面**: ローカル環境でのテスト、キャッシュが効いている場合
- **期待される結果**:
  - フラッシュ防止ロジックがない場合、スピナーが一瞬だけ表示される可能性がある
  - 完了時にhideSpinnerが正常に呼ばれる
  - **境界での正確性**: 最終的にスピナーは非表示になる
  - **一貫した動作**: 即時完了でも処理フローは同じ
- **テストの目的**: 高速処理時の表示挙動確認
  - **堅牢性の確認**: 極端な条件下でもUIが破綻しないことを確認
- 🟡 **黄信号**: 要件定義にフラッシュ防止の明示なし、実装時の改善候補

##### テスト1-3-2: recordCurrentPage - 連続操作時の挙動
- **テスト名**: 処理中にユーザーが再度記録ボタンを押した場合の挙動
  - **境界値の意味**: 排他制御が必要かどうかの境界
  - **境界値での動作保証**: 二重処理を防ぐ
- **入力値**: 処理実行中に再度recordCurrentPageを呼び出す
  - **境界値選択の根拠**: ユーザーの誤操作や連打
  - **実際の使用場面**: ユーザーが記録完了前に再クリック
- **期待される結果**:
  - 既存実装ではrecordBtn.disabled設定があるため、ボタンは無効化される
  - スピナーが表示中は再実行されない
  - **境界での正確性**: 排他制御が正しく動作する
  - **一貫した動作**: 連打しても1回のみ実行
- **テストの目的**: 並列実行防止の確認
  - **堅牢性の確認**: ユーザー操作による状態不整合を防ぐことを確認
- 🟢 **青信号**: 既存実装にrecordBtn.disabledロジックがあることを確認済み（ただし実装場所を確認必要）

---

## 📝 テストケース実装時の日本語コメント例

以下は、実際にテストコードを書く際のコメント例です：

```javascript
// 【テスト目的】: showSpinner関数の基本動作確認
// 【テスト内容】: showSpinner()呼び出しによりスピナー要素が表示されることをテスト
// 【期待される動作】: displayプロパティがflexに変更され、スピナーが表示される
// 🟢 要件定義（loading-spinner-requirements.md 186-196行目）に基づき仕様が明確

describe('ローディングスピナー制御', () => {
  describe('showSpinner', () => {
    beforeEach(() => {
      // 【テスト前準備】: DOM要素のモックを設定
      // 【環境初期化】: テスト環境をクリーンな状態にする
      document.body.innerHTML = `
        <div id="loadingSpinner" style="display: none;">
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke="#4CAF50" stroke-width="4"/>
          </svg>
          <span class="spinner-text"></span>
        </div>
      `;
    });

    test('showSpinner()呼び出しでスピナー要素が表示される', () => {
      // 【テスト目的】: showSpinner関数の基本動作を確認
      // 【テスト内容】: displayプロパティがflexに変更されることをテスト
      // 【期待される動作】: 非表示のスピナーが表示される
      // 🟢 要件定義に基づき仕様が明確

      // 【テストデータ準備】: スピナー要素が非表示状態であることを確認
      const spinner = document.getElementById('loadingSpinner');
      expect(spinner.style.display).toBe('none');
      // 【前提条件確認】: 初期状態で非表示であることを確認

      // 【実際の処理実行】: showSpinner関数を呼び出し
      // 【処理内容】: スピナーを表示状態にする
      showSpinner('処理中...');

      // 【結果検証】: 表示状態に変更されたことを確認
      // 【期待値確認】: displayがflexに設定されていることを確認
      // 【品質保証】: UI状態遷移が正しく行われることを保証
      expect(spinner.style.display).toBe('flex'); // 【検証項目】: スピナーが表示されていること
      expect(spinner.querySelector('.spinner-text').textContent).toBe('処理中...'); // 【検証項目】: テキストが設定されていること
      // 🟢 この検証は要件定義に基づいており、推測なし
    });

    test('showSpinner()でテキスト引数を渡して表示テキストを更新できる', () => {
      // 【テスト目的】: テキスト更新機能の確認
      // 【テスト内容】: 引数によるテキスト更新をテスト
      // 【期待される動作】: 引数の値が使用される
      // 🟢 要件定義（7.3節 API仕様）に基づく

      const spinner = document.getElementById('loadingSpinner');

      // 【実際の処理実行】: テキスト引数を指定して呼び出し
      showSpinner('コンテンツ取得中...');

      // 【結果検証】: テキストが更新されたことを確認
      expect(spinner.querySelector('.spinner-text').textContent).toBe('コンテンツ取得中...');
      // 🟢 引数指定時の動作はAPI仕様で明確
    });
  });

  describe('hideSpinner', () => {
    beforeEach(() => {
      document.body.innerHTML = `
        <div id="loadingSpinner" style="display: flex;">⏳</div>
      `;
    });

    test('hideSpinner()呼び出しでスピナー要素が非表示になる', () => {
      // 【テスト目的】: hideSpinner関数の基本動作を確認
      // 【テスト内容】: displayがnoneに変更されることをテスト
      // 【期待される動作**: 表示中のスピナーが消える
      // 🟢 要件定義（201-204行目）に基づく

      const spinner = document.getElementById('loadingSpinner');
      expect(spinner.style.display).toBe('flex'); // 【前提条件確認】: 初期状態で表示中

      // 【実際の処理実行】: hideSpinner関数を呼び出し
      hideSpinner();

      // 【結果検証】: 非表示になったことを確認
      expect(spinner.style.display).toBe('none'); // 【検証項目】: スピナーが非表示になっていること
      // 🟢 基本的な非表示機能は仕様で明確
    });
  });

  describe('recordCurrentPageとの統合', () => {
    beforeEach(() => {
      document.body.innerHTML = `
        <div id="loadingSpinner" style="display: none;">
          <span class="spinner-text"></span>
        </div>
        <div id="mainStatus"></div>
        <button id="recordBtn"></button>
      `;
      // 【テストデータ準備】: 関連するDOM要素をモック
    });

    afterEach(() => {
      // 【テスト後処理】: DOMをクリーンアップ
      // 【状態復元】: 次のテストに影響しないようリセット
      document.body.innerHTML = '';
    });

    test('記録開始時にスピナーが表示される', async () => {
      // 【テスト目的】: recordCurrentPageとの統合動作を確認
      // 【テスト内容】: 関数開始時のスピナー表示をテスト
      // 【期待される動作】: 処理開始直後にスピナーが表示される
      // 🟡 既存main.jsのロジックに基づく推測

      // 【テストデータ準備】: Chrome APIをモック
      global.chrome = {
        tabs: {
          query: jest.fn(() => [{ id: 123, url: 'https://example.com' }]),
          sendMessage: jest.fn(() => Promise.resolve({ content: 'test content' }))
        },
        runtime: {
          sendMessage: jest.fn(() => Promise.resolve({ success: true })),
          getURL: jest.fn((path) => `chrome-extension://${path}`)
        }
      };

      const spinner = document.getElementById('loadingSpinner');

      // 【実際の処理実行】: recordCurrentPageを呼び出し（非同期）
      recordCurrentPage(false);

      // 【結果検証】: スピナーが表示されたことを確認
      // 注意: 非同期処理のため、最初の同期部分実行後に確認
      expect(spinner.style.display).toBe('flex'); // 【検証項目】: 処理開始時にスピナーが表示されていること
      expect(spinner.querySelector('.spinner-text').textContent).toBe('処理中...');
      // 🟡 元の実装に基づき推測、実装時に確認必要
    });
  });
});
```

---

## 📊 品質判定

### ✅ 高品質: テストケース定義は実装準備完了

- **テストケース分類**: ✅ 正常系・異常系・境界値が網羅されている
  - 正常系: 7個（基本機能、テキスト更新、統合動作）
  - 異常系: 3個（エラー時の非表示、DOMエラー、例外発生時）
  - 境界値: 2個（即時完了時のフラッシュ防止、連続操作時の挙動）
- **期待値定義**: ✅ 各テストケースの期待値が明確
  - すべてのテストケースに具体的な入力値と期待結果を記載
  - DOM状態（displayプロパティ）の具体的な値を指定
- **技術選択**: ✅ プログラミング言語・テストフレームワークが確定
  - 言語: JavaScript (ES2022+)
  - テストフレームワーク: Jest（既導入済み、jsdom使用）
- **実装可能性**: ✅ 現在の技術スタックで実現可能
  - 既存コードベースに統合可能
  - jsdomによるDOMテスト環境が整備済み

### 信頼性レベルサマリー

- 🟢 **青信号**: 7/12ケース（58.3%） - 要件定義または既存実装に基づき明確
- 🟡 **黄信号**: 4/12ケース（33.3%） - 要件定義から妥当な推測
- 🔴 **赤信号**: 1/12ケース（8.3%） - 要件定義にない仕様を含む

---

## 🚀 次のステップ

### 次のお勧めステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

Redフェーズでは以下を実施します：

1. **テスト環境のセットアップ**
   - `src/popup/__tests__/mainSpinner.test.js` ファイル作成
   - DOM要素のモック用意（jest.setup.jsを活用）

2. **失敗するテストの作成**
   - 上記で定義した12個のテストケースを実装
   - まず失敗することを確認（関数が未実装のため）

3. **テスト実行の確認**
   - すべてのテストが適切に失敗することを確認
   - エラーメッセージ（関数未定義）を確認

---

## 📌 メモ

- 本機能は新規実装であるため、既存実装との整合性を保ちつつ実装する必要があります
- DOM操作のテストにはjsdomを使用し、ボタンクリックなどのイベントも模倣可能です
- Chrome Extensions API（chrome.tabs, chrome.runtime）は適切にmock化が必要
- 既存のjest.setup.js（utils-testingの実装）を参考にモックを作成します
- スピナーのアニメーション（60fps）は視覚的検証が必要なため、テストでは表示状態のみを確認します