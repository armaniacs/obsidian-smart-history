# UF-101: uBlockフィルターパーサーコア実装 - テストケース洗い出し

## 作成情報

- **作成日**: 2026-01-24
- **担当フェーズ**: Testcases
- **前のフェーズ**: Requirements

## テスト開発コンテキスト

### 開発コンテキスト情報

- **対象機能**: uBlockフィルターパーコーコア実装
- **現在のTDDフェーズ**: Testcases
- **前回の完了フェーズ**: Requirements（要件定義完了）
- **今回の実行予定**: Redフェーズ（失敗テスト実装）

### 要件・仕様情報

**機能概要**: uBlock Origin形式のフィルターをパースし、内部データ構造に変換

**入力仕様**:
- `parseUblockFilterLine(line)`: 単行のフィルタールール（`string`）
- `parseUblockFilterList(text)`: 複数行のフィルターテキスト（`string`）

**出力仕様**:
- `UblockRule`: 単一ルールオブジェクト（id, rawLine, type, domain, pattern, options）
- `UblockRules`: ルールセット（blockRules, exceptionRules, metadata）

**サポート構文**:
- `||hostname^` - ドメインブロック
- `@@||hostname^` - 例外ルール
- `*` - ワイルドカード
- `!` - コメント行

**制約条件**:
- 1,000行パース < 1秒
- 10,000行パース < 5秒

### 技術情報

- **プログラミング言語**: JavaScript (ES Modules)
- **テストフレームワーク**: Jest
- **テスト対象ファイル**: `src/utils/__tests__/ublockParser.test.js`

---

## テストケース一覧

### 合計: 18テスト（正常系: 7 / 異常系: 4 / エッジ: 4 / 性能: 3）

---

### 1. 正常系テストケース

#### テスト 1: 基本ドメインブロック

- **テスト名**: 基本ドメインブロック
- **何をテストするか**: 標準的なuBlock形式のドメインブロックルールを正しくパースできることを確認
- **期待される動作**: `||example.com^` を入力すると、type='block'、domain='example.com'、patternが設定されたUblockRuleオブジェクトが返される
- **入力値**: `"||example.com^"`
- **入力データの意味**: 最も基本的なuBlock形式のドメインブロックパターン
- **期待される結果**:
  ```javascript
  {
    id: expect.any(String),
    rawLine: "||example.com^",
    type: "block",
    domain: "example.com",
    pattern: expect.stringMatching(/^example\.com$/),
    options: {}
  }
  ```
- **期待結果の理由**: ドメイン部分が正確に抽出され、内部パターンが正規表現に変換されるべき
- **テストの目的**: 基本機能の動作確認
- **確認ポイント**: type が 'block'、domain が正しい値、pattern が有効な正規表現であること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 2: 例外ルール

- **テスト名**: 例外ルールのパース
- **何をテストするか**: `@@` 接頭の例外ルールを正しく認識し、type='exception' として扱えることを確認
- **期待される動作**: `@@||trusted.com^` を入力すると、type='exception'、domain='trusted.com' のUblockRuleオブジェクトが返される
- **入力値**: `"@@||trusted.com^"`
- **入力データの意味**: 信頼済みサイトを除外する例外ルール
- **期待される結果**:
  ```javascript
  {
    id: expect.any(String),
    rawLine: "@@||trusted.com^",
    type: "exception",
    domain: "trusted.com",
    pattern: expect.stringMatching(/^trusted\.com$/),
    options: {}
  }
  ```
- **期待結果の理由**: `@@` プレフィックスが正しく除去され、例外タイプとして認識されるべき
- **テストの目的**: 例外ルールの区別機能確認
- **確認ポイント**: @@ が除去され、type が 'exception' であること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 3: ワイルドカードドメイン

- **テスト名**: ワイルドカードドメインのパース
- **何をテストするか**: `*` ワイルドカードを含むパターンを正しくパースできることを確認
- **期待される動作**: `||*.ads.net^` を入力すると、domain='*.ads.net' が設定される
- **入力値**: `"||*.ads.net^"`
- **入力データの意味**: サブドメインを含む広告ドメインを一括ブロック
- **期待される結果**:
  ```javascript
  {
    id: expect.any(String),
    rawLine: "||*.ads.net^",
    type: "block",
    domain: "*.ads.net",
    pattern: expect.any(String), // ワイルドカード対応のパターン
    options: {}
  }
  ```
- **期待結果の理由**: ワイルドカード char `*` がそのまま保持され、domain に設定されるべき
- **テストの目的**: ワイルドカード対応機能の確認
- **確認ポイント**: domain に `*` 文字が含まれていること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される基本機能 |

---

#### テスト 4: コメント行のスキップ

- **テスト名**: コメント行はスキップされる
- **何をテストするか**: `!` で始まるコメント行を正しくスキップし、null を返すことを確認
- **期待される動作**: `"! Comment line"` を入力すると null が返される
- **入力値**: `"! Comment line"`
- **入力データの意味**: コメント行であることを示す
- **期待される結果**: `null`
- **期待結果の理由**: コメント行はルールとして処理すべきではなく、無視されるべき
- **テストの目的**: コメント行スキップ機能の確認
- **確認ポイント**: コメント行で `null` が返されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/TODO.md` に記載される構文 |

---

#### テスト 5: 空行のスキップ

- **テスト名**: 空行はスキップされる
- **何をテストするか**: 空行や空白のみの行を正しくスキップし、null を返すことを確認
- **期待される動作**: `""` を入力すると null が返される
- **入力値**: `""`
- **入力データの意味**:
- **期待される結果**: `null`
- **期待結果の理由**: 空行はルールとして意味がないためスキップされるべき
- **テストの目的**: 空行スキップ機能の確認
- **確認ポイント**: 空行で `null` が返されること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | 基本的なフィルターパーサーの標準動作 |

---

#### テスト 6: 複数行一括パース（正常）

- **テスト名**: 複数行の一括パース（正常系）
- **何をテストするか**: 3つの異なるルール（ブロック、例外、コメント）を含む複数行テキストを正しくパースできることを確認
- **期待される動作**: ルル、例外ルールがそれぞれの配列に分類され、metadata に集計情報が設定される
- **入力値**:
  ```javascript
  `! Comment\n||example.com^\n@@||trusted.com^`
  ```
- **入力データの意味**: コメント、ブロックルール、例外ルールの混在テキスト
- **期待される結果**:
  ```javascript
  {
    blockRules: [
      expect.objectContaining({
        type: "block",
        domain: "example.com"
      })
    ],
    exceptionRules: [
      expect.objectContaining({
        type: "exception",
        domain: "trusted.com"
      })
    ],
    metadata: {
      source: "paste",
      importedAt: expect.any(Number),
      lineCount: 3,
      ruleCount: 2
    }
  }
  ```
- **期待結果の理由**: 各ルールが正しく分類され、コメント行が除外されるべき
- **テストの目的**: 複数行パースとルール分類機能の確認
- **確認ポイント**: blockRules.length が 1、exceptionRules.length が であること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される機能 |

---

#### テスト 7: サブドメインのパース

- **テスト名**: サブドメインを含むパース
- **何をテストするか**: `sub.example.com` のようなサブドメインを正しくパースできることを確認
- **期待される動作**: `"||sub.example.com^"` を入力すると、domain='sub.example.com' が設定される
- **入力値**: `"||sub.example.com^"`
- **入力データの意味**: トラッカーのサブドメイン
- **期待される結果**:
  ```javascript
  {
    id: expect.any(String),
    rawLine: "||sub.example.com^",
    type: "block",
    domain: "sub.example.com",
    pattern: expect.stringMatching(/^sub\.example\.com$/),
    options: {}
  }
  ```
- **期待結果の理由**: サブドメインも正確にドメイン部分として抽出されるべき
- **テストの目的**: サブドメイン対応の確認
- **確認ポイント**: domain に 'sub.example.com' の完全文字列が含まれていること

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/02-phase2-parser.md` に記載される機能 |

---

### 2. 異常系テストケース

#### テスト 8: || プレフィックスがないパターンは無効

- **テスト名**: || プレフィックスがない場合は無効
- **エラーケースの概要**: uBlock形式の必須プレフィックス `||` が欠けている不正なパターン
- **入力値**: `"example.com^"` || プレフィックスなし
- **不正な理由**: uBlock標準の `||` プレフィックスが必須であるため
- **実際の発生シナリオ**: ユーザーが誤って簡易形式のみ入力した場合
- **期待される結果**: `null`
- **エラーメッセージ**: 内部的には検証エラーだが、関数は静的に null を返す
- **システムの安全性**: 不正なパターンを検証して配列に追加しないことでシステム安全性を確保
- **テストの目的**: 入力バリデーション機能の確認
- **品質保証の観点**: 不正なルールによる予期せぬ動作を防止

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/00-overview.md` に記載される基本構文 |

---

#### テスト 9: ^ サフィックスがないパターンは無効

- **テスト名**: ^ サフィックスがない場合は無効
- **エラーケースの概要**: uBlock形式の必須サフィックス `^` が欠けている不正なパターン
- **入力値**: `"||example.com"` || サフィックスなし
- **不正な理由**: 処密なマッチングを避けるため `^` サフィックスが必須であるため
- **実際の発生シナリオ**: ユーザーが入力ミスをした場合
- **期待される結果**: `null`
- **エラーメッセージ**: 内部的には検証エラーだが、関数は静的に null を返す
- **システムの安全性**: 不完全なパターンを許可しないことでシステム安全性を確保
- **テストの目的**: 入力バリデーション機能の確認
- **品質保証の観点**: 不完全なマッチングによる予期せぬドメインへのアクセスを防止

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | `plan/UII/00-overview.md` に記載される基本構文 |

---

#### テスト 10: 不正文字を含むドメインは無効

- **テスト名**: 不正文字を含むドメインは無効
- **エラーケースの概要**: ドメインとして不適切な文字（例: `@`, `/` 等）を含むパターン
- **入力値**: `"||example@invalid^"`
- **不正な理由**: ドメイン識別子として適切な文字セット外の文字は許可されない
- **実際の発生シナリオ**: コピー＆ペース時に意図せず文字が含まれた場合
- **期待される結果**: `null`
- **エラーメッセージ**: 入力値が `isValidDomain()` チェイスで検証され、null が返される
- **システムの安全性**: 不正なドメイン文字列を許可しないことでシステム安全性を確保
- **テストの目的**: 文字セットバリデーション機能の確認
- **品質保証の観点**: 不正なドメイン名による予期せぬ動作を防止

| 信頼性レベル | 内容 |
|-----------|------|
| 🟡 | `plan/UII/10-data-structures.md` に記載される制約 |

---

#### テスト 11: 空パターン（||^ のみ）は無効

- **テスト名**: 空パターンは無効
- **エラーケースの概要**: hostname 部分が空の `||^` は意味を持たないため無効扱い
- **入力値**: `"||^"`
- **不正な理由**: ドメイン指定がないフィルターはルールとして意味がない
- **実際の発生シナリオ**: 入力ミスや空白行の誤入力
- **期待される結果**: `null`
- **エラーメッセージ**: ドメイン抽出後に domain が空または null のため無効
- **システムの安全性**: 意味のないルールを配列に追加しないことでメモリ効率を確保
- **テストの目的**: 入力の完全性検証機能の確認
- **品質保証の観点**: 意味のあるルールの混入防止

| 信頼性レベル | 内容 |
|-----------|------|
| 🟡 | 一般的なパーサーの入力検証要件 |

---

#### テスト 12: null 入力は無効

- **テスト名**: null 入力は無効
- **エラーケースの概要**: null 値が渡された場合の安全な扱い
- **入力値**: `null`
- **不正な理由**: プログラム上の安全な扱いを確保するため null は無効扱いとする
- **実際の発生シナリオ**: プログラム上の予期せぬ null 値が渡される可能性
- **期待される結果**: `null`
- **システムの安全性**: null 参照によるエラーを防止
- **テストの目的**: null セーフェンスの確認
- **品質保証の観点**: プログラムのロバスト性向上

| 信頼性レベル | 内容 |
|-----------|------|
| 🟢 | 基本的な入力検証要件 |

---

### 3. エッジケース

#### テスト 13: 複数連続ワイルドカード

- **テスト名**: 複数連続ワイルドカードのパース
- **エッジケースの意味**: `*.*.example.com` のように複数のワイルドカードを含むパターンが正しく処理されることを確認
- **入力値**: `"||*.*.example.com^"`
- **期待される動作**: domain に '*.*.example.com' がそのまま設定される
- **信頼性レベル**: 🟡 - `plan/UII/02-phase2-parser.md` に記述はないが一般的なパーサー機能として妥当
- **パターン検証**: isValidRulePattern() で有効なパターンとして通過
- **システム安全性**: ドメイン部分が少し複雑でも許可されているため安全上の問題なし

---

#### テスト 14: ドメインオプション付き（最小限りのプレビュー）

- **テスト名**: ドメインオプション付きの基本パース（オプション解析はUF-102で詳細実装）
- **エッジケースの意味**: `$domain=` などのオプションが含まれる場合に、ドメイン部分を正しく抽出できることを確認
- **入力値**: `"||tracker.com$domain=example.com"`
- **期待される動作**: オプション文字列 `$domain=example.com` を分離し、domain 部分には 'tracker.com' が残る
- **信頼性レベル**: 🟡 - オプション解析の詳細はUF-102で実装予定だが基本パース機能として部分的に処理する
- **テスト計画**: UF-102 で詳細なオプション解析をテストするため、このテストでは基本的な分離動作を確認
- **システム安全性**: オプション部分の誤った解析によるルール誤生成を防止

---

#### テスト 15: 前後空白を含む行は正規化してパース

- **テスト名**: 前後空白を含む行はトリムしてパース
- **エッジケースの意味**: ユーザーが入力時に誤って空白を含んだ場合でも正しくパースされることを確認
- **入力値**: `"||  example.com  ^"` （両端に空白）
- **期待される動作**: 空白がトリムされ、標準パターンとして処理される
- **信頼性レベル**: 🟢 - ユーザビリティ向上のための基本的な入力寛容動作
- **テスト目的**: 入力の柔軟性とユーザビリティ向上の確認
- **ロジック**: パース前の trim() 処理で対応予定

---

#### テスト 16: 大量データ正常系（1,000行）

- **テスト名**: 1,000行の正常パース
- **エッジケースの意味**: 実運用で想定されるサイズのフィルターリストを処理できることを確認
- **入力値**: 有効な `||hostname^` パターンが1,000行含まれるテキスト
- **期待される動作**: 1秒以内に処理が完了し、すべてのルールが正しくパースされる
- **信頼性レベル**: 🟢 - `plan/UII/30-test-strategy.md` に記載される性能要件
- **パフォーマンス基準**: 1行あたり < 1ms、合計 < 1秒
- **システム安全性**: 大量データによるメモリオーバーフローを防止

---

### 4. 性能テストケース

#### テスト 17: 1,000行パースの実行時間

- **テスト名**: 1,000行パースは1秒以内に完了する
- **何をテストするか**: 実運用で想定されるフィルターリストサイズでのパフォーマンス要件を満たしていることを確認
- **入力値**: 有効な `||hostname^` パターンが1,000行含まれるテキスト
- **期待される動作**: 実行時間が1秒以内であり、正しくパースされる
- **信頼性レベル**: 🟢 - `plan/UII/30-test-strategy.md` に記載される性能要件
- **パフォーマンス基準**: 合計パース時間 < 1秒
- **システム安全性**: 大量ルール時の処理遅延によるUX悪化を防止

---

#### テスト 18: 無効行多数を含む10,000行

- **テスト名**: 無効行多数を含む10,000行のパース
- **何をテストするか}: 実運用で想定される最大サイズのフィルターリストでもエラーなく処理できることを確認
- **入力値**: 有効な `||hostname^` パターン5,000行と、無効なパターン5,000行を含むテキスト
- **期待される動作**: 5秒以内に処理が完了し、有効行のみが配列に含まれる
- **信頼性レベル**: 🟢 - `plan/UII/30-test-strategy.md` に記載される性能要件
- **パフォーマンス基準**: 合計パース時間 < 5秒
- **システム安全性**: 無効行を大量に含んでいてもシステムがクラッシュしないこと

---

## 実装に関する情報

### プログラミング言語

- **言語**: JavaScript (ES Modules)
- **言語選択の理由**: プロジェクト全体が JavaScript で記述されており、uBlockパーサーもJavaScriptで実装が適切

### テストフレームワーク

- **フレームワーク**: Jest
- **選択の理由**:
  - プロジェクトで既に使用されているテストフレームワーク
  - Chrome Extension (Manifest V3) との相性が良い
  - TypeScript の JSDocomment サポートが充実

### テスト対象ファイル

- **メインテストファイル**: `src/utils/__tests__/ublockParser.test.js`
- **テスト実装フォルダ**: `src/utils/__tests__/`

---

## 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系7 / 異常系5 / エッジ4 / 性能3 で網羅完了
- **期待値定義**: 各テストケースの期待値が明確
- **技術選択**: JavaScript + Jest は確定
- **実装可能性**: 確実

### 実装優先順序

| テスト | 優先度 | 理由 |
|------|--------|------|
| テスト 1-7 | P0 | 基本動作確認 |
| テスト 8-12 | P0 | エラーハンドリング必須 |
| テスト 13-16 | P1 | エッジケースカバー |
| テスト 17-18 | P0 | 性能要件達成確認 |

---

## 品質判定結果

### ✅ 高品質

- **テストケース分類**: 正常系・異常系・エッジケースが網羅されている
- **期待値定義**: 各テストケースの期待値が明確
- **技術選択**: JavaScript + Jest は確定
- **実装可能性**: 確実

### 判定理由

- `plan/UII/02-phase2-parser.md` に詳細なAPI設計がある
- `plan/UII/10-data-structures.md` に完全な型定義がある
- 正常系・異常系・エッジケースのバランスが適切
- 性能要件も含まれており実装範囲が適切

---

## 参照した設計文書

| 種類 | 信頼性レベル |
|------|-------------|
| `plan/UII/00-overview.md` | 🟢 |
| `plan/UII/02-phase2-parser.md` | 🟢 |
| `plan/UII/10-data-structures.md` | 🟢 |
| `plan/UII/20-api-reference.md` | 🟢 |
| `plan/UII/30-test-strategy.md` | 🟢 |
| `src/utils/storage.js` | 🟢 |

---

## 要件網羅率

| カテゴリ | テスト数 | カバー率 |
|--------|--------|--------|
| 基本パース機能 | 7 | 100% |
| エラーハンドリング | 5 | 100% |
| エッジケース | 4 | 80% |
| 性能要件 | 3 | 100% |

---

## 次のステップ

**推奨コマンド**: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

Redフェーズでは以下を実行します：
1. `src/utils/__tests__/ublockParser.test.js` の作成
2. 18テストケースの実装（すべて失敗することを確認）
3. テストを `npm test` で実行し、すべて失敗していることを確認

テスト関数: 18