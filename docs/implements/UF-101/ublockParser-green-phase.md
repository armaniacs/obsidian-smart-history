# UF-101 Greenãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæœ€å°å®Ÿè£…ï¼‰

## ä½œæˆæ—¥æ™‚

2026-01-24

## å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/utils/ublockParser.js`
- **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `src/utils/__tests__/ublockParser.test.js`

## å®Ÿè£…ã—ãŸé–¢æ•°

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆ5ã¤ï¼‰

| é–¢æ•°å | èª¬æ˜ | è²¬ä»» |
|------|------|------|
| `isCommentLine(line)` | `!` ã§å§‹ã¾ã‚‹è¡Œã‚’åˆ¤å®š | ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚¹ã‚­ãƒƒãƒ— |
| `isEmptyLine(line)` | ç©ºè¡Œã‚’åˆ¤å®š | ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ— |
| `isValidRulePattern(line)` | uBlockå½¢å¼ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼ | ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| `generateRuleId(rawLine)` | ãƒ«ãƒ¼ãƒ«IDç”Ÿæˆ | ä¸€æ„è­˜åˆ¥å­ç”Ÿæˆ |
| `parseOptions(optionsString)` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ | å°†æ¥ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œ |

### ãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆ2ã¤ï¼‰

| é–¢æ•°å | èª¬æ˜ | è²¬ä»» |
|------|------|------|
| `parseUblockFilterLine(line)` | å˜è¡Œãƒ‘ãƒ¼ã‚¹ | å˜ä¸€ãƒ«ãƒ¼ãƒ«ã®è§£æ |
| `parseUblockFilterList(text)` | è¤‡æ•°è¡Œä¸€æ‹¬ãƒ‘ãƒ¼ã‚¹ | ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆå…¨ä½“ã®è§£æ |

## å®Ÿè£…ã‚³ãƒ¼ãƒ‰

### isCommentLine ã‚³ãƒ¡ãƒ³ãƒˆè¡Œåˆ¤å®š

```javascript
// ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefinedã®å ´åˆã¯falseã‚’è¿”ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
if (!line || typeof line !== 'string') {
  return false;
}
// ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã€‘: `!` ã§å§‹ã¾ã‚‹è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨åˆ¤å®š
return COMMENT_PREFIX_REGEX.test(line);
```

### isEmptyLine ç©ºè¡Œåˆ¤å®š

```javascript
// ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefinedã®å ´åˆã¯trueã‚’è¿”ã—ã¦å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
if (!line || typeof line !== 'string') {
  return true;
}
// ã€ç©ºç™½åˆ¤å®šã€‘: trimã—ãŸå¾Œã«ç©ºæ–‡å­—åˆ—ã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯
return line.trim() === '';
}

### isValidRulePattern ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼

```javascript
// ã€ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼ã€‘: `||` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ `^` ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ä¸¡æ–¹ã‚’æ¤œå‡º
const hasPrefix = RULE_PREFIX_REGEX.test(line);
const hasSuffix = RULE_SUFFIX_REGEX.test(line);
return hasPrefix && hasSuffix;
```

### generateRuleId IDç”Ÿæˆ

```javascript
// ã€ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ã€‘: ãƒ†ã‚¹ãƒˆã‚’é€šã™ãŸã‚ã®ç°¡æ˜“å®Ÿè£…
let hash = 0;
for (let i = 0; i < rawLine.length; i++) {
  const char = rawLine.charCodeAt(i);
  hash = ((hash << 5) - hash) + char;
  hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
}
```

### parseUblockFilterLine å˜è¡Œãƒ‘ãƒ¼ã‚¹

```javascript
// ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘:
// 1. å…¥åŠ›å€¤æ¤œè¨¼ - null/undefinedãƒã‚§ãƒƒã‚¯
// 2. ãƒˆãƒªãƒ å‡¦ç† - å‰å¾Œç©ºç™½é™¤å»
// 3. ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚¹ã‚­ãƒƒãƒ— - ! ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ¤œå‡º
// 4. ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ— - ç©ºè¡Œæ¤œå‡º
// 5. ãƒ«ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤å®š - @@|| ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§ä¾‹å¤–ãƒ«ãƒ¼ãƒ«æ¤œå‡º
// 6. ||ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹å‰Šé™¤ - ãƒ–ãƒ­ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«ã®å ´åˆ
// 7. ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹æ¤œè¨¼ - æœ«å°¾ã® ^ ç¢ºèª
// 8. ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡º - ^ ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»
// 9. ç©ºç™½é™¤å» - ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ç©ºç™½å‰Šé™¤
// 10. ç©ºãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼ - ç©ºãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
// 11. ä¸æ­£æ–‡å­—æ¤œè¨¼ - ãƒ‰ãƒ¡ã‚¤ãƒ³å½¢å¼ãƒã‚§ãƒƒã‚¯
// 12. ãƒ«ãƒ¼ãƒ«æ§‹ç¯‰ - UblockRuleã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
```

### parseUblockFilterList è¤‡æ•°è¡Œãƒ‘ãƒ¼ã‚¹

```javascript
// ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘:
// 1. å…¥åŠ›å€¤æ¤œè¨¼ - null/undefinedãƒã‚§ãƒƒã‚¯
// 2. è¡Œåˆ†å‰² - æ”¹è¡ŒåŒºåˆ‡ã‚Šã§é…åˆ—åŒ–
// 3. é…åˆ—åˆæœŸåŒ– - blockRules, exceptionRules
// 4. è¡Œãƒ‘ãƒ¼ã‚¹ - å„è¡Œã‚’parseUblockFilterLineã§å‡¦ç†
// 5. ãƒ«ãƒ¼ãƒ«åˆ†é¡ - typeã”ã¨ã«é…åˆ—ã«è¿½åŠ 
// 6. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰ - lineCount, ruleCounté›†è¨ˆ
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

```
Test Suites: 1 passed, 1 total
Tests:       29 passed, 29 total
Snapshots:   0 total
Time:        0.442 s, estimated 1 s
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ

| ã‚«ãƒ†ã‚´ãƒª | ãƒ†ã‚¹ãƒˆæ•° | çµæœ |
|---------|----------|------|
| parseUblockFilterLine - æ­£å¸¸ç³» | 6 | âœ… å…¨é€šé |
| parseUblockFilterLine - ç•°å¸¸ç³» | 5 | âœ… å…¨é€šé |
| parseUblockFilterLine - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | 2 | âœ… å…¨é€šé |
| parseUblockFilterList | 2 | âœ… å…¨é€šé |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ | 2 | âœ… å…¨é€šé |
| ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° - isCommentLine | 2 | âœ… å…¨é€šé |
| ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° - isEmptyLine | 3 | âœ… å…¨é€šé |
| ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° - isValidRulePattern | 3 | âœ… å…¨é€šé |
| ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° - generateRuleId | 2 | âœ… å…¨é€šé |
| ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° - parseOptions | 2 | âœ… å…¨é€šé |

## ä¿®æ­£ã—ãŸå•é¡Œ

### å•é¡Œ1: ä¾‹å¤–ãƒ«ãƒ¼ãƒ«ãŒãƒ‘ãƒ¼ã‚¹ã§ããªã„

**åŸå› **: `@@` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®å‡¦ç†å¾Œã« `||` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¦ã„ãŸ

**ä¿®æ­£**: `@@||` ã‚’ã¾ã¨ã‚ã¦åˆ¤å®šã—ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»ã‚’è¡Œã†ã‚ˆã†ã«å¤‰æ›´

```javascript
// ã€ä¿®æ­£å‰ã€‘
if (workLine.startsWith('@@')) {
  type = 'exception';
  workLine = workLine.substring(2); // @@ã®ã¿å‰Šé™¤
}

// ã€ä¿®æ­£å¾Œã€‘
if (workLine.startsWith('@@||')) {
  type = 'exception';
  workLine = workLine.substring(4); // @@||ã‚’å‰Šé™¤
}
```

### å•é¡Œ2: å‰å¾Œç©ºç™½ã‚’å«ã‚€è¡ŒãŒãƒ‘ãƒ¼ã‚¹ã§ããªã„

**åŸå› **: trim() å¾Œã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¹ãƒšãƒ¼ã‚¹ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã€æ­£è¦è¡¨ç¾ã§å¼¾ã‹ã‚Œã¦ã„ãŸ

**ä¿®æ­£**: ãƒ‰ãƒ¡ã‚¤ãƒ³æŠ½å‡ºå¾Œã« `replace(/\s+/g, '')` ã§ç©ºç™½ã‚’å‰Šé™¤

```javascript
// ã€ç©ºç™½é™¤å»ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ç©ºç™½ã‚‚å‰Šé™¤ã—ã¦æ­£è¦åŒ–
domain = domain.replace(/\s+/g, '');
```

## å®Ÿè£…æ–¹é‡

1. **ãƒ†ã‚¹ãƒˆãŒç¢ºå®Ÿã«é€šã‚‹ã“ã¨æœ€å„ªå…ˆ**
2. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§æ§‹ã‚ãªã„ï¼ˆæœ€å°å®Ÿè£…ï¼‰
3. ã‚³ãƒ¼ãƒ‰ã®ç¾ã—ã•ã¯äºŒã®æ¬¡ï¼ˆæ¬¡ã®Refactorãƒ•ã‚§ãƒ¼ã‚ºã§æ”¹å–„ï¼‰
4. ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã‚’å¿ƒãŒã‘ã‚‹

## å®Ÿè£…ã«å«ã‚ãŸæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆ

å„å‡¦ç†ãƒ–ãƒ­ãƒƒã‚¯ã«ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼š

- ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: é–¢æ•°ãŒä½•ã‚’ã™ã‚‹ã‹
- ã€å®Ÿè£…æ–¹é‡ã€‘: ãªãœã“ã®ã‚ˆã†ãªå®Ÿè£…ã‚’é¸ã‚“ã ã‹
- ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: ã©ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é€šã™ãŸã‚ã®å®Ÿè£…ã‹
- ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: ğŸŸ¢ğŸŸ¡ğŸ”´
  - ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: å…¥åŠ›å€¤ãƒã‚§ãƒƒã‚¯ã®ç†ç”±
  - ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã€‘: ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼ã®å†…å®¹
  - ã€ãƒ«ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤å®šã€‘: ãƒ«ãƒ¼ãƒ«åˆ†é¡ã®ãƒ­ã‚¸ãƒƒã‚¯
  - ã€çµæœè¿”å´ã€‘: å‡¦ç†çµæœã‚’è¿”ã™ç†ç”±

## èª²é¡Œãƒ»æ”¹å–„ç‚¹

### Refactorãƒ•ã‚§ãƒ¼ã‚ºã§å¯¾å¿œã™ã¹ãç‚¹

1. **IDç”Ÿæˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: ç¾åœ¨ã¯ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ã€SHA-256ç§»è¡Œã‚’æ¤œè¨
2. **ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ**: parseOptions ã¯æœ€å°å®Ÿè£…ã€UF-102ã§è©³ç´°å®Ÿè£…äºˆå®š
3. **ã‚¨ãƒ©ãƒ¼æƒ…å ±**: ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’è¿”ã™æ©Ÿèƒ½ï¼ˆParseErrorå‹å®Ÿè£…ï¼‰
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: 10,000è¡Œè¶…ãƒ‡ãƒ¼ã‚¿ã¸ã®å¯¾å¿œ
5. **æ­£è¦è¡¨ç¾æ•´ç†**: è¤‡æ•°ã®æ­£è¦è¡¨ç¾ã‚’å®šæ•°ã¨ã—ã¦æ•´ç†
6. **é–¢æ•°åˆ†å‰²**: parseUblockFilterLine å†…ã®å‡¦ç†ã‚’å°ã•ãªé–¢æ•°ã«åˆ†å‰²

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼ã§XSSãƒªã‚¹ã‚¯ã‚’ä½æ¸›
- ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: 1,000è¡Œ < 1ç§’ã€10,000è¡Œ < 5ç§’ã®è¦ä»¶ã‚’æº€ãŸã™

---

## å‚ç…§ã—ãŸè¨­è¨ˆæ–‡æ›¸

| ç¨®é¡ | ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ« |
|------|-------------|
| `plan/UII/00-overview.md` | ğŸŸ¢ |
| `plan/UII/02-phase2-parser.md` | ğŸŸ¢ |
| `plan/UII/10-data-structures.md` | ğŸŸ¢ |
| `plan/UII/30-test-strategy.md` | ğŸŸ¢ |
| `docs/implements/UF-101/tdd-testcases.md` | ğŸŸ¢ |
| `docs/implements/UF-101/tdd-requirements.md` | ğŸŸ¢ |

---

## æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆRefactorï¼‰

Refactorãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ä»¥ä¸‹ã®æ”¹å–„ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

1. å®šæ•°ã®æ•´ç†ã¨è¿½åŠ 
2. é–¢æ•°åˆ†å‰²ã«ã‚ˆã‚‹å¯èª­æ€§å‘ä¸Š
3. JSDocã®å……å®ŸåŒ–
4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼
6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼