# uBlock Origin形式フィルターインポート機能 ユーザーガイド

## 概要

Obsidian Smart History拡張機能のuBlock Origin形式フィルターインポート機能を使用すると、既存のuBlock Originフィルターリストやhosts形式のフィルターリスト（例：Steven Black's hosts）を直接インポートして、特定のWebサイトの記録をブロックまたは許可できます。

**複数のフィルターソースを同時に登録でき**、それぞれ個別に管理できます。

## 使い方

### 1. 設定画面へのアクセス

1. ブラウザのツールバーにあるObsidian Smart Historyアイコンをクリックします。
2. 表示されるポップアップ画面で、右上の「☰」メニューを開きます。
3. 「Settings」を選択して設定画面に移動します。

### 2. ドメインフィルタータブの選択

設定画面で「ドメインフィルター」タブを選択します。

### 3. フィルターモードの選択

以下のいずれかのモードを選択します：
- **無効**: すべてのサイトを記録します。
- **ホワイトリスト**: 指定したサイトのみを記録します。
- **ブラックリスト**: 指定したサイトを記録から除外します。

### 4. フィルター形式の選択

「フィルター形式」で「uBlock Origin 形式」を選択します。

### 5. フィルターの入力

以下の3つの方法でuBlock形式のフィルターを入力できます：

#### 方法1: テキストの直接入力
1. 「uBlockフィルター」テキストエリアに、uBlock Origin形式のフィルターを直接貼り付けます。
2. 入力すると自動的にプレビューが表示され、ルール数、例外数、エラー数が確認できます。

#### 方法2: ファイルからの読み込み
1. 「ファイルを選択」ボタンをクリックします。
2. ローカルに保存されている.txt形式のフィルターリストを選択します。
3. ファイルが読み込まれ、テキストエリアに内容が表示されます。

#### 方法3: ドラッグ＆ドロップ
1. ファイルを「ファイルをここにドロップ」と表示されている領域にドラッグ＆ドロップします。
2. ファイルが読み込まれ、テキストエリアに内容が表示されます。

#### 方法4: URLからの読み込み
1. 「URLから読み込み」の入力欄に、フィルターリストのURLを入力します。
2. 「URLからインポート」ボタンをクリックします。
3. 指定したURLからフィルターがダウンロードされ、テキストエリアに内容が表示されます。

### 6. フィルターのプレビュー

入力したフィルターはリアルタイムでプレビューされ、以下の情報が表示されます：
- **ルール数**: ブロックするドメインの数
- **例外数**: 許可するドメインの数
- **エラー**: フィルターの構文エラーの数と詳細

### 7. エクスポート機能

既存のuBlockフィルターをエクスポートできます：
- **エクスポート**: 現在のフィルターを.txtファイルとしてダウンロードします。
- **クリップボードにコピー**: 現在のフィルターをクリップボードにコピーします。

### 8. 設定の保存

「保存」ボタンをクリックして、入力したフィルターを保存します。保存後、テキストエリアはクリアされ、「登録済みフィルターソース」一覧に追加されます。

### 9. 複数ソースの管理

複数のフィルターソースを登録して同時に使用できます。

#### ソース一覧の確認
「登録済みフィルターソース」セクションに、保存済みの全ソースが表示されます：
- **URL**: インポート元のURL（クリックで開く）または「手動入力」
- **インポート日時**: 最後にインポートした日時
- **ルール数**: そのソースに含まれるルール数

#### ソースの削除
各ソースの横にある「削除」ボタンをクリックすると、そのソースを削除できます。削除後、残りのソースのルールのみが適用されます。

#### ソースの更新
同じURLから再度インポートすると、既存のソースが上書き更新されます。

## サポートされているフィルター形式

### uBlock Origin形式

以下のuBlock Origin構文がサポートされています：

| 構文 | 説明 | 例 |
|------|------|-----|
| `||hostname^` | ドメインと全サブドメインをブロック | `||example.com^` |
| `@@||hostname^` | 例外ルール（ブロックを解除） | `@@||trusted.com^` |
| `*` | ワイルドカード | `||*.ads.net^` |
| `!` | コメント | `! Comment` |
| `$domain=` | 特定ドメインに制限 | `||tracker.com$domain=example.com` |
| `$~domain=` | ドメインを除外 | `||tracker.com$domain=~trusted.com` |
| `$3p` | サードパーティのみ | `||ad.com$3p` |
| `$1p` | ファーストパーティのみ | `||script.com$1p` |
| `$important` | 重要マーク（他のルールより優先） | `||analytics.com$important` |

### hosts形式（AdGuard DNS / Steven Black互換）

以下のhosts形式もサポートされています：

| 形式 | 説明 | 例 |
|------|------|-----|
| `0.0.0.0 hostname` | ドメインをブロック | `0.0.0.0 ads.example.com` |
| `127.0.0.1 hostname` | ドメインをブロック | `127.0.0.1 tracker.com` |
| `#` | コメント行 | `# This is a comment` |
| 行末コメント | 行末のコメント | `0.0.0.0 ads.com # 広告` |

hosts形式のフィルターは自動的にuBlock Origin形式に変換されます：
- `0.0.0.0 ads.example.com` → `||ads.example.com^`
- `localhost`, `local`, `broadcasthost` などの特殊ドメインは自動的にスキップされます

## 推奨フィルターリスト

以下の公開フィルターリストをURLから直接インポートできます：

| リスト名 | 説明 | URL |
|---------|------|-----|
| Steven Black's hosts | 広告・マルウェア・ポルノなど総合ブロック | `https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts` |
| Steven Black's hosts (fakenews-gambling-porn-social) | 拡張版 | `https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn-social/hosts` |
| OISD (nsfw) | NSFW ドメインリスト | `https://nsfw.oisd.nl/` |

## 注意事項

- ファイルの文字エンコーディングはUTF-8であることを推奨します。
- フィルターにエラーがある場合、保存前に修正してください。
- プレビューでエラーが表示された場合でも、有効なルールは正常に機能します。
- 大きなフィルターリスト（20万ドメイン以上）もサポートしています。
- ストレージ容量を節約するため、ドメイン情報のみが保存されます（オプション情報は保持されません）。

## 技術仕様

### ストレージ形式（軽量化版）

フィルターデータは以下の形式でChrome拡張機能のローカルストレージに保存されます：

```javascript
{
  // マージ済みルール（全ソースの統合）
  ublock_rules: {
    blockDomains: ["ads.example.com", "tracker.com", ...],
    exceptionDomains: ["trusted.com", ...],
    metadata: {
      importedAt: 1234567890,
      ruleCount: 12345
    }
  },
  // 個別ソース情報
  ublock_sources: [
    {
      url: "https://example.com/filters.txt",
      importedAt: 1234567890,
      ruleCount: 1000,
      blockDomains: [...],
      exceptionDomains: [...]
    }
  ]
}
```

### パフォーマンス最適化

- **Setベースのマッチング**: 完全一致ドメインはO(1)で高速検索
- **ワイルドカード**: `*`を含むパターンのみ配列でチェック
- **キャッシュ**: ルールインデックスはWeakMapでキャッシュされ、再構築を回避