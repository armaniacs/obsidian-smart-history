<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' https: http: data: chrome-extension:; object-src 'none';">
  <title>Obsidian Smart History Settings</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- Main Screen -->
  <div id="mainScreen">
    <div class="header">
      <h2 data-i18n="appTitle">Smart History</h2>
      <button id="menuBtn" class="icon-btn" data-i18n-aria-label="openSettings">‚öô</button>
    </div>

    <div id="currentPage">
      <img id="favicon" src="" width="16" height="16" alt="" aria-hidden="true">
      <div id="pageInfo">
        <div id="pageTitle">Loading...</div>
        <div id="pageUrl">...</div>
      </div>
    </div>

    <button id="recordBtn" class="primary-btn" data-i18n-label="recordNow">üìù Record Now</button>
    <div id="loadingSpinner" class="spinner-container">
      <svg class="spinner" viewBox="0 0 50 50">
        <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke="#4CAF50" stroke-width="4"
          stroke-linecap="round" />
      </svg>
      <span class="spinner-text" data-i18n="processing">Processing...</span>
    </div>
    <div id="mainStatus" aria-live="polite"></div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" class="settings-screen">
    <div class="header">
      <button id="backBtn" class="icon-btn" data-i18n-aria-label="backToMain">‚Üê</button>
      <h2 data-i18n="settings">Settings</h2>
      <button id="settingsMenuBtn" class="icon-btn" data-i18n-aria-label="settingsMenu" aria-haspopup="true">‚ãÆ</button>
    </div>

    <!-- Settings Dropdown Menu -->
    <div id="settingsMenu" class="dropdown-menu hidden" role="menu">
      <button id="exportSettingsBtn" role="menuitem" data-i18n="exportSettings">Export</button>
      <button id="importSettingsBtn" role="menuitem" data-i18n="importSettings">Import</button>
      <input type="file" id="importFileInput" accept=".json" class="hidden" aria-hidden="true">
    </div>

    <!-- Tab Navigation -->
    <div id="tabList" class="tab-nav" role="tablist">
      <button id="generalTab" class="tab-btn" role="tab" aria-selected="false" aria-controls="generalPanel"
        data-i18n="mainTab">General</button>
      <button id="domainTab" class="tab-btn active" role="tab" aria-selected="true" aria-controls="domainPanel"
        data-i18n="domainTab">Domain Filter</button>
      <button id="privacyTab" class="tab-btn" role="tab" aria-selected="false" aria-controls="privacyPanel"
        data-i18n="privacyTab">Privacy</button>
    </div>

    <!-- General Settings Panel -->
    <div id="generalPanel" class="tab-panel" role="tabpanel" aria-labelledby="generalTab" aria-hidden="true">

      <div class="form-group">
        <label for="apiKey" data-i18n="obsidianApiKey">Obsidian API Key</label>
        <input type="password" id="apiKey" data-i18n-input-placeholder="apiKeyPlaceholder">
      </div>

      <div class="form-group">
        <label for="protocol" data-i18n="protocol">Protocol (http/https)</label>
        <input type="text" id="protocol" value="https">
      </div>

      <div class="form-group">
        <label for="port" data-i18n="port">Port</label>
        <input type="text" id="port" value="27123">
      </div>

      <div class="form-group">
        <label for="dailyPath" data-i18n="dailyNotePath">Daily Note Path</label>
        <input type="text" id="dailyPath" data-i18n-input-placeholder="dailyNotePathPlaceholder">
      </div>

      <hr class="settings-hr">

      <div class="form-group">
        <label data-i18n="aiProvider">AI Provider</label>
        <select id="aiProvider">
          <option value="gemini" data-i18n-opt="googleGemini">Google Gemini</option>
          <option value="openai" data-i18n-opt="openaiCompatible">OpenAI Compatible (Groq, etc.)</option>
          <option value="openai2" data-i18n-opt="openaiCompatible2">OpenAI Compatible 2 (Local, etc.)</option>
        </select>
      </div>

      <!-- Gemini Settings -->
      <div id="geminiSettings">
        <div class="form-group">
          <label data-i18n="geminiApiKey">Gemini API Key</label>
          <input type="password" id="geminiApiKey" data-i18n-input-placeholder="geminiApiKeyPlaceholder">
        </div>

        <div class="form-group">
          <label data-i18n="modelName">Model Name (e.g. gemini-1.5-flash)</label>
          <input type="text" id="geminiModel" value="gemini-1.5-flash">
        </div>
      </div>

      <!-- OpenAI Settings -->
      <div id="openaiSettings" class="openai-settings">
        <div class="form-group">
          <label data-i18n="baseUrl">Base URL</label>
          <input type="text" id="openaiBaseUrl" data-i18n-input-placeholder="openaiBaseUrlPlaceholder">
        </div>

        <div class="form-group">
          <label data-i18n="aiApiKey">API Key</label>
          <input type="password" id="openaiApiKey" data-i18n-input-placeholder="openaiApiKeyPlaceholder">
        </div>

        <div class="form-group">
          <label data-i18n="modelName">Model Name</label>
          <input type="text" id="openaiModel" data-i18n-input-placeholder="openaiModelPlaceholder">
        </div>
      </div>

      <!-- OpenAI 2 Settings -->
      <div id="openai2Settings" class="openai-settings">
        <div class="form-group">
          <label data-i18n="baseUrl">Base URL</label>
          <input type="text" id="openai2BaseUrl" data-i18n-input-placeholder="openai2BaseUrlPlaceholder">
        </div>

        <div class="form-group">
          <label data-i18n="aiApiKey">API Key</label>
          <input type="password" id="openai2ApiKey" data-i18n-input-placeholder="openai2ApiKeyPlaceholder">
        </div>

        <div class="form-group">
          <label data-i18n="modelName">Model Name</label>
          <input type="text" id="openai2Model" data-i18n-input-placeholder="openai2ModelPlaceholder">
        </div>
      </div>

      <div class="form-group">
        <label data-i18n="minVisitDuration">Min Visit Duration (seconds)</label>
        <input type="number" id="minVisitDuration" min="1" value="5">
      </div>

      <div class="form-group">
        <label data-i18n="minScrollDepth">Min Scroll Depth (%)</label>
        <input type="number" id="minScrollDepth" min="0" max="100" value="50">
      </div>

      <button id="save" data-i18n="saveAndTest">Save & Test Connection</button>
      <div id="status" aria-live="polite"></div>
    </div>

    <!-- Domain Filter Panel -->
    <div id="domainPanel" class="tab-panel active" role="tabpanel" aria-labelledby="domainTab" aria-hidden="false">
      <div class="form-group">
        <label data-i18n="domainFilterMode">Domain Filter Mode</label>
        <div class="radio-group">
          <div>
            <input type="radio" id="filterDisabled" name="domainFilter" value="disabled">
            <label for="filterDisabled" data-i18n="filterDisabled">Disabled (record all)</label>
          </div>
          <div>
            <input type="radio" id="filterWhitelist" name="domainFilter" value="whitelist">
            <label for="filterWhitelist" data-i18n="filterWhitelist">Whitelist (record only specified domains)</label>
          </div>
          <div>
            <input type="radio" id="filterBlacklist" name="domainFilter" value="blacklist">
            <label for="filterBlacklist" data-i18n="filterBlacklist">Blacklist (exclude specified domains)</label>
          </div>
        </div>
      </div>

      <!-- Filter Format Selection -->
      <div class="form-group">
        <label data-i18n="filterFormat">Filter Format (can be combined)</label>
        <div>
          <input type="checkbox" id="simpleFormatEnabled" checked>
          <label for="simpleFormatEnabled" class="inline-label" data-i18n="simpleFormat">Simple (1 domain per
            line)</label>
        </div>
        <div class="mt-5">
          <input type="checkbox" id="ublockFormatEnabled">
          <label for="ublockFormatEnabled" class="inline-label" data-i18n="ublockFormat">uBlock Origin Format</label>
        </div>
      </div>

      <!-- simpleÂΩ¢ÂºèÁî®UIÔºàÊó¢Â≠òÔºâ -->
      <div id="simpleFormatUI" class="format-section">
        <div id="domainListSection">
          <div class="form-group">
            <label id="domainListLabel" data-i18n="domainList">Domain List (1 domain per line)</label>
            <textarea id="domainList" rows="8" data-i18n-input-placeholder="domainListPlaceholder"></textarea>
            <div class="help-text" data-i18n="wildcardHelp">
              Wildcards are supported (e.g. *.example.com)
            </div>
          </div>

          <div class="form-group">
            <button id="addCurrentDomain" class="secondary-btn" data-i18n="addCurrentDomain">Add Current Page
              Domain</button>
          </div>
        </div>
      </div>

      <!-- uBlockÂΩ¢ÂºèÁî®UIÔºàÊñ∞Ë¶èÔºâ -->
      <div id="uBlockFormatUI" class="format-section">
        <div class="form-group">
          <label data-i18n="ublockFilter">uBlock Filter</label>
          <textarea id="uBlockFilterInput" rows="8" data-i18n-input-placeholder="ublockFilterPlaceholder"></textarea>
          <div class="help-text" data-i18n="ublockHelp">
            Paste uBlock Origin or hosts format filters<br>
            uBlock: ||hostname^, @@||hostname^, *, !Comments<br>
            hosts: 0.0.0.0/127.0.0.1 hostname (#comments supported)
          </div>
        </div>

        <div class="form-group">
          <label data-i18n="loadFromFile">Load from file (.txt)</label>
          <input type="file" id="uBlockFileInput" accept=".txt">
          <button id="uBlockFileSelectBtn" class="secondary-btn" data-i18n="selectFile">Select File</button>
        </div>

        <!-- Drag & Drop Area -->
        <div id="uBlockDropZone" class="drop-zone">
          <p data-i18n="dropFileHere">Drop file here</p>
        </div>

        <!-- URL Import -->
        <div class="form-group">
          <label data-i18n="loadFromUrl">Load from URL</label>
          <input type="url" id="uBlockUrlInput" data-i18n-input-placeholder="urlPlaceholder">
          <button id="uBlockUrlImportBtn" class="secondary-btn" data-i18n="importFromUrl">Import from URL</button>
        </div>

        <!-- Registered Sources List -->
        <div id="uBlockSourceList" class="source-list">
          <h4 data-i18n="registeredFilterSources">Registered Filter Sources</h4>
          <div id="uBlockSourceItems"></div>
          <p id="uBlockNoSources" class="no-sources" data-i18n="noSourcesRegistered">No sources registered</p>
        </div>

        <!-- Preview Section -->
        <div id="uBlockPreview" class="preview-section">
          <h4 data-i18n="loadPreview">Load Preview</h4>
          <p><span data-i18n="ruleCount" data-i18n-args='{"count": "0"}'>Rules: 0</span> <span
              id="uBlockRuleCount"></span></p>
          <p><span data-i18n="exceptionCount" data-i18n-args='{"count": "0"}'>Exceptions: 0</span> <span
              id="uBlockExceptionCount"></span></p>
          <p><span data-i18n="errorCount" data-i18n-args='{"count": "0"}'>Errors: 0</span> <span id="uBlockErrorCount"
              class="error"></span></p>
          <p id="uBlockErrorDetails" class="error-text text-sm"></p>
        </div>

        <!-- Export Buttons -->
        <div class="form-group">
          <button id="uBlockExportBtn" class="secondary-btn" data-i18n="export">Export</button>
          <button id="uBlockCopyBtn" class="secondary-btn" data-i18n="copyToClipboard">Copy to Clipboard</button>
        </div>
      </div>

      <button id="saveDomainSettings" data-i18n="saveDomainSettings">Save</button>
      <div id="domainStatus" aria-live="polite"></div>
    </div>

    <!-- Privacy Settings Panel -->
    <div id="privacyPanel" class="tab-panel" role="tabpanel" aria-labelledby="privacyTab" aria-hidden="true">

      <div class="form-group">
        <label data-i18n="privacyMode">Privacy Mode</label>
        <div class="radio-group" id="privacyModeGroup">

          <div>
            <input type="radio" id="modeA" name="privacyMode" value="local_only">
            <label for="modeA"><strong data-i18n="modeA">Mode A: Local Only</strong> <span
                data-i18n="modeADetail">(Under development)</span></label>
            <div class="help-text ml-24" data-i18n="modeADesc">
              Summarize page content using only local AI, without sending data externally.<br>
              Currently not supported on most browsers.
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeB" name="privacyMode" value="full_pipeline">
            <label for="modeB"><strong data-i18n="modeB">Mode B: Full Pipeline</strong> <span
                data-i18n="modeBCurrently">(Under development)</span></label>
            <div class="help-text ml-24" data-i18n="modeBDesc">
              Local AI summary ‚Üí PII masking ‚Üí Cloud AI refinement.<br>
              Currently not supported on most browsers.
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeC" name="privacyMode" value="masked_cloud">
            <label for="modeC"><strong data-i18n="modeC">Mode C: Masked Cloud</strong> <span
                data-i18n="modeCRecommended">(Recommended)</span></label>
            <div class="help-text ml-24" data-i18n="modeCDesc">
              Send only masked data to cloud AI.<br>
              For environments where local AI is not available.
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeD" name="privacyMode" value="cloud_only">
            <label for="modeD"><strong data-i18n="modeD">Mode D: Cloud Only</strong></label>
            <div class="help-text ml-24" data-i18n="modeDDesc">
              Send raw text directly to cloud AI.<br>
              Prioritize speed.
            </div>
          </div>

        </div>
      </div>

      <hr class="settings-hr">

      <div class="form-group">
        <label data-i18n="confirmSettings">Confirmation Settings</label>
        <div class="mb-8">
          <input type="checkbox" id="piiConfirm">
          <label for="piiConfirm" data-i18n="confirmBeforeSending">Confirm masking result before sending</label>
        </div>
      </div>

      <button id="savePrivacySettings" data-i18n="savePrivacySettings">Save</button>
      <div id="privacyStatus" aria-live="polite"></div>

    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="confirmContent">
    <div class="modal-content">
      <div class="modal-header">
        <h3 data-i18n="confirmContent">Review Content</h3>
        <button id="closeModalBtn" class="icon-btn modal-close" data-i18n-aria-label="closeModal">√ó</button>
      </div>
      <div class="modal-body">
        <p class="mt-0 text-xs text-gray" data-i18n="confirmContentDesc">
          You can review and edit the content to be saved to Obsidian.
        </p>
        <p class="mt-0 text-xs text-danger" data-i18n="confirmContentNote">
          Note: Check masked items.
        </p>
        <div id="maskNavAnchor"></div>
        <textarea id="previewContent" class="preview-textarea"></textarea>
      </div>
      <div class="modal-footer">
        <button id="cancelPreviewBtn" class="btn-cancel" data-i18n="cancelPreviewBtn">Cancel</button>
        <button id="confirmPreviewBtn" class="btn-confirm" data-i18n="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Import Confirmation Modal -->
  <div id="importConfirmModal" class="modal-overlay hidden" role="dialog" aria-modal="true"
    aria-labelledby="importConfirmTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="importConfirmTitle" data-i18n="confirmImport">Import Settings</h3>
        <button id="closeImportModalBtn" class="icon-btn modal-close" data-i18n-aria-label="closeModal">√ó</button>
      </div>
      <div class="modal-body">
        <p class="mt-0 text-xs text-gray" data-i18n="confirmImportDesc">
          Current settings will be overwritten. Continue?
        </p>
        <p class="mt-0 text-xs text-danger" data-i18n="confirmImportNote">
          Note: Please review the settings below before importing.
        </p>
        <div id="importPreview" class="import-preview" aria-live="polite"></div>
      </div>
      <div class="modal-footer">
        <button id="cancelImportBtn" class="btn-cancel" data-i18n="cancel">Cancel</button>
        <button id="confirmImportBtn" class="btn-confirm" data-i18n="confirm">Import</button>
      </div>
    </div>
  </div>

  <script type="module" src="i18n.js"></script>
  <script type="module" src="navigation.js"></script>
  <script type="module" src="main.js"></script>
  <script type="module" src="popup.js"></script>
  <script type="module" src="domainFilter.js"></script>
</body>

</html>