<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Obsidian Smart History Settings</title>
  <style>
    body {
      width: 320px;
      padding: 15px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    h2 {
      font-size: 18px;
      margin-top: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      background: #f5f5f5;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: #e0e0e0;
    }

    #currentPage {
      display: flex;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 15px;
    }

    #favicon {
      margin-right: 10px;
    }

    #pageTitle {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }

    #pageUrl {
      font-size: 12px;
      color: #666;
      word-break: break-all;
    }

    .primary-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .primary-btn:hover {
      background: #45a049;
    }

    .primary-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    #mainStatus {
      margin-top: 10px;
      font-size: 12px;
      min-height: 1.2em;
      color: #333;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      resize: vertical;
    }

    button:not(.icon-btn):not(.primary-btn) {
      width: 100%;
      padding: 10px;
      background: #7b3cad;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    button:not(.icon-btn):not(.primary-btn):hover {
      background: #602a8c;
    }

    #status {
      margin-top: 10px;
      font-size: 12px;
      min-height: 1.2em;
      color: #333;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ccc;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .tab-btn.active {
      border-bottom-color: #7b3cad;
      color: #7b3cad;
    }

    .tab-btn:hover {
      background: #f5f5f5;
    }

    .tab-panel {
      display: block;
    }

    .tab-panel:not(.active) {
      display: none;
    }

    /* Radio Group */
    .radio-group {
      margin-bottom: 10px;
    }

    .radio-group div {
      margin-bottom: 8px;
    }

    .radio-group input[type="radio"] {
      margin-right: 8px;
    }

    .radio-group label {
      display: inline;
      font-size: 13px;
    }

    /* Secondary Button */
    .secondary-btn {
      width: 100%;
      padding: 10px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }

    .secondary-btn:hover {
      background: #5a6268;
    }

    /* Help Text */
    .help-text {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .format-section {
      display: block;
    }

    .format-section[style*="display: none"] {
      display: none;
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
    }

    .drop-zone.active {
      border-color: #4CAF50;
      background-color: rgba(76, 175, 80, 0.1);
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .preview-section {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    .preview-section h4 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .error {
      color: red;
    }

    .error-text {
      color: #d9534f;
      max-height: 100px;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      width: 90%;
      max-height: 90%;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .modal-body {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
    }

    .preview-textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
    }

    .modal-footer {
      padding: 12px 15px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-cancel {
      padding: 8px 16px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-confirm {
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .masked-highlight {
      background-color: #fff3cd;
      color: #856404;
      padding: 0 2px;
      border-radius: 2px;
    }

    /* ğŸŸ¢ UF-403 ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner {
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    .spinner-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }

    .spinner-text {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>
  <!-- Main Screen -->
  <div id="mainScreen" style="display: block;">
    <div class="header">
      <h2>Smart History</h2>
      <button id="menuBtn" class="icon-btn">â˜°</button>
    </div>

    <div id="currentPage">
      <img id="favicon" src="" width="16" height="16" alt="">
      <div id="pageInfo">
        <div id="pageTitle">Loading...</div>
        <div id="pageUrl">...</div>
      </div>
    </div>

    <button id="recordBtn" class="primary-btn">ğŸ“ ä»Šã™ãè¨˜éŒ²</button>
    <div id="loadingSpinner" class="spinner-container" style="display: none;">
      <svg class="spinner" viewBox="0 0 50 50">
        <circle
          class="spinner-path"
          cx="25" cy="25" r="20"
          fill="none"
          stroke="#4CAF50"
          stroke-width="4"
          stroke-linecap="round"
        />
      </svg>
      <span class="spinner-text">å‡¦ç†ä¸­...</span>
    </div>
    <div id="mainStatus"></div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" style="display: none;">
    <div class="header">
      <button id="backBtn" class="icon-btn">â†</button>
      <h2>Settings</h2>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button id="generalTab" class="tab-btn">ä¸€èˆ¬</button>
      <button id="domainTab" class="tab-btn active">ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
      <button id="privacyTab" class="tab-btn">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</button>
    </div>

    <!-- General Settings Panel -->
    <div id="generalPanel" class="tab-panel" style="display: none;">

      <div class="form-group">
        <label>Obsidian API Key</label>
        <input type="password" id="apiKey" placeholder="Paste your key here...">
      </div>

      <div class="form-group">
        <label>Protocol (http/https)</label>
        <input type="text" id="protocol" value="https">
      </div>

      <div class="form-group">
        <label>Port</label>
        <input type="text" id="port" value="27123">
      </div>

      <div class="form-group">
        <label>Daily Note Path</label>
        <input type="text" id="dailyPath" placeholder="e.g. 092.Daily">
      </div>

      <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">

      <div class="form-group">
        <label>AI Provider</label>
        <select id="aiProvider">
          <option value="gemini">Google Gemini</option>
          <option value="openai">OpenAI Compatible (Groq, etc.)</option>
          <option value="openai2">OpenAI Compatible 2 (Local, etc.)</option>
        </select>
      </div>

      <!-- Gemini Settings -->
      <div id="geminiSettings">
        <div class="form-group">
          <label>Gemini API Key</label>
          <input type="password" id="geminiApiKey" placeholder="Paste your Gemini key here...">
        </div>

        <div class="form-group">
          <label>Model Name (e.g. gemini-1.5-flash)</label>
          <input type="text" id="geminiModel" value="gemini-1.5-flash">
        </div>
      </div>

      <!-- OpenAI Settings -->
      <div id="openaiSettings" style="display: none;">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" id="openaiBaseUrl" placeholder="https://api.openai.com/v1">
        </div>

        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="openaiApiKey" placeholder="sk-...">
        </div>

        <div class="form-group">
          <label>Model Name</label>
          <input type="text" id="openaiModel" placeholder="gpt-3.5-turbo">
        </div>
      </div>

      <!-- OpenAI 2 Settings -->
      <div id="openai2Settings" style="display: none;">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" id="openai2BaseUrl" placeholder="http://127.0.0.1:11434/v1">
        </div>

        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="openai2ApiKey" placeholder="Optional for some local LLMs">
        </div>

        <div class="form-group">
          <label>Model Name</label>
          <input type="text" id="openai2Model" placeholder="llama3">
        </div>
      </div>

      <div class="form-group">
        <label>Min Visit Duration (seconds)</label>
        <input type="number" id="minVisitDuration" min="1" value="5">
      </div>

      <div class="form-group">
        <label>Min Scroll Depth (%)</label>
        <input type="number" id="minScrollDepth" min="0" max="100" value="50">
      </div>

      <button id="save">Save & Test Connection</button>
      <div id="status"></div>
    </div>

    <!-- Domain Filter Panel -->
    <div id="domainPanel" class="tab-panel active">
      <div class="form-group">
        <label>ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰</label>
        <div class="radio-group">
          <div>
            <input type="radio" id="filterDisabled" name="domainFilter" value="disabled">
            <label for="filterDisabled">ç„¡åŠ¹ (ã™ã¹ã¦è¨˜éŒ²)</label>
          </div>
          <div>
            <input type="radio" id="filterWhitelist" name="domainFilter" value="whitelist">
            <label for="filterWhitelist">ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ (æŒ‡å®šãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿è¨˜éŒ²)</label>
          </div>
          <div>
            <input type="radio" id="filterBlacklist" name="domainFilter" value="blacklist">
            <label for="filterBlacklist">ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ (æŒ‡å®šãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é™¤å¤–)</label>
          </div>
        </div>
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å½¢å¼é¸æŠ -->
      <div class="form-group">
        <label>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å½¢å¼</label>
        <select id="filterFormat">
          <option value="simple">ã‚·ãƒ³ãƒ—ãƒ« (1è¡Œ1ãƒ‰ãƒ¡ã‚¤ãƒ³)</option>
          <option value="ublock">uBlock Origin å½¢å¼</option>
        </select>
      </div>

      <!-- simpleå½¢å¼ç”¨UIï¼ˆæ—¢å­˜ï¼‰ -->
      <div id="simpleFormatUI" class="format-section">
        <div id="domainListSection">
          <div class="form-group">
            <label id="domainListLabel">ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆ (1è¡Œã«1ãƒ‰ãƒ¡ã‚¤ãƒ³)</label>
            <textarea id="domainList" rows="8" placeholder="example.com&#10;*.example.org&#10;company.net"></textarea>
            <div class="help-text">
              ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚‚ä½¿ç”¨ã§ãã¾ã™ (ä¾‹: *.example.com)
            </div>
          </div>

          <div class="form-group">
            <button id="addCurrentDomain" class="secondary-btn">ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ </button>
          </div>
        </div>
      </div>

      <!-- uBlockå½¢å¼ç”¨UIï¼ˆæ–°è¦ï¼‰ -->
      <div id="uBlockFormatUI" class="format-section" style="display: none;">
        <div class="form-group">
          <label>uBlockãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
          <textarea id="uBlockFilterInput" rows="8"
            placeholder="||example.com^&#10;@@||trusted.com^&#10;||*.ads.net^$3p&#10;! Comment line"></textarea>
          <div class="help-text">
            uBlock Originå½¢å¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘<br>
            ã‚µãƒãƒ¼ãƒˆ: ||hostname^, @@||hostname^, *, !Comments, $domain=, $3p, $1p
          </div>
        </div>

        <div class="form-group">
          <label>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ (.txt)</label>
          <input type="file" id="uBlockFileInput" accept=".txt" style="display: none;">
          <button id="uBlockFileSelectBtn" class="secondary-btn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        </div>

        <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        <div id="uBlockDropZone" class="drop-zone" style="display: none;">
          <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>

        <!-- URLã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div class="form-group">
          <label>URLã‹ã‚‰èª­ã¿è¾¼ã¿</label>
          <input type="url" id="uBlockUrlInput" placeholder="https://example.com/filters.txt">
          <button id="uBlockUrlImportBtn" class="secondary-btn">URLã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="uBlockPreview" class="preview-section" style="display: none;">
          <h4>èª­ã¿è¾¼ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
          <p>ãƒ«ãƒ¼ãƒ«æ•°: <span id="uBlockRuleCount">0</span></p>
          <p>ä¾‹å¤–æ•°: <span id="uBlockExceptionCount">0</span></p>
          <p>ã‚¨ãƒ©ãƒ¼: <span id="uBlockErrorCount" class="error">0</span></p>
          <p id="uBlockErrorDetails" class="error-text" style="font-size: 11px;"></p>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
        <div class="form-group">
          <button id="uBlockExportBtn" class="secondary-btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="uBlockCopyBtn" class="secondary-btn">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <button id="saveDomainSettings">ä¿å­˜</button>
      <div id="domainStatus"></div>
    </div>

    <!-- Privacy Settings Panel -->
    <div id="privacyPanel" class="tab-panel">

      <div class="form-group">
        <label>å‹•ä½œãƒ¢ãƒ¼ãƒ‰</label>
        <div class="radio-group" id="privacyModeGroup">

          <div>
            <input type="radio" id="modeA" name="privacyMode" value="local_only">
            <label for="modeA"><strong>Mode A: Local Only</strong> (é–‹ç™ºä¸­)</label>
            <div class="help-text" style="margin-left: 24px;">
              ãƒšãƒ¼ã‚¸å†…å®¹ã‚’å¤–éƒ¨é€ä¿¡ã›ãšã€ãƒ­ãƒ¼ã‚«ãƒ«AIã®ã¿ã§è¦ç´„ã—ã¾ã™ã€‚<br>
              â€»ç¾åœ¨ã€å¤šãã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã›ã‚“ã€‚
            </div>
          </div>

          <div style="margin-top: 10px;">
            <input type="radio" id="modeB" name="privacyMode" value="full_pipeline">
            <label for="modeB"><strong>Mode B: Full Pipeline</strong> (é–‹ç™ºä¸­)</label>
            <div class="help-text" style="margin-left: 24px;">
              ãƒ­ãƒ¼ã‚«ãƒ«AIã§è¦ç´„â†’PIIãƒã‚¹ã‚­ãƒ³ã‚°â†’ã‚¯ãƒ©ã‚¦ãƒ‰AIã§ä»•ä¸Šã’ã€‚<br>
              â€»ç¾åœ¨ã€å¤šãã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã›ã‚“ã€‚
            </div>
          </div>

          <div style="margin-top: 10px;">
            <input type="radio" id="modeC" name="privacyMode" value="masked_cloud">
            <label for="modeC"><strong>Mode C: Masked Cloud</strong> (æ¨å¥¨)</label>
            <div class="help-text" style="margin-left: 24px;">
              PIIã®ã¿ãƒã‚¹ã‚¯ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰AIã¸é€ä¿¡ã€‚<br>
              ãƒ­ãƒ¼ã‚«ãƒ«AIãŒä½¿ãˆãªã„ç’°å¢ƒå‘ã‘ã€‚
            </div>
          </div>

          <div style="margin-top: 10px;">
            <input type="radio" id="modeD" name="privacyMode" value="cloud_only">
            <label for="modeD"><strong>Mode D: Cloud Only</strong></label>
            <div class="help-text" style="margin-left: 24px;">
              ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ã‚¯ãƒ©ã‚¦ãƒ‰AIã¸é€ä¿¡ã€‚<br>
              é€Ÿåº¦å„ªå…ˆã€‚
            </div>
          </div>

        </div>
      </div>

      <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">

      <div class="form-group">
        <label>ç¢ºèªè¨­å®š</label>
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="piiConfirm">
          <label for="piiConfirm">é€ä¿¡å‰ã«ãƒã‚¹ã‚­ãƒ³ã‚°çµæœã‚’ç¢ºèªã™ã‚‹</label>
        </div>
      </div>

      <button id="savePrivacySettings">ä¿å­˜</button>
      <div id="privacyStatus"></div>

    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å†…å®¹ã®ç¢ºèª</h3>
        <button id="closeModalBtn" class="icon-btn" style="width:24px;height:24px;">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0;font-size:12px;color:#666;">
          Obsidianã«ä¿å­˜ã™ã‚‹å†…å®¹ã‚’ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™ã€‚<br>
          <span style="color:#d9534f;">â€» ãƒã‚¹ã‚­ãƒ³ã‚°ã•ã‚ŒãŸç®‡æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>
        </p>
        <textarea id="previewContent" class="preview-textarea"></textarea>
      </div>
      <div class="modal-footer">
        <button id="cancelPreviewBtn" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirmPreviewBtn" class="btn-confirm">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script type="module" src="navigation.js"></script>
  <script type="module" src="main.js"></script>
  <script type="module" src="popup.js"></script>
  <script type="module" src="domainFilter.js"></script>
</body>

</html>