<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Obsidian Smart History Settings</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- Main Screen -->
  <div id="mainScreen">
    <div class="header">
      <h2>Smart History</h2>
      <button id="menuBtn" class="icon-btn">☰</button>
    </div>

    <div id="currentPage">
      <img id="favicon" src="" width="16" height="16" alt="">
      <div id="pageInfo">
        <div id="pageTitle">Loading...</div>
        <div id="pageUrl">...</div>
      </div>
    </div>

    <button id="recordBtn" class="primary-btn">📝 今すぐ記録</button>
    <div id="loadingSpinner" class="spinner-container">
      <svg class="spinner" viewBox="0 0 50 50">
        <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke="#4CAF50" stroke-width="4"
          stroke-linecap="round" />
      </svg>
      <span class="spinner-text">処理中...</span>
    </div>
    <div id="mainStatus"></div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen">
    <div class="header">
      <button id="backBtn" class="icon-btn">←</button>
      <h2>Settings</h2>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button id="generalTab" class="tab-btn">一般</button>
      <button id="domainTab" class="tab-btn active">ドメインフィルター</button>
      <button id="privacyTab" class="tab-btn">プライバシー</button>
    </div>

    <!-- General Settings Panel -->
    <div id="generalPanel" class="tab-panel">

      <div class="form-group">
        <label>Obsidian API Key</label>
        <input type="password" id="apiKey" placeholder="Paste your key here...">
      </div>

      <div class="form-group">
        <label>Protocol (http/https)</label>
        <input type="text" id="protocol" value="https">
      </div>

      <div class="form-group">
        <label>Port</label>
        <input type="text" id="port" value="27123">
      </div>

      <div class="form-group">
        <label>Daily Note Path</label>
        <input type="text" id="dailyPath" placeholder="e.g. 092.Daily">
      </div>

      <hr class="settings-hr">

      <div class="form-group">
        <label>AI Provider</label>
        <select id="aiProvider">
          <option value="gemini">Google Gemini</option>
          <option value="openai">OpenAI Compatible (Groq, etc.)</option>
          <option value="openai2">OpenAI Compatible 2 (Local, etc.)</option>
        </select>
      </div>

      <!-- Gemini Settings -->
      <div id="geminiSettings">
        <div class="form-group">
          <label>Gemini API Key</label>
          <input type="password" id="geminiApiKey" placeholder="Paste your Gemini key here...">
        </div>

        <div class="form-group">
          <label>Model Name (e.g. gemini-1.5-flash)</label>
          <input type="text" id="geminiModel" value="gemini-1.5-flash">
        </div>
      </div>

      <!-- OpenAI Settings -->
      <div id="openaiSettings" class="openai-settings">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" id="openaiBaseUrl" placeholder="https://api.openai.com/v1">
        </div>

        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="openaiApiKey" placeholder="sk-...">
        </div>

        <div class="form-group">
          <label>Model Name</label>
          <input type="text" id="openaiModel" placeholder="gpt-3.5-turbo">
        </div>
      </div>

      <!-- OpenAI 2 Settings -->
      <div id="openai2Settings" class="openai-settings">
        <div class="form-group">
          <label>Base URL</label>
          <input type="text" id="openai2BaseUrl" placeholder="http://127.0.0.1:11434/v1">
        </div>

        <div class="form-group">
          <label>API Key</label>
          <input type="password" id="openai2ApiKey" placeholder="Optional for some local LLMs">
        </div>

        <div class="form-group">
          <label>Model Name</label>
          <input type="text" id="openai2Model" placeholder="llama3">
        </div>
      </div>

      <div class="form-group">
        <label>Min Visit Duration (seconds)</label>
        <input type="number" id="minVisitDuration" min="1" value="5">
      </div>

      <div class="form-group">
        <label>Min Scroll Depth (%)</label>
        <input type="number" id="minScrollDepth" min="0" max="100" value="50">
      </div>

      <button id="save">Save & Test Connection</button>
      <div id="status"></div>
    </div>

    <!-- Domain Filter Panel -->
    <div id="domainPanel" class="tab-panel active">
      <div class="form-group">
        <label>ドメインフィルターモード</label>
        <div class="radio-group">
          <div>
            <input type="radio" id="filterDisabled" name="domainFilter" value="disabled">
            <label for="filterDisabled">無効 (すべて記録)</label>
          </div>
          <div>
            <input type="radio" id="filterWhitelist" name="domainFilter" value="whitelist">
            <label for="filterWhitelist">ホワイトリスト (指定ドメインのみ記録)</label>
          </div>
          <div>
            <input type="radio" id="filterBlacklist" name="domainFilter" value="blacklist">
            <label for="filterBlacklist">ブラックリスト (指定ドメインを除外)</label>
          </div>
        </div>
      </div>

      <!-- フィルター形式選択 -->
      <div class="form-group">
        <label>フィルター形式 (併用可能)</label>
        <div>
          <input type="checkbox" id="simpleFormatEnabled" checked>
          <label for="simpleFormatEnabled" class="inline-label">シンプル (1行1ドメイン)</label>
        </div>
        <div class="mt-5">
          <input type="checkbox" id="ublockFormatEnabled">
          <label for="ublockFormatEnabled" class="inline-label">uBlock Origin 形式</label>
        </div>
      </div>

      <!-- simple形式用UI（既存） -->
      <div id="simpleFormatUI" class="format-section">
        <div id="domainListSection">
          <div class="form-group">
            <label id="domainListLabel">ドメインリスト (1行に1ドメイン)</label>
            <textarea id="domainList" rows="8" placeholder="example.com&#10;*.example.org&#10;company.net"></textarea>
            <div class="help-text">
              ワイルドカードも使用できます (例: *.example.com)
            </div>
          </div>

          <div class="form-group">
            <button id="addCurrentDomain" class="secondary-btn">現在のページドメインを追加</button>
          </div>
        </div>
      </div>

      <!-- uBlock形式用UI（新規） -->
      <div id="uBlockFormatUI" class="format-section">
        <div class="form-group">
          <label>uBlockフィルター</label>
          <textarea id="uBlockFilterInput" rows="8"
            placeholder="||example.com^&#10;@@||trusted.com^&#10;0.0.0.0 ads.example.com&#10;! Comment line"></textarea>
          <div class="help-text">
            uBlock Origin形式 または hosts形式のフィルターを貼り付け<br>
            uBlock: ||hostname^, @@||hostname^, *, !Comments<br>
            hosts: 0.0.0.0/127.0.0.1 hostname (#コメント対応)
          </div>
        </div>

        <div class="form-group">
          <label>ファイルから読み込み (.txt)</label>
          <input type="file" id="uBlockFileInput" accept=".txt">
          <button id="uBlockFileSelectBtn" class="secondary-btn">ファイルを選択</button>
        </div>

        <!-- ドラッグ&ドロップエリア -->
        <div id="uBlockDropZone" class="drop-zone">
          <p>ファイルをここにドロップ</p>
        </div>

        <!-- URLインポート -->
        <div class="form-group">
          <label>URLから読み込み</label>
          <input type="url" id="uBlockUrlInput" placeholder="https://example.com/filters.txt">
          <button id="uBlockUrlImportBtn" class="secondary-btn">URLからインポート</button>
        </div>

        <!-- 現在のソース一覧 -->
        <div id="uBlockSourceList" class="source-list">
          <h4>登録済みフィルターソース</h4>
          <div id="uBlockSourceItems"></div>
          <p id="uBlockNoSources" class="no-sources">ソースが登録されていません</p>
        </div>

        <!-- プレビューセクション -->
        <div id="uBlockPreview" class="preview-section">
          <h4>読み込みプレビュー</h4>
          <p>ルール数: <span id="uBlockRuleCount">0</span></p>
          <p>例外数: <span id="uBlockExceptionCount">0</span></p>
          <p>エラー: <span id="uBlockErrorCount" class="error">0</span></p>
          <p id="uBlockErrorDetails" class="error-text text-sm"></p>
        </div>

        <!-- エクスポートボタン -->
        <div class="form-group">
          <button id="uBlockExportBtn" class="secondary-btn">エクスポート</button>
          <button id="uBlockCopyBtn" class="secondary-btn">クリップボードにコピー</button>
        </div>
      </div>

      <button id="saveDomainSettings">保存</button>
      <div id="domainStatus"></div>
    </div>

    <!-- Privacy Settings Panel -->
    <div id="privacyPanel" class="tab-panel">

      <div class="form-group">
        <label>動作モード</label>
        <div class="radio-group" id="privacyModeGroup">

          <div>
            <input type="radio" id="modeA" name="privacyMode" value="local_only">
            <label for="modeA"><strong>Mode A: Local Only</strong> (開発中)</label>
            <div class="help-text ml-24">
              ページ内容を外部送信せず、ローカルAIのみで要約します。<br>
              ※現在、多くのブラウザで動作しません。
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeB" name="privacyMode" value="full_pipeline">
            <label for="modeB"><strong>Mode B: Full Pipeline</strong> (開発中)</label>
            <div class="help-text ml-24">
              ローカルAIで要約→PIIマスキング→クラウドAIで仕上げ。<br>
              ※現在、多くのブラウザで動作しません。
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeC" name="privacyMode" value="masked_cloud">
            <label for="modeC"><strong>Mode C: Masked Cloud</strong> (推奨)</label>
            <div class="help-text ml-24">
              PIIのみマスクしてクラウドAIへ送信。<br>
              ローカルAIが使えない環境向け。
            </div>
          </div>

          <div class="mt-10">
            <input type="radio" id="modeD" name="privacyMode" value="cloud_only">
            <label for="modeD"><strong>Mode D: Cloud Only</strong></label>
            <div class="help-text ml-24">
              生のテキストをそのままクラウドAIへ送信。<br>
              速度優先。
            </div>
          </div>

        </div>
      </div>

      <hr class="settings-hr">

      <div class="form-group">
        <label>確認設定</label>
        <div class="mb-8">
          <input type="checkbox" id="piiConfirm">
          <label for="piiConfirm">送信前にマスキング結果を確認する</label>
        </div>
      </div>

      <button id="savePrivacySettings">保存</button>
      <div id="privacyStatus"></div>

    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>内容の確認</h3>
        <button id="closeModalBtn" class="icon-btn modal-close">×</button>
      </div>
      <div class="modal-body">
        <p class="mt-0 text-xs text-gray">
          Obsidianに保存する内容を確認・編集できます。<br>
          <span class="text-danger">※ マスキングされた箇所を確認してください。</span>
        </p>
        <div id="maskNavAnchor"></div>
        <textarea id="previewContent" class="preview-textarea"></textarea>
      </div>
      <div class="modal-footer">
        <button id="cancelPreviewBtn" class="btn-cancel">キャンセル</button>
        <button id="confirmPreviewBtn" class="btn-confirm">送信する</button>
      </div>
    </div>
  </div>

  <script type="module" src="navigation.js"></script>
  <script type="module" src="main.js"></script>
  <script type="module" src="popup.js"></script>
  <script type="module" src="domainFilter.js"></script>
</body>

</html>