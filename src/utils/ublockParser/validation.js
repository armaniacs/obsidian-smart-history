/**
 * ublockParser/validation.js
 * uBlock Originå½¢å¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: å…¥åŠ›å€¤æ¤œè¨¼ã¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’æä¾›
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: åŸºæœ¬çš„ãªå‹å®‰å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŠã‚ˆã³ plan/UII/10-data-structures.md ã«è¨˜è¼‰ã•ã‚Œã‚‹åˆ¶ç´„
 */

import { PATTERNS } from './constants.js';

// ============================================================================
// å…¥åŠ›å€¤æ¤œè¨¼
// ============================================================================

/**
 * ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: æ–‡å­—åˆ—å‹ã®å…¥åŠ›å€¤ã‚’æ¤œè¨¼
 * ã€å†åˆ©ç”¨æ€§ã€‘: ã™ã¹ã¦ã®publicé–¢æ•°ã§ä½¿ç”¨ã™ã‚‹å…±é€šã®å…¥åŠ›æ¤œè¨¼
 * ã€å˜ä¸€è²¬ä»»ã€‘: æ–‡å­—åˆ—å‹å¦¥å½“æ€§ã®ç¢ºèª
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: åŸºæœ¬çš„ãªå‹å®‰å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³
 * @param {unknown} value - æ¤œè¨¼å¯¾è±¡ã®å€¤
 * @returns {boolean} - æœ‰åŠ¹ãªæ–‡å­—åˆ—ãªã‚‰true
 */
export function isValidString(value) {
  return value != null && typeof value === 'string' && value.length > 0;
}

// ============================================================================
// ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
// ============================================================================

/**
 * ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ç©ºãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ã¨å½¢å¼ãƒã‚§ãƒƒã‚¯ã‚’åˆ†é›¢ã—ã¦æ˜ç¢ºåŒ–
 * ã€å‡¦ç†åŠ¹ç‡åŒ–ã€‘: çŸ­çµ¡è©•ä¾¡ã§ä¸è¦ãªãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
 * ã€å¯èª­æ€§å‘ä¸Šã€‘: å„æ¤œè¨¼ãŒç‹¬ç«‹ã—ãŸifæ–‡ã§æ˜ç¢º
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: plan/UII/10-data-structures.md ã«è¨˜è¼‰ã•ã‚Œã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶ç´„
 * @param {string} domain - æ¤œè¨¼å¯¾è±¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³
 * @returns {boolean} - æœ‰åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãªã‚‰true
 */
export function validateDomain(domain) {
  // ã€ç©ºãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒç©ºã®å ´åˆã¯ç„¡åŠ¹
  if (!domain) {
    return false;
  }

  // ã€é€£ç¶šãƒ‰ãƒƒãƒˆæ¤œè¨¼ã€‘: é€£ç¶šã™ã‚‹ãƒ‰ãƒƒãƒˆã‚’å«ã‚€ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ç„¡åŠ¹
  if (domain.includes('..')) {
    return false;
  }

  // ã€ä¸æ­£æ–‡å­—æ¤œè¨¼ã€‘: ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦ä¸é©åˆ‡ãªæ–‡å­—ã‚’å«ã‚€å ´åˆã¯ç„¡åŠ¹
  // ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: æ­£è¦è¡¨ç¾ã«ã‚ˆã‚‹XSSãƒªã‚¹ã‚¯ä½æ¸› ğŸŸ¢
  return PATTERNS.DOMAIN_VALIDATION.test(domain);
}

// ============================================================================
// è¡Œã‚¿ã‚¤ãƒ—æ¤œè¨¼
// ============================================================================

/**
 * æŒ‡å®šã•ã‚ŒãŸè¡ŒãŒuBlockå½¢å¼ã®ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‹åˆ¤å®š
 *
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹åˆ¤å®šã§ç¢ºå®Ÿæ€§ã‚’ç¢ºä¿
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: æ­£è¦è¡¨ç¾ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹é«˜é€Ÿåˆ¤å®š
 * ã€ä¿å®ˆæ€§ã€‘: isValidStringã®å¤‰æ›´ãŒã‚ã‚Œã°ä¸€ç®‡æ‰€ã§é©ç”¨
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: plan/UII/00-overview.md ã«è¨˜è¼‰ã•ã‚Œã‚‹åŸºæœ¬æ§‹æ–‡
 * @param {string} line - åˆ¤å®šå¯¾è±¡ã®è¡Œ
 * @returns {boolean} - ã‚³ãƒ¡ãƒ³ãƒˆè¡Œãªã‚‰true
 */
export function isCommentLine(line) {
  // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefinedã®å ´åˆã¯falseã‚’è¿”ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã ğŸŸ¢
  if (!isValidString(line)) {
    return false;
  }
  // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã€‘: `!` ã§å§‹ã¾ã‚‹è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨åˆ¤å®š
  return PATTERNS.COMMENT_PREFIX.test(line);
}

/**
 * æŒ‡å®šã•ã‚ŒãŸè¡ŒãŒç©ºè¡Œã‹åˆ¤å®š
 *
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: trimå¾Œã®ç©ºç™½è¡Œãƒã‚§ãƒƒã‚¯ã§æŸ”è»Ÿãªåˆ¤å®š
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: trimã¨ç©ºæ–‡å­—åˆ—æ¯”è¼ƒã¯æœ€åŠ¹ç‡çš„
 * ã€ä¿å®ˆæ€§]: isValidStringã®å¤‰æ›´ãŒã‚ã‚Œã°ä¸€ç®‡æ‰€ã§é©ç”¨
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: åŸºæœ¬çš„ãªæ–‡å­—åˆ—åˆ¤å®šæ©Ÿèƒ½
 * @param {string} line - åˆ¤å®šå¯¾è±¡ã®è¡Œ
 * @returns {boolean} - ç©ºè¡Œãªã‚‰true
 */
export function isEmptyLine(line) {
  // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefined/ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯trueã‚’è¿”ã—ã¦å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ— ğŸŸ¢
  if (!isValidString(line)) {
    return true;
  }
  // ã€ç©ºç™½åˆ¤å®šã€‘: trimã—ãŸå¾Œã«ç©ºæ–‡å­—åˆ—ã«ãªã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  return line.trim() === '';
}

/**
 * æŒ‡å®šã•ã‚ŒãŸè¡ŒãŒæœ‰åŠ¹ãªuBlockãƒ«ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹åˆ¤å®š
 *
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: `||` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ `^` ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
 * ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€‘: æ­£è¦è¡¨ç¾ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹é«˜é€Ÿåˆ¤å®š
 * ã€ä¿å®ˆæ€§ã€‘: isValidStringã®å¤‰æ›´ãŒã‚ã‚Œã°ä¸€ç®‡æ‰€ã§é©ç”¨
 * ğŸŸ¢ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: plan/UII/00-overview.md ã«è¨˜è¼‰ã•ã‚Œã‚‹åŸºæœ¬æ§‹æ–‡
 * @param {string} line - åˆ¤å®šå¯¾è±¡ã®è¡Œ
 * @returns {boolean} - æœ‰åŠ¹ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãªã‚‰true
 */
export function isValidRulePattern(line) {
  // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: null/undefinedã®å ´åˆã¯invalid ğŸŸ¢
  if (!isValidString(line)) {
    return false;
  }
  // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼ã€‘: `||` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ `^` ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ä¸¡æ–¹ã‚’æ¤œå‡º
  const hasPrefix = PATTERNS.RULE_PREFIX.test(line);
  const hasSuffix = PATTERNS.RULE_SUFFIX.test(line);

  // ã€ç©ºãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼ã€‘: `||^` ã®ã‚ˆã†ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒç©ºã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç„¡åŠ¹
  // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®é–“ã«å°‘ãªãã¨ã‚‚1æ–‡å­—å¿…è¦
  if (hasPrefix && hasSuffix && line.length > 3) {
    return true;
  }

  return false;
}